# ç”¨ HarperDB å’Œ FastifyJS æ„å»º REST API

> åŸæ–‡ï¼š<https://betterprogramming.pub/build-a-rest-api-with-harperdb-and-fastifyjs-ee3d8d5d6ea0>

## äº†è§£å¦‚ä½•ç»“åˆä½¿ç”¨è¿™ä¸¤ç§æŠ€æœ¯æ¥æ„å»º REST API

![](img/1c28163ed1231d51358206f95024f1d0.png)

ç…§ç‰‡ç”±[å†…ç‰¹Â·æ ¼å…°ç‰¹](https://unsplash.com/@nateggrant?utm_source=medium&utm_medium=referral)åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šæ‹æ‘„

æœ¬æ–‡å°†æ•™ä½ å¦‚ä½•ä½¿ç”¨ Node.jsã€ [Fastify](https://www.fastify.io/) å’Œ [HarperDB](https://harperdb.io/) æ„å»ºè¯¾ç¨‹ç®¡ç†ç³»ç»Ÿã€‚è¿™ä¸ªåº”ç”¨ç¨‹åºå°†å¸®åŠ©æ‚¨è·Ÿè¸ªæ‚¨æ­£åœ¨è¿›è¡Œçš„è¯¾ç¨‹å’Œæ‚¨è®¡åˆ’è¿›è¡Œçš„è¯¾ç¨‹ã€‚

æ‚¨å°†ä½¿ç”¨ä»¥ä¸‹æŠ€æœ¯:

*   èŠ‚ç‚¹. js
*   HarperDB
*   Fastify

# ä»‹ç»

è¯´åˆ° Node.js å’Œ Fastifyï¼Œäººä»¬å¯¹è¿™äº›æŠ€æœ¯éƒ½å¾ˆç†Ÿæ‚‰ã€‚ç„¶è€Œï¼Œå½“è°ˆåˆ°æ•°æ®åº“ï¼Œæœ‰ä¸€ä¸ªæ–°çš„å­©å­ã€‚

![](img/f827e51f31d5f1db665663091e3d4cd5.png)

æœ€è¿‘ï¼Œæˆ‘ä»æˆ‘é€šå¸¸ç”¨æ¥ç© HarperDB çš„æ•°æ®åº“ä¸­ä¼‘æ¯äº†ä¸€ä¸‹ã€‚HarperDB æ˜¯ä¸€ä¸ªå…·æœ‰ NoSQL å’Œ SQL åŠŸèƒ½çš„åˆ†å¸ƒå¼æ•°æ®åº“ã€‚HarperDB æœ€å¸å¼•äººçš„åœ°æ–¹åœ¨äºï¼Œæ‚¨åªä½¿ç”¨ä¸€ä¸ªç«¯ç‚¹æ¥æ‰§è¡Œæ‰€æœ‰çš„ CRUD æ•°æ®åº“æ“ä½œã€‚

HarperDB æœ€æ˜¾è‘—çš„ç‰¹æ€§æ˜¯:

*   ä½¿ç”¨å•ä¸ªç«¯ç‚¹
*   å¯¹ JSON æ•°æ®æ‰§è¡Œ SQL æŸ¥è¯¢
*   é€šè¿‡ä»¥ JSON æ•°ç»„çš„å½¢å¼è¿”å›ç»“æœï¼Œä¸å†éœ€è¦ ORM
*   èƒ½å¤Ÿé€šè¿‡ JSONã€CSV æˆ–ä½¿ç”¨ SQL æ’å…¥æ•°æ®

é‚£çœ‹èµ·æ¥ä¸æœ‰è¶£å—ï¼Ÿ

# å…ˆå†³æ¡ä»¶

åœ¨ç»§ç»­ä¹‹å‰ï¼Œæ‚¨åº”è¯¥äº†è§£ä¸€äº›å…ˆå†³æ¡ä»¶ã€‚æœ¬æ•™ç¨‹å‡è®¾æ‚¨å…·å¤‡ä»¥ä¸‹åŸºæœ¬çŸ¥è¯†:

*   Node.js å’Œ FastifyJS
*   æ•°æ®åº“
*   Java Script è¯­è¨€
*   çŸ¥é“å¦‚ä½•ä½¿ç”¨åƒ npm è¿™æ ·çš„åŒ…ç®¡ç†å™¨

æ­¤å¤–ï¼Œæ‚¨åº”è¯¥æ‹¥æœ‰ 12.xx æˆ–æ›´é«˜ç‰ˆæœ¬çš„èŠ‚ç‚¹ï¼ŒHarperDB æ‰èƒ½è¿è¡Œã€‚æœ€åï¼Œæ‚¨éœ€è¦æœ‰ä¸€ä¸ª HarperDB å¸æˆ·ï¼Œæ‚¨å¯ä»¥åœ¨è¿™é‡Œåˆ›å»ºã€‚ä¸ç”¨æ‹…å¿ƒï¼›å…è´¹çš„ï¼

# è®¾ç½®æ–‡ä»¶å¤¹ç»“æ„

æœ¬æ•™ç¨‹çš„ç¬¬ä¸€æ­¥æ˜¯è®¾ç½®åº”ç”¨ç¨‹åºçš„æ–‡ä»¶å¤¹ç»“æ„ã€‚åˆ›å»ºä¸€ä¸ªåä¸º`course-management`çš„æ–°æ–‡ä»¶å¤¹å¹¶æ‰“å¼€å®ƒã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥å®Œæˆæ­¤æ“ä½œ:

```
mkdir course-management
cd course-management
```

åŸºæœ¬çš„æ–‡ä»¶å¤¹ç»“æ„å·²ç»å‡†å¤‡å¥½ã€‚å½“ç„¶ï¼Œå½“æ‚¨æ„å»ºåº”ç”¨ç¨‹åºçš„æ¯ä¸ªéƒ¨åˆ†æ—¶ï¼Œæ‚¨ä¼šåˆ›å»ºæ›´å¤šçš„æ–‡ä»¶å¤¹ã€‚

# å®‰è£…ä¾èµ–é¡¹

æ­¤æ—¶ï¼Œæ‚¨åº”è¯¥åœ¨`course-management`æ–‡ä»¶å¤¹ä¸­ã€‚è®©æˆ‘ä»¬ç”¨ä¸‹é¢çš„å‘½ä»¤åˆå§‹åŒ–è¿™ä¸ªé¡¹ç›®:

```
npm init -y
```

`-y`æ ‡å¿—ä¼šè‡ªåŠ¨ç”Ÿæˆ`package.json`ï¼Œè€Œæ— éœ€æ‚¨å›ç­”å…³äºé¡¹ç›®åç§°ã€æè¿°ç­‰å¸¸è§é—®é¢˜ã€‚å¦‚æœä½ æ‰“å¼€`package.json`ï¼Œä½ å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„å­—æ®µéƒ½æ˜¯è‡ªåŠ¨å®Œæˆçš„ã€‚

## å®‰è£…æ‰€éœ€çš„è½¯ä»¶åŒ…

ä¸‹ä¸€æ­¥æ˜¯å®‰è£…æ„å»ºåº”ç”¨ç¨‹åºæ‰€éœ€çš„åŒ…ã€‚æ‚¨å¯ä»¥åœ¨ä¸€è¡Œä¸­å®‰è£…å¤šä¸ªè½¯ä»¶åŒ…ã€‚åœ¨æ‚¨çš„ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤:

```
npm i fastify harperive dotenv --save
```

è¯¥å‘½ä»¤å®‰è£…ä¸‰ä¸ªè½¯ä»¶åŒ…/ä¾èµ–é¡¹:

*   Fastify æ˜¯ä¸€ä¸ªæ–°çš„ web æ¡†æ¶ï¼Œå®ƒå£°ç§°æ˜¯é•‡ä¸Šæœ€å¿«çš„ web æ¡†æ¶ã€‚
*   [**Harper rive**](https://www.npmjs.com/package/harperive)â€”Harper db çš„ Node.js é©±åŠ¨ã€‚
*   [**Dotenv**](https://www.npmjs.com/package/dotenv) â€”è¿™æ˜¯ä¸€ä¸ªä»`.env`æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡åˆ°`process.env`çš„æ¨¡å—ã€‚

# é…ç½® Fastify æœåŠ¡å™¨

åœ¨ç»§ç»­é…ç½®æœåŠ¡å™¨ä¹‹å‰ï¼Œæ‚¨éœ€è¦åˆ›å»ºå‡ ä¸ªæ–‡ä»¶ã€‚ç¬¬ä¸€æ­¥æ˜¯åˆ›å»ºä»¥ä¸‹æ–‡ä»¶:

```
touch app.js
touch .env
```

`app.js`æ–‡ä»¶åŒ…å«æœåŠ¡å™¨é…ç½®ã€‚å¦ä¸€æ–¹é¢ï¼Œ`.env`æ–‡ä»¶å­˜å‚¨äº†æ‚¨çš„ç¯å¢ƒå˜é‡ã€‚

æ‰“å¼€`app.js`æ–‡ä»¶ï¼Œç¼–å†™ä»¥ä¸‹ä»£ç :

```
const app = require('fastify')({
    logger: true
});

require('dotenv').config()

app.get('/', (req, res) => {
    res.send({ hello: 'world' });
});

app.listen(process.env.PORT, (err, addr) => {
    if (err) {
        app.log.error(err);
        process.exit(1);
    }

    app.log.info(`Your server is listening on port ${process.env.PORT} ğŸ§¨`);
});
```

åœ¨ç¬¬ä¸€è¡Œä¸­ï¼Œæ‚¨å¯¼å…¥ Fastify åŒ…å¹¶å°†å…¶å­˜å‚¨åœ¨ä¸€ä¸ªåä¸º`app`çš„å¸¸é‡ä¸­ã€‚åœ¨åŒä¸€è¡Œä¸­ï¼Œæ‚¨è¿˜å¯ç”¨äº†`logger`ã€‚ä¹‹åï¼Œå¯¼å…¥ Dotenvï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨ç¯å¢ƒå˜é‡äº†ã€‚

æœ€åï¼Œåˆ›å»ºä¸€ä¸ªç”¨ JSON å“åº”çš„ GET roundï¼Œç„¶åç›‘å¬åœ¨`.env`æ–‡ä»¶ä¸­æŒ‡å®šçš„ç«¯å£ã€‚

ç»§ç»­ï¼Œæ‰“å¼€`.env`æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å‡ è¡Œ:

```
PORT=3000
INSTANCE_URL=
INSTANCE_USERNAME=
INSTANCE_PASSWORD=
INSTANCE_SCHEMA=
```

ä»¥`INSTANCE`å¼€å¤´çš„å­—æ®µå°†ä¿å­˜å…³äºæ•°æ®åº“çš„ä¿¡æ¯ã€‚ç°åœ¨ï¼Œå¦‚æœæ‚¨è¿˜æ²¡æœ‰ä¸€ä¸ª HarperDB å¸æˆ·ï¼Œæ˜¯æ—¶å€™åˆ›å»ºä¸€ä¸ªäº†ã€‚

# åˆ›å»ºå’Œé…ç½®æ•°æ®åº“

é¦–å…ˆï¼Œç™»å½• [HarperDB å·¥ä½œå®¤](https://studio.harperdb.io/)ã€‚ç™»å½•åï¼Œå•å‡» **+** æŒ‰é’®ï¼Œè¿™å°†åˆ›å»ºä¸€ä¸ªæ–°çš„ HarperDB äº‘å®ä¾‹ã€‚å›¾ä¸€ã€‚è¯´æ˜äº†è¿™ä¸€ç‚¹ã€‚

![](img/9f114ad624a723169a070258ace355bb.png)

å›¾ä¸€ã€‚

ä¹‹åï¼Œå°†è¦æ±‚æ‚¨é€‰æ‹©ä¸€ä¸ªæ–°çš„ HarperDB äº‘å®ä¾‹æˆ–æ³¨å†Œä¸€ä¸ªç”¨æˆ·å®‰è£…çš„å®ä¾‹ï¼Œå¦‚å›¾ 2 æ‰€ç¤ºã€‚

![](img/c1efb2c9f65d3cd6916fa86cb42ca3aa.png)

å›¾äºŒã€‚

ç‚¹å‡»æŒ‰é’® Create HarperDB Cloud Instanceã€‚å› æ­¤ï¼Œæ‚¨åœ¨ä»–ä»¬çš„äº‘ä¸­åˆ›å»ºæ•°æ®åº“å®ä¾‹ï¼Œè€Œä¸æ˜¯è‡ªå·±æ‰˜ç®¡å®ƒã€‚ä¹‹åï¼Œæ‚¨éœ€è¦è¾“å…¥:

*   å®ä¾‹çš„åç§°
*   ç”¨æˆ·å
*   ä¸€ä¸ªå¯†ç 

åœ¨å›¾ 3 ä¸­ã€‚ï¼Œä¸‹é¢ï¼Œä½ å¯ä»¥çœ‹åˆ°æˆ‘çš„å®ä¾‹ä¿¡æ¯ã€‚

![](img/9dd70a94dc6f12bf6a13a0ed49870185.png)

å›¾ 3ã€‚

ä¸‹ä¸€æ­¥æ˜¯é€‰æ‹©æ‚¨çš„å®ä¾‹è§„èŒƒã€‚å¯¹äºæœ¬æ•™ç¨‹ï¼Œæˆ‘å»ºè®®ä½ é€‰æ‹©å…è´¹é€‰é¡¹ã€‚æ‚¨å¯ä»¥å…è´¹è·å¾—ä»¥ä¸‹è§„æ ¼:

*   0.5GB å†…å­˜
*   1GB å­˜å‚¨å’Œ 100 IOPS

å›¾ 4ã€‚ï¼Œä¸‹é¢è¯´æ˜äº†è¿™ä¸€ç‚¹ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨è®¡åˆ’å¤§é‡ä½¿ç”¨ DBï¼Œæˆ‘å»ºè®®æ‚¨å¯åŠ¨å®ä¾‹å¹¶é€‰æ‹©æ›´å¥½çš„è§„èŒƒã€‚

![](img/3cbef0009de69c6197721b4bb36ce01e.png)

å›¾ 4ã€‚

æœ€åä¸€æ­¥æ˜¯ç¡®è®¤å®ä¾‹ç»†èŠ‚ï¼Œç„¶åç­‰å¾…å®ä¾‹å¯åŠ¨ã€‚å®ä¾‹è®¾ç½®å’Œåˆå§‹åŒ–åï¼Œå•å‡»å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥åœ¨å›¾ 5 ä¸­çœ‹åˆ°æˆ‘æ–°åˆ›å»ºçš„å®ä¾‹ã€‚ï¼Œä¸‹é¢ã€‚

å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¿é—®å®ä¾‹ï¼Œå¯èƒ½ä¼šæç¤ºæ‚¨è¾“å…¥ä¹‹å‰è®¾ç½®çš„ç”¨æˆ·åå’Œå¯†ç ã€‚

![](img/7216aeba8e7b48822a4a37bab5158ebe.png)

å›¾ 5ã€‚

æ‚¨çš„å®ä¾‹ç›®å‰æ²¡æœ‰ä»»ä½•æ¨¡å¼æˆ–è¡¨ã€‚å› æ­¤ï¼Œæ‚¨éœ€è¦é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ¨¡å¼ã€‚æ‚¨å¯ä»¥çœ‹åˆ°æˆ‘é€‰æ‹©äº†â€œmydbâ€ä½œä¸ºæˆ‘çš„æ¨¡å¼çš„åç§°(å›¾ 6ã€‚).ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥ä¸ºæ‚¨çš„æ¨¡å¼ä½¿ç”¨ä»»ä½•å…¶ä»–åç§°ã€‚

ä¸ºæ¨¡å¼é€‰æ‹©åç§°åï¼Œå•å‡»ç»¿è‰²å¤é€‰æ ‡è®°ä¿å­˜å®ƒã€‚

![](img/9b42847b04cc19b0ede707d54c77dff5.png)

å›¾ 6ã€‚

æœ€åï¼Œæ‚¨éœ€è¦åˆ›å»ºè¡¨ã€‚ç›®å‰ï¼Œæ‚¨å°†åªè®¾ç½®ä¸€ä¸ªåä¸ºâ€œè¯¾ç¨‹â€çš„è¡¨è¾“å…¥åç§°â€œè¯¾ç¨‹â€å¹¶æä¾›ä¸€ä¸ª`hash_attribute`åç§°ã€‚å“ˆå¸Œå±æ€§ç”¨äºå”¯ä¸€æ ‡è¯†æ¯æ¡è®°å½•ã€‚ç®€è€Œè¨€ä¹‹ï¼Œæ•£åˆ—å±æ€§å°±æ˜¯ IDï¼Œå®ƒå¯¹äºæ¯æ¡è®°å½•éƒ½æ˜¯å”¯ä¸€çš„ã€‚ç°åœ¨ï¼Œå•å‡»ç»¿è‰²å¤é€‰æ ‡è®°ä¿å­˜å®ƒï¼Œå¦‚å›¾ 7 æ‰€ç¤ºã€‚

![](img/7b86697c34c5e14f91e2adb05a0823e0.png)

å›¾ 7ã€‚

ç°åœ¨ï¼Œæ‚¨å¯ä»¥åœ¨ Node.js åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨æ•°æ®åº“äº†ã€‚

# åœ¨åº”ç”¨ç¨‹åºä¸­è®¾ç½®å’Œé…ç½® HarperDB

è¿›å…¥`.env`æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å‡ è¡Œ:

```
INSTANCE_URL=https://app-tutorial.harperdbcloud.com/
INSTANCE_USERNAME=admin
INSTANCE_PASSWORD=password
INSTANCE_SCHEMA=mydb
```

å½“ç„¶ï¼Œä½ éœ€è¦ç”¨ä½ çš„æ›¿æ¢é‚£äº›ç»†èŠ‚ã€‚ä»¥ä¸Šä¿¡æ¯éƒ½æ˜¯è™šæ„çš„ï¼Œä½ è¯•è¯•ä¹Ÿä¸è¡Œã€‚

ä¿å­˜æ–‡ä»¶ï¼Œè®©æˆ‘ä»¬ç»§ç»­ã€‚ç°åœ¨åˆ›å»ºä¸¤ä¸ªæ–‡ä»¶å¤¹å’Œä¸€ä¸ªæ•°æ®åº“æ–‡ä»¶ã€‚æ‚¨å¯ä»¥é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®Œæˆæ­¤æ“ä½œ:

```
mkdir src
mkdir src/db
touch src/db/db_config.js
```

ä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤ï¼Œæ‚¨åœ¨`src`ä¸­åˆ›å»ºäº†`db`æ–‡ä»¶å¤¹ã€‚æ­¤å¤–ï¼Œæ‚¨è¿˜åˆ›å»ºäº†ä¸€ä¸ªæ–‡ä»¶`db_config.js`,ç”¨äºå­˜å‚¨æ•°æ®åº“çš„é…ç½®ã€‚

æ‰“å¼€æ–°åˆ›å»ºçš„æ–‡ä»¶`db_config.js`å¹¶ç¼–å†™ä»¥ä¸‹ä»£ç :

```
const harperive = require('harperive').Client;

const DB_CONFIG = {
    harperHost: process.env.INSTANCE_URL,
    username: process.env.INSTANCE_USERNAME,
    password: process.env.INSTANCE_PASSWORD,
    schema: process.env.INSTANCE_SCHEMA
};

const client = new harperive(DB_CONFIG);

module.exports = client;
```

åœ¨ç¬¬ä¸€è¡Œä¸­ï¼Œæ‚¨å¯¼å…¥ HarperDB çš„ Node.js é©±åŠ¨ç¨‹åºã€‚ä¹‹åï¼Œæ‚¨åˆ›å»ºæ•°æ®åº“é…ç½®ï¼Œå¹¶å°†è¯¦ç»†ä¿¡æ¯å­˜å‚¨åœ¨`.env`æ–‡ä»¶ä¸­ã€‚æœ€åï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„å®¢æˆ·æœºå¹¶å°†å…¶å¯¼å‡ºã€‚

ç¨åï¼Œæ‚¨å°†åœ¨æ§åˆ¶å™¨æ–‡ä»¶ä¸­ä½¿ç”¨å®¢æˆ·ç«¯ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹è·¯çº¿å’Œæ§åˆ¶å™¨ã€‚

# é…ç½®åº”ç”¨ç¨‹åºç«¯ç‚¹

ç¬¬ä¸€æ­¥æ˜¯åœ¨`src`æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸¤ä¸ªæ–°æ–‡ä»¶å¤¹ã€‚æŒ‰å¦‚ä¸‹æ–¹å¼åˆ›å»ºå®ƒä»¬:

```
mkdir src/controllers
mkdir src/routes
```

ä¹‹åï¼Œæ‚¨éœ€è¦åœ¨æ–°åˆ›å»ºçš„æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸¤ä¸ªæ–°çš„ JavaScript æ–‡ä»¶ã€‚åˆ›å»ºæ–‡ä»¶`course.js`å’Œ`courseController.js`ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
touch src/routes/course.js
touch src/controllers/courseController.js
```

æ‚¨å°†ä»åˆ›å»ºè·¯çº¿å¼€å§‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨ Fastify æ’ä»¶æ¶æ„ã€‚å› æ­¤ï¼Œä»`routes`æ–‡ä»¶å¤¹ä¸­æ‰“å¼€`course.js`æ–‡ä»¶ï¼Œå¹¶ç¼–å†™ä»¥ä¸‹ä»£ç :

```
const courseController = require('../controllers/courseController');

async function routes(app, opts) {

}

module.exports = routes;
```

å‘ç”Ÿäº†ä¸‰ä»¶äº‹:

1.  æ‚¨å¯ä»¥å¯¼å…¥ç”¨äºè·¯çº¿çš„æ§åˆ¶å™¨ã€‚
2.  ä½ åˆ›å»ºäº†ä¸€ä¸ª`routes`å‡½æ•°ã€‚
3.  æ‚¨å¯¼å‡ºäº†æ–°åˆ›å»ºçš„`routes`å‡½æ•°ã€‚

åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œ`routes`ï¼Œä½ é…ç½®ä½ çš„åº”ç”¨ç¨‹åºçš„ç«¯ç‚¹ã€‚å¯¹äºæ¯ä¸ªè·¯ç”±ï¼Œè‡³å°‘è¦æŒ‡å®š HTTP æ–¹æ³•ã€URL å’Œå¤„ç†ç¨‹åºã€‚ç„¶è€Œï¼Œè¿˜æœ‰è®¸å¤šå…¶ä»–å‚æ•°ã€‚æ‚¨å¯ä»¥åœ¨ Fastify æ–‡æ¡£ä¸­çœ‹åˆ°[å®Œæ•´åˆ—è¡¨](https://www.fastify.io/docs/latest/Routes/#options)ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œè®©æˆ‘ä»¬æ„å»ºç¬¬ä¸€ä¸ªç«¯ç‚¹ï¼Œåœ¨è¢«è®¿é—®æ—¶è¿”å›æ‰€æœ‰è¯¾ç¨‹ã€‚æ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨`app`ä¸Šçš„`route`æ–¹æ³•æ¥å®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
const courseController = require('../controllers/courseController');

async function routes(app, opts) {

    // Get all courses
    app.route({
        method: 'GET',
        url: '/courses',
        handler: courseController.getCourses
    });
}

module.exports = routes;
```

æ‚¨ä»¥ç±»ä¼¼çš„æ–¹å¼æ„å»ºæ‰€æœ‰å…¶ä»–è·¯ç”±/ç«¯ç‚¹ã€‚å”¯ä¸€æ”¹å˜çš„æ˜¯æ–¹æ³•ã€URL å’Œå¤„ç†ç¨‹åºã€‚

åœ¨ä¸‹é¢çš„è¦ç‚¹ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„ç«¯ç‚¹ã€‚æ¯ä¸ª CRUD æ“ä½œéƒ½æœ‰ä¸€ä¸ªç«¯ç‚¹ã€‚åº”ç”¨ç¨‹åºç”¨æˆ·å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è¯¾ç¨‹æˆ–ç‰¹å®šè¯¾ç¨‹ï¼Œæ·»åŠ æ–°è¯¾ç¨‹ï¼Œä»¥åŠåˆ é™¤æˆ–ç¼–è¾‘ç°æœ‰è¯¾ç¨‹ã€‚

routes.js æ–‡ä»¶

**æ³¨æ„**:å¦‚ä½ æ‰€è§ï¼Œæ¯ä¸ªè·¯ç”±/ç«¯ç‚¹éƒ½æœ‰ä¸€ä¸ªç‰¹å®šçš„æ§åˆ¶å™¨ã€‚ç›®å‰ï¼Œå®ƒä»¬åªæ˜¯å ä½ç¬¦ï¼Œå› ä¸ºæ²¡æœ‰æ§åˆ¶å™¨ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ è¯•å›¾è¿›å…¥è·¯çº¿ï¼Œä»–ä»¬ä¸ä¼šå·¥ä½œã€‚ä½†æ˜¯è¿™åœ¨ä¸‹ä¸€æ­¥ä¸­ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå› ä¸ºæ‚¨ç°åœ¨å°†æ„å»ºåº”ç”¨ç¨‹åºé€»è¾‘ã€‚

**ç»§ç»­ä¹‹å‰è¿˜æœ‰ä¸€ä»¶äº‹ã€‚**è½¬åˆ°æ ¹æ–‡ä»¶å¤¹ä¸­çš„`app.js`å¹¶æ·»åŠ ä»¥ä¸‹è¡Œ:

```
app.register(require('./src/routes/course'));
```

è¯¥è¡Œçš„ç›®çš„æ˜¯ä½¿è·¯çº¿åœ¨æ‚¨çš„åº”ç”¨ç¨‹åºä¸­å¯ç”¨ã€‚å¦‚æœæ‚¨ä¸æ·»åŠ è¿™æ¡çº¿ï¼Œæ‚¨çš„è·¯çº¿å°†ä¸èµ·ä½œç”¨ã€‚

`app.js`çš„æœ€ç»ˆç‰ˆæœ¬åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

app.js æ–‡ä»¶

# ç”¨ HarperDB æ„å»ºåº”ç”¨ç¨‹åºé€»è¾‘

åº”ç”¨ç¨‹åºé€»è¾‘å®šä¹‰äº†å½“ç”¨æˆ·è¯·æ±‚ä¸Šä¸€èŠ‚ä¸­æŒ‡å®šçš„è·¯ç”±æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚

ä¾‹å¦‚ï¼Œå½“æœ‰äººè®¿é—®è·¯çº¿`/courses`æ—¶ï¼Œä»–ä»¬åº”è¯¥çœ‹åˆ°æ•°æ®åº“ä¸­çš„æ‰€æœ‰è¯¾ç¨‹ã€‚ä¸ºæ­¤ï¼Œè®©æˆ‘ä»¬ä»é‚£æ¡è·¯çº¿å¼€å§‹ã€‚

æ‰€æœ‰è·¯çº¿çš„ä»£ç å°†åœ¨`courseController.js`ä¸­ã€‚æ‰“å¼€`courseController.js`æ–‡ä»¶ï¼Œå¯¼å…¥æ–‡ä»¶é¡¶éƒ¨çš„ Harperive å®¢æˆ·ç«¯:

```
const client = require("../db/db_config");
```

æœ‰è¶£çš„äº‹æƒ…å¼€å§‹äº†ã€‚ä¸ºäº†æè¿° HarperDB çš„åŠŸèƒ½ï¼Œæ‚¨å°†ä½¿ç”¨ SQL å’Œ NoSQL æ“ä½œæ¥æ“ä½œæ•°æ®ã€‚

## æ„å»ºè·å–è·¯çº¿

åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œåœ¨å¯¼å…¥æ•°æ®åº“å®¢æˆ·æœºåæ·»åŠ ä»¥ä¸‹ä»£ç :

```
const getCourses = async (req, res) => {
    const allCourses = await client.query('SELECT * FROM mydb.courses');

    res.send({ allCourses });
};

module.exports = {
    getCourses,
}
```

å¦‚æ‚¨æ‰€è§ï¼ŒHarperDB Node.js é©±åŠ¨ç¨‹åºå…è®¸æ‚¨åœ¨æ•°æ®åº“ä¸Šè¿è¡Œ SQL æŸ¥è¯¢ã€‚ä¸Šè¿°æŸ¥è¯¢ä»æ•°æ®åº“ä¸­é€‰æ‹©å¹¶è¿”å›æ‰€æœ‰è¯¾ç¨‹ã€‚

ä¹‹åï¼Œä½¿ç”¨`response`å¯¹è±¡å°†æ•°æ®å‘é€ç»™å®¢æˆ·æœºã€‚å¦‚æœæ‚¨è¿è¡Œåº”ç”¨ç¨‹åºå¹¶å°è¯•è®¿é—®`/courses`è·¯çº¿ï¼Œæ‚¨å°†ä¸ä¼šè·å¾—ä»»ä½•æ•°æ®ï¼Œå› ä¸ºæ•°æ®åº“æ˜¯ç©ºçš„ã€‚

![](img/2070f49a3131eff5d55b97137fbbc8c8.png)

å›¾ 8ã€‚

å›¾ 8ã€‚è¯´æ˜äº†ä¸€ä¸ªæˆåŠŸçš„è¯·æ±‚ã€‚æ‚¨å¯ä»¥çœ‹åˆ°æ•°æ®æ•°ç»„æ˜¯ç©ºçš„ï¼Œå› ä¸ºæ•°æ®åº“æ˜¯ç©ºçš„ã€‚ç„¶è€Œï¼Œä¸€æ—¦æ•°æ®åº“ä¸­æœ‰äº†æ•°æ®ï¼Œæˆ‘ä»¬å°†é‡å¤è¿™ä¸ªè¯·æ±‚ã€‚

## å»ºç«‹é‚®æ”¿è·¯çº¿

ä¸‹ä¸€æ­¥æ˜¯æ„å»º POST è·¯å¾„ï¼Œè¿™æ ·å°±å¯ä»¥å°†æ•°æ®æ·»åŠ åˆ°æ•°æ®åº“ä¸­ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ NoSQL æ“ä½œã€‚åœ¨`getCourses`å¸¸é‡åç¼–å†™ä»¥ä¸‹ä»£ç :

```
const addCourse = async (req, res) => {
    const allProperties = Object.keys(req.body).length;

    if (allProperties !== 4) {
        res.code(400).send({ 
            error: 'Some properties are missing! Add the name, description, author and link!' 
        });

        return;
    }

    try {
        const newCourse = await client.insert({
            table: 'courses',
            records: [
                {
                    name: req.body.name,
                    description: req.body.description,
                    author: req.body.author,
                    link: req.body.link
                }
            ]
        });

        res.send({ newCourse });
    } catch (error) {
        res.send({ error });
    }
};

module.exports = {
    getCourses,
    addCourse,
}
```

é¦–å…ˆï¼Œ`try catch`å—ä¹‹å‰çš„éƒ¨åˆ†ç¡®ä¿ç”¨æˆ·æä¾›æ‰€æœ‰çš„å­—æ®µã€‚å¦‚æœç”¨æˆ·è¯•å›¾åœ¨æ²¡æœ‰æŒ‡å®šåç§°ã€æè¿°ã€ä½œè€…æˆ–é“¾æ¥çš„æƒ…å†µä¸‹æ·»åŠ è¯¾ç¨‹ï¼Œå°†ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚ç”¨æˆ·å¿…é¡»å§‹ç»ˆæä¾›æ‰€æœ‰å››ä¸ªå­—æ®µã€‚

ç„¶åï¼Œåœ¨`try catch`å—ä¸­ï¼Œä½¿ç”¨æ•°æ®åº“å®¢æˆ·ç«¯å°†æ–°è¯¾ç¨‹æ’å…¥æ•°æ®åº“ã€‚

*   æ‚¨éœ€è¦æŒ‡å®šè¡¨æ ¼(åœ¨æœ¬ä¾‹ä¸­æ˜¯`courses`)ï¼Œç„¶åæŒ‡å®š`records`ã€‚
*   å­—æ®µæ˜¯ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼Œè¿™æ„å‘³ç€æ‚¨å¯ä»¥ä¸€æ¬¡è¾“å…¥å¤šä¸ªè¯¾ç¨‹ã€‚ç„¶è€Œï¼Œå°±ç›®å‰è€Œè¨€ï¼Œä¸€ä¸ªå°±å¤Ÿäº†ã€‚

å¦‚æœæ’å…¥æˆåŠŸï¼Œå®ƒå°†è¿”å›æ–°æ·»åŠ çš„è¯¾ç¨‹ã€‚æ‚¨å¯ä»¥åœ¨å›¾ 9 ä¸­çœ‹åˆ°è¿è¡Œä¸­çš„è·¯ç”±ã€‚ï¼Œä¸‹é¢ã€‚

![](img/a38b7048ca6f296870526141c93b99ca.png)

å›¾ 9ã€‚

æ“ä½œæˆåŠŸï¼Œæ–°è¯¾ç¨‹è¢«æ·»åŠ åˆ°æ•°æ®åº“ä¸­ã€‚å›¾ 10ã€‚æ˜¾ç¤ºæ•°æ®åº“ä¸­çš„è¯¾ç¨‹ã€‚

![](img/0290d40c86ec0bca5d64705fad6da03a.png)

å›¾ 10ã€‚

## è·å¾—ç‰¹å®šè¯¾ç¨‹

è·å–ç‰¹å®šè¯¾ç¨‹ä¸è·å–æ‰€æœ‰è¯¾ç¨‹ç±»ä¼¼ï¼Œä½†æœ‰ä¸€ç‚¹ä¸åŒã€‚ç°åœ¨ï¼Œæ‚¨ä½¿ç”¨ä¸€ä¸ª`WHERE`å­å¥æ¥é€‰æ‹©ä¸€é—¨ç‰¹å®šçš„è¯¾ç¨‹ã€‚

æ‚¨åœ¨ URL ä¸­ä¼ é€’è¯¾ç¨‹ IDï¼Œç„¶å SQL æŸ¥è¯¢å°†å®ƒä¸æ•°æ®åº“ä¸­çš„è®°å½•è¿›è¡ŒåŒ¹é…ã€‚

ä½†é¦–å…ˆï¼Œâ€œæˆ‘å¦‚ä½•è·å¾— IDï¼Ÿâ€ä½ å¯èƒ½ä¼šé—®ã€‚æœ‰ä¸¤ç§é€‰æ‹©ã€‚(æ³¨æ„:é¦–å…ˆéœ€è¦æ•°æ®åº“ä¸­çš„è¯¾ç¨‹ã€‚)

1.  ä½ å¯ä»¥è®¿é—®è·¯çº¿`http://localhost:3000/courses`å¹¶è·å¾—ä½ æƒ³è¦çš„ä»»ä½•è¯¾ç¨‹çš„ IDã€‚
2.  å» HarperDB å·¥ä½œå®¤ï¼Œç‚¹å‡»è¯¾ç¨‹ï¼Œä½ ä¼šçœ‹åˆ°æ‰€æœ‰çš„ç»†èŠ‚ã€‚åœ¨é¡µé¢çš„é¡¶éƒ¨ï¼Œæ‚¨ä¼šçœ‹åˆ°å®ƒæŒ‡å®šäº†å“ªä¸ªæ˜¯ ID(å‚è§å›¾ 10ã€‚ï¼Œä»¥ä¸Š)ã€‚

```
const getSpecificCourse = async (req, res) => {
    const course = await client.query(`SELECT * FROM mydb.courses WHERE id="${req.params.id}"`);

    res.send({ course });
};

module.exports = {
    getCourses,
    addCourse,
    getSpecificCourse,
}
```

ä¹‹åï¼Œå®ƒè¿”å›è·¯çº¿ã€‚å›¾ 11ã€‚ï¼Œè¯´æ˜äº†å½“æ‚¨å‘å‡º GET è¯·æ±‚ä»¥è·å–ç‰¹å®šè¯¾ç¨‹æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚

![](img/c00fb3b33db2df624e147b3434533edd.png)

å›¾ 11ã€‚

## åˆ é™¤ç‰¹å®šè¯¾ç¨‹

æ‚¨å¯ä»¥é€šè¿‡åœ¨ URL ä¸­æä¾›è¯¾ç¨‹ ID æ¥åˆ é™¤è¯¾ç¨‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å‘`http://localhost:3000/courses/0eb95456-255b-44da-b3df-b90671ef0908`å‘å‡ºåˆ é™¤è¯·æ±‚ï¼Œæ‚¨å°†åˆ é™¤å…·æœ‰æŒ‡å®š ID çš„è¯¾ç¨‹ã€‚

```
const deleteCourse = async (req, res) => {
    const course = await client.query(`DELETE FROM mydb.courses WHERE id="${req.params.id}"`);

    res.send({ 
        message: 'Course deleted!',
        deleteCourse: course
     });
};

module.exports = {
    getCourses,
    addCourse,
    getSpecificCourse,
    deleteCourse
}
```

ä¸€æ—¦è¯¾ç¨‹è¢«åˆ é™¤ï¼Œå®ƒä¼šå‘é€ä¸€æ¡ç¡®è®¤æ¶ˆæ¯å’Œä¸€äº›é¢å¤–çš„ä¿¡æ¯ã€‚å›¾ 12ã€‚è¯´æ˜äº†ä¸€ä¸ªåˆ é™¤è¯·æ±‚ã€‚

![](img/df657a9fc650cf9f49b381f89d54134f.png)

å›¾ 12ã€‚

## æ„å»º PUT è·¯çº¿

æœ€åï¼Œè¿™æ¡è·¯çº¿å…è®¸æ‚¨æ›´æ–°ç°æœ‰çš„è¯¾ç¨‹ã€‚åœ¨`try catch`å—ä¹‹å‰çš„æ‰€æœ‰ä»£ç ç¡®ä¿ç”¨æˆ·åªä½¿ç”¨å…è®¸çš„å­—æ®µ:åç§°ã€æè¿°ã€ä½œè€…å’Œé“¾æ¥ã€‚å¦‚æœç”¨æˆ·è¯•å›¾æ›´æ–°ä¸€ä¸ªä¸å­˜åœ¨çš„å­—æ®µï¼ŒæœåŠ¡å™¨å°†è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚

è¦ç¼–è¾‘è¯¾ç¨‹ï¼Œæ‚¨éœ€è¦å†æ¬¡ä½¿ç”¨ NoSQL æ“ä½œã€‚åœ¨æ•°æ®åº“å®¢æˆ·æœºä¸Šè°ƒç”¨`update`æ–¹æ³•ï¼Œç„¶åä¼ é€’è¡¨å(åœ¨æœ¬ä¾‹ä¸­æ˜¯`courses`)å’Œæƒ³è¦æ›´æ–°çš„è®°å½•ã€‚

æ­¤å¤–ï¼Œåœ¨è®°å½•æ•°ç»„ä¸­æŒ‡å®š`id`ä¹Ÿå¾ˆé‡è¦ã€‚å¦‚æœä¸è¿™æ ·åšï¼ŒæœåŠ¡å™¨å°±ä¸çŸ¥é“è¦æ›´æ–°å“ªæ¡è®°å½•ã€‚

```
const editCourse = async (req, res) => {
    const updates = Object.keys(req.body);
    const allowedUpdates = ['name', 'description', 'author', 'link'];
    const isValidOperation = updates.every((update) => allowedUpdates.includes(update));

    if (!isValidOperation) {
        res.code(400).send({ error: 'Not a valid operation! '});

        return;
    }

    try {
        const updatedCourse = await client.update({
            table: 'courses',
            records: [
                {
                    id: req.params.id,
                    name: req.body.name,
                    description: req.body.description,
                    author: req.body.author,
                    link: req.body.link
                }
            ]
        });

        res.send({ updatedCourse });
    } catch (error) {
        res.send({ error });
    }
};

module.exports = {
    getCourses,
    addCourse,
    getSpecificCourse,
    deleteCourse,
    editCourse
}
```

å¦‚æœæœ‰é”™è¯¯ï¼ŒæœåŠ¡å™¨ä¼šå‘å›é”™è¯¯ã€‚å¦åˆ™ï¼Œå®ƒè¿”å›æ›´æ–°çš„è¯¾ç¨‹ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†å¦‚ä½•å‘å‡ºä¸€ä¸ª PUT è¯·æ±‚ï¼Œä»¥åŠå½“å®ƒæˆåŠŸæ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚

![](img/b93d20c29ab4d80d5b09fc4868c92f3c.png)

å›¾ 13ã€‚

è¿™äº›éƒ½æ˜¯å…³äºè·¯çº¿å’Œæ§åˆ¶å™¨çš„ã€‚ä½ å¯ä»¥åœ¨[è¿™ä¸ªè¦è¯€](https://gist.github.com/catalinpit/191cbb0db15a52121e28461b31bc0a35)é‡Œçœ‹åˆ°æ•´ä¸ª`courseController.js`æ–‡ä»¶ã€‚æˆ‘é€‰æ‹©ä¸åµŒå…¥å®ƒï¼Œå› ä¸ºå®ƒå¾ˆå¤§ï¼Œåœ¨é¡µé¢ä¸Šå äº†å¾ˆå¤§çš„ç©ºé—´ã€‚

åŒæ ·çš„ï¼Œä½ å¯ä»¥**åœ¨**[**my GitHub**](https://github.com/catalinpit/harperdb-fastifyjs-rest-api)ä¸Šçœ‹åˆ°å®Œæ•´çš„åº”ç”¨ã€‚ä¸ºäº†æ›´å¥½åœ°å­¦ä¹ ï¼Œç»å†å®ƒï¼Œæ”¹å˜ä¸œè¥¿ï¼Œæ‰“ç ´ä¸œè¥¿ï¼Œå¢åŠ ä¸œè¥¿ï¼Œç­‰ç­‰ã€‚

# å¦‚ä½•å¯åŠ¨åº”ç”¨ç¨‹åº

æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œæ ¹æ–‡ä»¶å¤¹ä¸­çš„`node app.js`æ¥å¯åŠ¨åº”ç”¨ç¨‹åºã€‚

ä½†æ˜¯ï¼Œå¦‚æœæ‚¨ä» GitHub å…‹éš†åº”ç”¨ç¨‹åºï¼Œæ‚¨éœ€è¦é¦–å…ˆå®‰è£…ä¾èµ–é¡¹ã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®ç°:

```
npm install
node app.js
```

# ç»“è®º

è‡³æ­¤ï¼Œæ‚¨åº”è¯¥æœ‰äº†ä¸€ä¸ª REST APIï¼Œå®ƒå…è®¸æ‚¨å­˜å‚¨å’Œæ“ä½œè¯¾ç¨‹ã€‚æœ¬æ•™ç¨‹çš„ç›®çš„æ˜¯å¿«é€ŸæŒæ¡è¿™ä¸¤ç§æŠ€æœ¯ã€‚å› æ­¤ï¼Œå¯ä»¥æ·»åŠ å…¶ä»–å†…å®¹ï¼Œä¾‹å¦‚:

*   æˆæƒ
*   API é€Ÿç‡é™åˆ¶
*   æ·»åŠ ä¸€ä¸ªå‰ç«¯ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºå…¨æ ˆåº”ç”¨ç¨‹åº

ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä½ å–œæ¬¢è¿™ä¸ªæ•™ç¨‹ï¼Œæƒ³è¦ç¬¬ 2 éƒ¨åˆ†ï¼Œæˆ‘ç”¨ Vue æ„å»ºå‰ç«¯ï¼Œè¯·åœ¨è¯„è®ºä¸­å‘Šè¯‰æˆ‘ã€‚