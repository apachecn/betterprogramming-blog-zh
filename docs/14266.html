<html>
<head>
<title>Semantic Search With HuggingFace and Elasticsearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ä½¿ç”¨HuggingFaceå’ŒElasticsearchè¿›è¡Œè¯­ä¹‰æœç´¢</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://betterprogramming.pub/implementing-nearest-neighbour-search-with-elasticsearch-c59a8d33dd9d?source=collection_archive---------1-----------------------#2022-11-23">https://betterprogramming.pub/implementing-nearest-neighbour-search-with-elasticsearch-c59a8d33dd9d?source=collection_archive---------1-----------------------#2022-11-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2805" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">è®©æˆ‘ä»¬ä½¿ç”¨æœ€è¿‘é‚»æœç´¢å¯¹æ•°æ®é›†ä¸­çš„æ®µè½è¿›è¡Œæ’åº</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ca7af4cf21f724eb1f4d4789fe730836.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2-zK3Qn5SXEOST4A"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">é©¬åº“æ–¯Â·æ¸©å…‹å‹’åœ¨<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>ä¸Šçš„ç…§ç‰‡</p></figure><p id="80bc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¯†é›†åµŒå…¥æ˜¯æœºå™¨å­¦ä¹ ä¸­çš„æ¸¸æˆæ”¹å˜è€…ï¼Œå°¤å…¶æ˜¯åœ¨æœç´¢å¼•æ“å’Œæ¨èç³»ç»Ÿä¸­ã€‚å¯†é›†åµŒå…¥ç›®å‰è¢«åº”ç”¨äºè‡ªç»„ç»‡ä¿¡æ¯æ£€ç´¢ã€äº§å“æœç´¢ã€æ¨èå¼•æ“ç­‰ã€‚è®¸å¤šå…¬å¸ç›®å‰æ­£åœ¨ä»–ä»¬çš„å·¥ä½œæµç¨‹ä¸­é‡‡ç”¨æŸç§å½¢å¼çš„åŸºäºåµŒå…¥çš„æœç´¢ã€‚</p><p id="c97f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ä¸€äº›å…³äºå½“å‰é¡¶çº§å…¬å¸å¦‚ä½•é›†æˆå¯†é›†åµŒå…¥çš„æ–‡ç« æœ‰<a class="ae kv" href="https://sigir-ecom.github.io/ecom22Papers/paper_8392.pdf" rel="noopener ugc nofollow" target="_blank"> Instacart </a>ã€<a class="ae kv" href="https://doordash.news/company/powering-search-recommendations-at-doordash/" rel="noopener ugc nofollow" target="_blank"> DoorDash </a>ã€<a class="ae kv" href="https://www.etsy.com/codeascraft/deep-learning-for-search-ranking-at-etsy?utm_source=pocket_reader" rel="noopener ugc nofollow" target="_blank"> Etsy </a>ã€<a class="ae kv" href="https://blog.google/products/search/search-language-understanding-bert/" rel="noopener ugc nofollow" target="_blank"> Google </a>å’Œ<a class="ae kv" href="https://medium.com/airbnb-engineering/improving-deep-learning-for-ranking-stays-at-airbnb-959097638bde" rel="noopener"> Airbnb </a>ã€‚</p><p id="b3a4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Googleçš„Talk to bookså¾ˆå¥½åœ°æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨å¯†é›†å‘é‡è¿›è¡Œæœç´¢ã€‚è¿™ç§å½¢å¼çš„æœç´¢é€šå¸¸è¢«ç§°ä¸ºè¯­ä¹‰æœç´¢ã€‚è¯¥æ¼”ç¤ºä½¿ç”¨ç¼–ç å™¨æ¨¡å‹ä»å­˜å‚¨åœ¨ç´¢å¼•ä¸­çš„æ–‡æ¡£(åœ¨æ­¤ä¸Šä¸‹æ–‡ä¸­æ˜¯ä¹¦ç±)ç”ŸæˆåµŒå…¥ï¼Œå¹¶åœ¨æœç´¢æ—¶ä¸æŸ¥è¯¢å‘é‡è¿›è¡Œæ¯”è¾ƒï¼Œä»¥æ£€ç´¢ä¸ç»™å®šæŸ¥è¯¢æœ€ç›¸ä¼¼çš„æ–‡æ¡£ã€‚è¯­ä¹‰æœç´¢æ˜¯å¯¹BM25ç­‰ä¼ ç»Ÿå…³é”®è¯æœç´¢ç®—æ³•çš„é‡å¤§å‡çº§ï¼Œå› ä¸ºå®ƒå¯ä»¥æ£€ç´¢ä¸ç»™å®šæŸ¥è¯¢ç›¸å…³çš„æ–‡æ¡£ï¼Œä½†ä¸ä¸€å®šåŒ…å«ä¸æŸ¥è¯¢å®Œå…¨ç›¸åŒçš„å•è¯ã€‚</p><blockquote class="ls lt lu"><p id="498b" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><strong class="ky ir">è¾¹æ³¨</strong>:æ¼”ç¤ºä¸­ä½¿ç”¨çš„è¿™ä¸ªæ¨¡å‹(<a class="ae kv" href="https://arxiv.org/abs/1803.11175" rel="noopener ugc nofollow" target="_blank">é€šç”¨è¯­å¥ç¼–ç å™¨</a>))åœ¨æ·±åº¦å­¦ä¹ è°±ç³»ä¸­æœ‰äº›é™ˆæ—§ï¼Œæœ‰ä¸€äº›æ¨¡å‹å¯ä»¥äº§ç”Ÿæ›´å¥½çš„åµŒå…¥ï¼Œå…¶ä¸­ä¸€äº›å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°<a class="ae kv" href="https://huggingface.co/models?pipeline_tag=sentence-similarity&amp;sort=downloads" rel="noopener ugc nofollow" target="_blank">ã€‚</a></p></blockquote><h1 id="1ffb" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">ä»€ä¹ˆæ˜¯å¯†é›†åµŒå…¥ï¼Ÿ</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mr"><img src="../Images/edae136fdba96dbdd3ddac515897fa77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r96tb0gQwA0VIBwgXqKRdg.png"/></div></div></figure><p id="ec84" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¯†é›†åµŒå…¥æ˜¯æ•°æ®(æ–‡æœ¬ã€ç”¨æˆ·ã€äº§å“ç­‰)çš„æ•°å­—è¡¨ç¤ºã€‚)ä½¿ç”¨é«˜ç»´å‘é‡ã€‚å¯†é›†å‘é‡å…·æœ‰ä¸åŒçš„é•¿åº¦ï¼Œå¹¶è¢«æœŸæœ›å¯¹å…³äºåŸå§‹æ•°æ®çš„ä¿¡æ¯è¿›è¡Œç¼–ç ï¼Œä»¥ä¾¿ä½¿ç”¨åƒ<a class="ae kv" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.pairwise.cosine_similarity.html" rel="noopener ugc nofollow" target="_blank">ä½™å¼¦ç›¸ä¼¼åº¦</a>è¿™æ ·çš„å‘é‡ç›¸ä¼¼åº¦ç®—æ³•æ¥å®¹æ˜“åœ°æ‰¾åˆ°ç›¸ä¼¼çš„æ•°æ®ç‚¹ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„å®ç°:</p><pre class="kg kh ki kj gt ms mt mu bn mv mw bi"><span id="9299" class="mx ma iq mt b be my mz l na nb">from sklearn.metrics.pairwise import cosine_similarity<br/>from numpy import random<br/><br/>array_vec_1 = random.rand(1,10)<br/>array_vec_2 = random.rand(1,10)<br/>print(cosine_similarity(array_vec_1, array_vec_2))</span></pre><blockquote class="ls lt lu"><p id="f991" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><strong class="ky ir">è¾¹æ³¨</strong>:ä¸¤ä¸ªå‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦è¶Šé«˜ï¼Œè¶Šç›¸ä¼¼ã€‚ä½™å¼¦ç›¸ä¼¼æ€§ä¹Ÿè¢«ç”¨ä½œè®­ç»ƒç¥ç»ç½‘ç»œçš„æŸå¤±å‡½æ•°ã€‚å‚è§py torch<a class="ae kv" href="https://pytorch.org/docs/stable/generated/torch.nn.CosineEmbeddingLoss.html" rel="noopener ugc nofollow" target="_blank">cosinembeddingloss</a></p></blockquote><p id="0084" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ä¸ºäº†ç”Ÿæˆé«˜è´¨é‡çš„ä¿¡æ¯ä¸°å¯Œçš„åµŒå…¥ï¼Œæ‚¨éœ€è¦å·²ç»åœ¨æ•°ç™¾ä¸‡æˆå¯¹ç¤ºä¾‹ä¸Šè®­ç»ƒè¿‡çš„æœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œå¹¶ä¸”æœ‰ä¸€äº›è®­ç»ƒæŠ€æœ¯(ä¾‹å¦‚ï¼Œä½¿ç”¨ç¡¬å¦å®šçš„å¯¹æ¯”å­¦ä¹ )å·²ç»è¢«åº”ç”¨äºç”Ÿæˆé«˜è´¨é‡çš„åµŒå…¥ã€‚å¯¹äºä¸€èˆ¬çš„è¯­ä¹‰æœç´¢å’Œå¥å­è¡¨ç¤ºï¼Œåœ¨<a class="ae kv" href="https://huggingface.co/models?pipeline_tag=sentence-similarity&amp;sort=downloads" rel="noopener ugc nofollow" target="_blank"> HuggingFace </a>ä¸Šæœ‰å¤§é‡å…¬å¼€å¯ç”¨çš„é¢„è®­ç»ƒæˆ–å¾®è°ƒæ¨¡å‹ğŸ¤—ä»¥åŠä¸€äº›å•†ç”¨APIå¦‚<a class="ae kv" href="https://docs.cohere.ai/docs/embeddings" rel="noopener ugc nofollow" target="_blank"> cohereåµŒå…¥</a>å’Œ<a class="ae kv" href="https://beta.openai.com/docs/guides/embeddings" rel="noopener ugc nofollow" target="_blank"> OpenAIåµŒå…¥</a>ç”¨äºç¼–ç æ–‡æœ¬ã€‚</p><h1 id="4c25" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">ç´¢å¼•å’Œæœç´¢</h1><p id="a768" class="pw-post-body-paragraph kw kx iq ky b kz nc jr lb lc nd ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">åœ¨å¯¹æˆ‘ä»¬çš„æ–‡æ¡£è¿›è¡Œç¼–ç (ç”Ÿæˆæ–‡æ¡£åµŒå…¥)ä¹‹åï¼Œæˆ‘ä»¬ç°åœ¨å¿…é¡»è€ƒè™‘ç´¢å¼•å‘é‡å’Œæœç´¢å¯†é›†ç´¢å¼•ã€‚</p><p id="aea3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å‘é‡æœç´¢é€šå¸¸ä½¿ç”¨èšç±»ç®—æ³•(å¦‚æœ€è¿‘é‚»æœç´¢)æ¥å®Œæˆï¼Œç”±äºå„ç§åŸå› ï¼Œå®ƒå¯èƒ½æ˜¯è®¡ç®—å¯†é›†å‹çš„ï¼Œå¹¶ä¸”å®æ–½èµ·æ¥å…·æœ‰æŒ‘æˆ˜æ€§ï¼Œå…¶ä¸­ä¸€äº›åŸå› æ˜¯:</p><p id="fe7d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">(I .)ä¸€äº›ç¼–ç å™¨äº§ç”Ÿå…·æœ‰å¤§å°ºå¯¸çš„è¡¨ç¤ºå‘é‡ã€‚å¤§çš„åµŒå…¥å¯¼è‡´å¤§çš„åµŒå…¥è¡¨ï¼Œå½“æ‰§è¡Œå‘é‡æ“ä½œæ—¶å…·æœ‰é«˜çš„å­˜å‚¨å™¨æˆæœ¬ï¼Œå¹¶ä¸”å¯èƒ½å¢åŠ æœç´¢ç­‰å¾…æ—¶é—´ã€‚</p><p id="ec00" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">(äºŒã€‚)ç”¨æ–°çš„å‘é‡æ›´æ–°å¯†é›†ç´¢å¼•å¯èƒ½è¦æ±‚å¾ˆé«˜ï¼Œå› ä¸ºæ‚¨å¯èƒ½éœ€è¦ä¸ºæ–°çš„å‘é‡æ›´æ–°ç´¢å¼•ç°‡ã€‚</p><p id="76dd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ä¸€äº›å¼€æºåº“å·²ç»ä¸ºå¿«é€ŸçŸ¢é‡æœç´¢å»ºç«‹èµ·æ¥ï¼Œä»¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå¦‚Metaçš„<a class="ae kv" href="https://github.com/facebookresearch/faiss" rel="noopener ugc nofollow" target="_blank"> Faiss </a>ï¼ŒSpotifyçš„<a class="ae kv" href="https://github.com/spotify/annoy" rel="noopener ugc nofollow" target="_blank">angry</a>ï¼Œè°·æ­Œçš„<a class="ae kv" href="https://github.com/google-research/google-research/tree/master/scann" rel="noopener ugc nofollow" target="_blank"> ScaNN </a>ã€‚åœ¨<a class="ae kv" href="https://www.elastic.co/blog/introducing-approximate-nearest-neighbor-search-in-elasticsearch-8-0" rel="noopener ugc nofollow" target="_blank">8.0</a>+ç‰ˆæœ¬ä¸­ï¼ŒElasticsearchå®£å¸ƒä»–ä»¬æµè¡Œçš„å¼€æºæœç´¢å¼•æ“ç°åœ¨æ”¯æŒæœ€è¿‘é‚»æœç´¢ã€‚</p><blockquote class="ls lt lu"><p id="1731" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><strong class="ky ir">æ—æ³¨</strong> : <a class="ae kv" href="https://news.ycombinator.com/item?id=29554986" rel="noopener ugc nofollow" target="_blank">å‚è§å…³äºä½¿ç”¨å¯†é›†å‘é‡å®ç°è¯­ä¹‰æœç´¢çš„ç¼ºç‚¹å’Œè§£å†³æ–¹æ¡ˆçš„è®¨è®º</a>ã€‚æ­¤å¤–ï¼Œ<a class="ae kv" href="http://ann-benchmarks.com/" rel="noopener ugc nofollow" target="_blank">å…³äºä¸åŒçš„è¿‘ä¼¼æœ€è¿‘é‚»ç®—æ³•æœç´¢ç®—æ³•å’Œåº“ï¼Œå‚è§åŸºå‡†</a>ã€‚</p></blockquote><h1 id="2256" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">ä½¿ç”¨å¼¹æ€§æœç´¢çš„è¿‘ä¼¼æœç´¢</h1><p id="5973" class="pw-post-body-paragraph kw kx iq ky b kz nc jr lb lc nd ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">è®©æˆ‘ä»¬è¿›å…¥æœ‰è¶£çš„éƒ¨åˆ†ï¼</p><p id="9789" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æˆ‘ä»¬å°†å¯¹ç”±880ä¸‡ç¯‡æ–‡ç« ç»„æˆçš„<a class="ae kv" href="https://microsoft.github.io/msmarco/Datasets.html" rel="noopener ugc nofollow" target="_blank">MARCOå¥³å£«</a>æ–‡ç« æ’åé›†åˆè¿›è¡Œç¼–ç å’Œç´¢å¼•ã€‚ç›®æ ‡æ˜¯æ ¹æ®æ®µè½ä¸ç»™å®šæŸ¥è¯¢çš„ç›¸å…³æ€§å¯¹å®ƒä»¬è¿›è¡Œæ’åºã€‚ä¸‹è½½å¹¶è§£å‹ç¼©è¯¥é›†åˆã€‚</p><pre class="kg kh ki kj gt ms mt mu bn mv mw bi"><span id="462d" class="mx ma iq mt b be my mz l na nb">wget https://public.ukp.informatik.tu-darmstadt.de/thakur/BEIR/datasets/msmarco.zip<br/>unzip msmarco.zip</span></pre><p id="ca67" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç åœ¨ä¸‹è½½åé¢„è§ˆæ•°æ®:</p><pre class="kg kh ki kj gt ms mt mu bn mv mw bi"><span id="c603" class="mx ma iq mt b be my mz l na nb">#inspect the data<br/>head -1 msmarco/corpus.jsonl<br/><br/>#output<br/>"""<br/>{<br/>  '_id': '0', <br/>  'title': '', <br/>  'text': 'The presence of communication amid scientific minds was equally important to the success of the Manhattan Project as scientific intellect was. The only cloud hanging over the impressive achievement of the atomic researchers and engineers is what their success truly meant; hundreds of thousands of innocent lives obliterated.', <br/>  'metadata': {}<br/>}<br/>"""<br/></span></pre><p id="92f1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°æ®é›†è¿›è¡Œç¼–ç ã€‚å¯¹äºæœ¬æ•™ç¨‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ‰˜ç®¡åœ¨HuggingFaceä¸Šçš„<a class="ae kv" href="https://huggingface.co/sentence-transformers/msmarco-MiniLM-L6-cos-v5" rel="noopener ugc nofollow" target="_blank">â€œå¥å­-å˜å½¢é‡‘åˆš/ms Marco-MiniLM-L6-cos-V5â€</a>æ¨¡å‹ã€‚è¯¥æ¨¡å‹åœ¨MS Marco passage rankingé›†åˆä¸Šè®­ç»ƒï¼Œä¸ºæ¯ä¸ªè¾“å…¥åºåˆ—äº§ç”Ÿ384é•¿åº¦çš„åµŒå…¥ã€‚æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªç¼–ç å™¨å‡½æ•°ï¼Œå®ƒæ¥å—ä¸€æ®µæˆ–ä¸€æ‰¹æ–‡æœ¬ï¼Œå¹¶ä¸ºæ¯ä¸ªæ–‡æœ¬ç”ŸæˆåµŒå…¥ã€‚</p><p id="167e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">è¯¥æ¨¡å‹ä¸ºè¾“å…¥å¥å­ä¸­çš„æ¯ä¸ªæ ‡è®°ç”Ÿæˆä¸åŒçš„åµŒå…¥é›†ã€‚æˆ‘ä»¬ä½¿ç”¨å¹³å‡æ± (ä¹Ÿç§°ä¸ºå¹³å‡æ± )æ¥èšé›†åµŒå…¥ã€‚æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸º[CLS]ä»¤ç‰Œç”Ÿæˆçš„åµŒå…¥å‘é‡ã€‚</p><blockquote class="ls lt lu"><p id="deda" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">æ—æ³¨:<a class="ae kv" href="https://blog.ml6.eu/the-art-of-pooling-embeddings-c56575114cf8" rel="noopener ugc nofollow" target="_blank">è¿™é‡Œæœ‰ä¸€ä¸ªå…³äºåˆç”¨çš„åˆçº§è¯»æœ¬</a></p></blockquote><pre class="kg kh ki kj gt ms mt mu bn mv mw bi"><span id="ff25" class="mx ma iq mt b be my mz l na nb">class MSMarcoEncoder:<br/>    def __init__(self, model_name: str, device : str='cpu'):<br/>        self.device = device<br/>        self.tokenizer = AutoTokenizer.from_pretrained(model_name)<br/>        self.model = AutoModel.from_pretrained(model_name)<br/>        self.model.to(self.device)<br/><br/>    def encode(self, text:str, max_length: int):<br/>        inputs = self.tokenizer(text, return_tensors="pt", padding=True, truncation=True, max_length=max_length)<br/>        inputs = inputs.to(self.device)<br/>        with torch.no_grad():<br/>            model_output = self.model(**inputs, return_dict=True)<br/>        # Perform pooling<br/>        embeddings = self.mean_pooling(model_output, inputs['attention_mask'])<br/>        # Normalize embeddings<br/>        embeddings = F.normalize(embeddings, p=2, dim=1)<br/>        return embeddings.detach().cpu().numpy()<br/><br/>    def mean_pooling(self, model_output, attention_mask):<br/>        token_embeddings = model_output[0] #First element of model_output contains all token embeddings<br/>        input_mask_expanded = attention_mask.unsqueeze(-1).expand(token_embeddings.size()).float()<br/>        return torch.sum(token_embeddings * input_mask_expanded, 1) / torch.clamp(input_mask_expanded.sum(1), min=1e-9)<br/><br/>if __name__ == "__main__":<br/>    encoder = Encoder('sentence-transformers/msmarco-MiniLM-L6-cos-v5')<br/>    embeddings = encoder.encode(batch_info['text'], 512)<br/>    </span></pre><p id="1d47" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ç°åœ¨æˆ‘ä»¬æœ‰äº†ç¼–ç å™¨ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Elasticsearchä¸­ç´¢å¼•æ•°æ®ï¼Œä¸ºäº†æœ‰æ•ˆåœ°åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªè¿­ä»£å™¨æ¥æ‰¹é‡å¾ªç¯æ•°æ®ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®å¹¶ç¡®ä¿Elasticsearchæ­£åœ¨è¿è¡Œã€‚é¦–å…ˆï¼Œæˆ‘ä»¬æŒ‰ç…§è¿™é‡Œçš„<a class="ae kv" href="https://www.elastic.co/downloads/elasticsearch" rel="noopener ugc nofollow" target="_blank">æŒ‡ä»¤åœ¨æœ¬åœ°ä¸‹è½½å¹¶å¯åŠ¨elasticsearchæœåŠ¡å™¨</a>æˆ–è€…æŒ‰ç…§<a class="ae kv" href="https://www.elastic.co/downloads/elasticsearch" rel="noopener ugc nofollow" target="_blank">è¿™ä¸ª</a>å¯åŠ¨ä¸€ä¸ªelastic searchå®¹å™¨ã€‚</p><p id="8d45" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¯¹äºæœ¬åœ°è®¾ç½®ï¼Œåœ¨ä¸‹è½½elasticsearchä¹‹åï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å¯åŠ¨ä¸€ä¸ªå…·æœ‰ä¸€ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤:</p><pre class="kg kh ki kj gt ms mt mu bn mv mw bi"><span id="0d1d" class="mx ma iq mt b be my mz l na nb">./elasticsearch-8.5.1/bin/elasticsearch</span></pre><p id="fda7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">é»˜è®¤æƒ…å†µä¸‹ï¼ŒElasticSearch 8.0åŠæ›´é«˜ç‰ˆæœ¬å¯ç”¨äº†å®‰å…¨æ€§ï¼Œå› æ­¤è¯·é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥éªŒè¯æ‚¨æ˜¯å¦å¯ä»¥è¿æ¥åˆ°æ­£åœ¨è¿è¡Œçš„ElasticSearché›†ç¾¤:</p><pre class="kg kh ki kj gt ms mt mu bn mv mw bi"><span id="96d0" class="mx ma iq mt b be my mz l na nb">curl --cacert config/certs/http_ca.crt -u elastic https://localhost:9200</span></pre><p id="6fc6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ç°åœ¨æˆ‘ä»¬çš„elasticsearchæœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªç´¢å¼•æ¥å­˜å‚¨æ•°æ®ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ•°æ®é›†ä¸­çš„ä¸åŒå­—æ®µå®šä¹‰ä¸€ä¸ªæ˜ å°„ã€‚ç„¶è€Œï¼Œå¯¹äºæœ€è¿‘é‚»æœç´¢ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªç±»å‹ä¸º<code class="fe nh ni nj mt b">dense_vector</code>çš„å­—æ®µï¼Œå®ƒå°†åŒ…å«æ¯ä¸ªæ–‡æ¡£çš„åµŒå…¥å†…å®¹ã€‚</p><pre class="kg kh ki kj gt ms mt mu bn mv mw bi"><span id="59e0" class="mx ma iq mt b be my mz l na nb">from elasticsearch import Elasticsearch<br/><br/>es_client = Elasticsearch( "https://localhost:9200", <br/>                  http_auth=("username", "password"),<br/>                  verify_certs=False)<br/>config = {<br/>    "mappings": {<br/>        "properties": {<br/>            "title": {"type": "text"},<br/>            "text": {"type": "text"},<br/>            "embeddings": {<br/>                    "type": "dense_vector",<br/>                    "dims": 384,<br/>                    "index": false<br/>                }<br/>            }<br/>    },<br/>    "settings": {<br/>        "number_of_shards": 2,<br/>        "number_of_replicas": 1<br/>    }<br/>}<br/><br/>es_client.indices.create(<br/>    index="msmarco-demo",<br/>    settings=config["settings"],<br/>    mappings=config["mappings"],<br/>)<br/><br/>#check if the index has been created successfully<br/>print(es.indices.exists(index=["msmarco-demo"]))<br/>#True</span></pre><p id="245c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ä¸‹é¢çš„ä»£ç ç‰‡æ®µä½¿ç”¨elasticsearchçš„æ‰¹é‡ç´¢å¼•APIæ¥æ‰¹é‡ç´¢å¼•æ–‡æ¡£ã€‚ä¸‹é¢çš„ä»£ç åœ¨<code class="fe nh ni nj mt b">cpu</code>ä¸Šè¿è¡Œæ—¶é—´æ›´é•¿ï¼Œåœ¨<code class="fe nh ni nj mt b">gpu or tpu</code>ä¸Šè¿è¡Œé€Ÿåº¦æ›´å¿«ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª<a class="ae kv" href="https://gist.github.com/ToluClassics/bc4bbd8b7930ee35e237984c2c9998a1#file-knn_elasticsearch-py-L10-98" rel="noopener ugc nofollow" target="_blank">é›†åˆè¿­ä»£å™¨ç±»</a>æ¥éå†æ•°æ®é›†ã€‚å¯¹äºæ¯ä¸€æ‰¹ï¼Œæˆ‘ä»¬ç”ŸæˆåµŒå…¥å¹¶ç´¢å¼•å®ƒä»¬ã€‚</p><pre class="kg kh ki kj gt ms mt mu bn mv mw bi"><span id="94e7" class="mx ma iq mt b be my mz l na nb">collection_path = 'path/to/corpus.jsonl'<br/>collection_iterator = JsonlCollectionIterator(collection_path, fields=['title','text'])<br/>encoder = Encoder('sentence-transformers/msmarco-MiniLM-L6-cos-v5')<br/>index_name = "msmarco-demo"<br/><br/>for batch_info in collection_iterator(batch_size=256, shard_id=0, shard_num=1):<br/>    embeddings = encoder.encode(batch_info['text'], 512)<br/>    batch_info["dense_vectors"] = embeddings<br/><br/>    actions = []<br/>    for i in range(len(batch_info['id'])):<br/>        action = {"index": {"_index": index_name, "_id": batch_info['id'][i]}}<br/>        doc = {<br/>                "title": batch_info['title'][i],<br/>                "text": batch_info['text'][i],<br/>                "embeddings": batch_info['dense_vectors'][i].tolist()<br/>            }<br/>        actions.append(action)<br/>        actions.append(doc)<br/>    <br/>    es_client.bulk(index=index_name, operations=actions)<br/><br/>result = es_client.count(index=index_name)<br/><br/>#print the total number of documents in the index<br/>print(result.body['count'])<br/>#8841823<br/><br/>#output one document<br/>print(es_client.get(index=["msmarco-demo"], id="0", request_timeout=60))<br/><br/>'''<br/>{'_index': 'msmarco-demo', '_id': '0', '_version': 2, '_seq_no': 27, '_primary_term': 1, 'found': True, <br/>'_source': {'title': '', <br/>'text': 'The presence of communication amid scientific minds was equally important to the success of the Manhattan Project as scientific intellect was. The only cloud hanging over the impressive achievement of the atomic researchers and engineers is what their success truly meant; hundreds of thousands of innocent lives obliterated.', <br/>'embeddings': [-0.032267116010189056, 0.05750396102666855,...]}}<br/>'''</span></pre><p id="8489" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ç°åœ¨ç´¢å¼•å·²ç»å®Œæˆï¼Œæˆ‘ä»¬å¯ä»¥æœç´¢æˆ‘ä»¬çš„ç´¢å¼•ã€‚Elasticsearchæä¾›äº†ä¸€ä¸ª<a class="ae kv" href="https://elasticsearch-py.readthedocs.io/en/latest/api.html#elasticsearch.Elasticsearch.knn_search" rel="noopener ugc nofollow" target="_blank"> pythonåŒ…è£…å™¨æ¥æ‰§è¡ŒKNNæœç´¢</a>ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬åœ¨ä¸‹é¢ä»£ç ç‰‡æ®µä¸­å®šä¹‰çš„æœç´¢ä»£ç å‡½æ•°ä¸­ä½¿ç”¨çš„ã€‚ä¸ºäº†è¿›è¡Œæœç´¢ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å‚æ•°<code class="fe nh ni nj mt b">k</code>å’Œ<code class="fe nh ni nj mt b">query_vector</code>ä¸­çš„æŸ¥è¯¢åµŒå…¥æ¥å®šä¹‰æœç´¢é›†ç¾¤çš„æ•°é‡ã€‚</p><pre class="kg kh ki kj gt ms mt mu bn mv mw bi"><span id="a89f" class="mx ma iq mt b be my mz l na nb">def search(query: str, es_client: Elasticsearch, model: str, index: str, top_k: int = 10):<br/><br/>    encoder = Encoder(model)<br/>    query_vector = encoder.encode(query, max_length=64)<br/>    query_dict = {<br/>        "field": "embeddings",<br/>        "query_vector": query_vector[0].tolist(),<br/>        "k": 10,<br/>        "num_candidates": top_k<br/>    }<br/>    res = es_client.knn_search(index=index, knn=query_dict, source=["title", "text", "id"])<br/><br/>    for hit in res["hits"]["hits"]:<br/>        print(hit)<br/>        print(f"Document ID: {hit['_id']}")<br/>        print(f"Document Title: {hit['_source']['title']}")<br/>        print(f"Document Text: {hit['_source']['text']}")<br/>        print("=======================================================\n")<br/><br/><br/>if __name__ == "__main__":<br/><br/>  search(query="What is the capital of France?", <br/>         es_client=es_client, <br/>         model="sentence-transformers/msmarco-MiniLM-L6-cos-v5", <br/>         index=index_name)<br/>#output<br/>"""<br/>{'_index': 'msmarco-demo', '_id': '82390', '_score': 0.81541693, '_source': {'text': "In terms of total household wealth, France is the wealthiest nation in Europe and fourth in the world. It also possesses the world's second-largest exclusive economic zone (EEZ), covering 11,035,000 square kilometres (4,261,000 sq mi).", 'title': ''}}<br/>Document ID: 82390<br/>Document Title: <br/>Document Text: In terms of total household wealth, France is the wealthiest nation in Europe and fourth in the world. It also possesses the world's second-largest exclusive economic zone (EEZ), covering 11,035,000 square kilometres (4,261,000 sq mi).<br/>=====================================================================<br/><br/>{'_index': 'msmarco-demo', '_id': '162291', '_score': 0.80739325, '_source': {'text': 'Paris in France lies on the Seine River. The docking location is Port de Grenelle/Quai de Grenelle. As one of the largest cities in Europe, finding a property that suit your budget is not a problem. Choose between low cost guest rooms to luxury 4 and 5 star hotels and apartments to rent.', 'title': ''}}<br/>Document ID: 162291<br/>Document Title: <br/>Document Text: Paris in France lies on the Seine River. The docking location is Port de Grenelle/Quai de Grenelle. As one of the largest cities in Europe, finding a property that suit your budget is not a problem. Choose between low cost guest rooms to luxury 4 and 5 star hotels and apartments to rent.<br/>=====================================================================<br/>"""</span></pre><p id="4422" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å‘é‡æœç´¢ç°åœ¨æ˜¯æœºå™¨å­¦ä¹ ä¸­çš„ä¸€ä¸ªæ—¶é«¦é¢†åŸŸï¼Œæœ‰å¾ˆå¤šå…¶ä»–å¾ˆæ£’çš„åº“æä¾›å‘é‡æœç´¢åŠŸèƒ½ï¼Œå¦‚<a class="ae kv" href="https://www.pinecone.io/" rel="noopener ugc nofollow" target="_blank">æ¾æœ</a>ã€<a class="ae kv" href="https://jina.ai/" rel="noopener ugc nofollow" target="_blank">çºªå¨œAI </a>ã€<a class="ae kv" href="https://weaviate.io/" rel="noopener ugc nofollow" target="_blank"> Weaviate </a>ã€<a class="ae kv" href="https://qdrant.tech/" rel="noopener ugc nofollow" target="_blank"> Qdrant </a>ç­‰ã€‚</p><p id="ecd0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ç§å•Šã€‚ç”¨Github Copilotå¼€å‘è¿™ä¸ªå¾ˆæœ‰è¶£ã€‚è¦ç¦»çº¿ç´¢å¼•å’Œæœç´¢ï¼Œè¯·ä¸è¦çŠ¹è±«ï¼Œæ¥çœ‹çœ‹æˆ‘ä»¬ä»¤äººæ•¬ç•çš„å›¾ä¹¦é¦†<a class="ae kv" href="https://github.com/castorini/pyserini" rel="noopener ugc nofollow" target="_blank"> Pyserini </a>ã€‚Pyseriniä¸»è¦è®¾è®¡ç”¨äºåœ¨å¤šçº§æ’åæ¶æ„ä¸­æä¾›æœ‰æ•ˆçš„ã€å¯é‡å¤çš„ã€æ˜“äºä½¿ç”¨çš„ç¬¬ä¸€çº§æ£€ç´¢ã€‚</p><p id="a4ac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">è¿™ä¸ªæ•™ç¨‹çš„å®Œæ•´ä»£ç å¯ä»¥åœ¨<a class="ae kv" href="https://gist.github.com/ToluClassics/bc4bbd8b7930ee35e237984c2c9998a1" rel="noopener ugc nofollow" target="_blank">è¿™é‡Œ</a>æ‰¾åˆ°ã€‚</p><h1 id="3731" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">å‚è€ƒ</h1><ol class=""><li id="3dc6" class="nk nl iq ky b kz nc lc nd lf nm lj nn ln no lr np nq nr ns bi translated"><a class="ae kv" href="https://towardsdatascience.com/how-to-index-elasticsearch-documents-with-the-bulk-api-in-python-b5bb01ed3824" rel="noopener" target="_blank">https://towards data science . com/how-to-index-elastic search-documents-with-the-bulk-API-in-python-b5 bb 01 ed 3824</a></li><li id="cc9c" class="nk nl iq ky b kz nt lc nu lf nv lj nw ln nx lr np nq nr ns bi translated"><a class="ae kv" href="https://www.elastic.co/" rel="noopener ugc nofollow" target="_blank">https://www.elastic.co/</a></li></ol></div></div>    
</body>
</html>