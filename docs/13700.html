<html>
<head>
<title>Deploying a Pretrained Stable Diffusion Model in AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">åœ¨AWS Lambdaä¸­éƒ¨ç½²é¢„è®­ç»ƒçš„ç¨³å®šæ‰©æ•£æ¨¡å‹</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://betterprogramming.pub/deploying-a-pre-trained-stable-diffusion-model-in-aws-lambda-4a9799cb7113?source=collection_archive---------2-----------------------#2022-09-18">https://betterprogramming.pub/deploying-a-pre-trained-stable-diffusion-model-in-aws-lambda-4a9799cb7113?source=collection_archive---------2-----------------------#2022-09-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a5a6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">éƒ¨ç½²äººå·¥æ™ºèƒ½ç”Ÿæˆå™¨æ¨¡å‹çš„è®¾ç½®æŒ‡å—</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0f0c358b36d1346365e98eca1e68d34c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*M8pq4-qKJVYUcPfy"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>ä¸Š<a class="ae kv" href="https://unsplash.com/@wickedmonday?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">é‚ªæ¶æ˜ŸæœŸä¸€</a>çš„ç…§ç‰‡</p></figure><p id="2da6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†æè¿°å¦‚ä½•åœ¨AWS Lambdaä¸Šéƒ¨ç½²ä¸€ä¸ªç¨³å®šçš„æ‰©æ•£(ç¥ç»ç½‘ç»œ)æ¨¡å‹ï¼Œä½¿ç”¨ä¸€ä¸ªé¢„è®­ç»ƒçš„æ¨¡å‹ä½œä¸ºåŸºç¡€ï¼Œç‰¹åˆ«æ˜¯ä¸€ä¸ªé¢„å…ˆå…·æœ‰æƒé‡å’Œæ¨ç†ä»£ç çš„æ¨¡å‹ã€‚</p><p id="a53a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">åŸºç¡€ä»£ç ä½¿ç”¨<a class="ae kv" href="https://www.intel.com/content/www/us/en/developer/tools/openvino-toolkit/overview.html" rel="noopener ugc nofollow" target="_blank"> Openvino </a>æ¥äº§ç”Ÿä¸€ä¸ªé«˜åº¦CPUä¼˜åŒ–ç‰ˆæœ¬çš„ç¨³å®šæ‰©æ•£ã€‚</p><p id="9a61" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">è¿™ä¸ªæ¡†æ¶å¯¹äºEdgeå’Œç‰©è”ç½‘ç”¨ä¾‹ç‰¹åˆ«æœ‰ç”¨ï¼Œä½†åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®Œå…¨ä¸åŒçš„ä¸œè¥¿â€”â€”æˆ‘ä»¬å°†éƒ¨ç½²ä¸€ä¸ªçœŸæ­£å¤§çš„æ¨¡å‹(å¤§çº¦3 GBï¼Œå¹¶åœ¨AWS Lambdaä¸ŠæˆåŠŸæ‰§è¡Œ)ã€‚</p><p id="b843" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æˆ‘ä¸ä¼šæ•™ä»»ä½•å…³äºopenvinoçš„ä¸œè¥¿ï¼Œå› ä¸ºæˆ‘å¯¹å®ƒä¸ç†Ÿæ‚‰ã€‚äº‹å®ä¸Šï¼Œæˆ‘å‡ ä¹åªæ˜¯ä½¿ç”¨äº†ä¸€ä¸ªå¼€æºåº“ä½œä¸ºåŸºç¡€ã€‚</p><p id="21c7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ç›¸åï¼Œæˆ‘å°†é›†ä¸­ç²¾åŠ›æŠŠå®ƒéƒ¨ç½²åœ¨AWS Lambdaä¸Šã€‚</p><p id="3cb9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ‰€æè¿°çš„æ–¹æ³•åº”è¯¥ä¸ç®¡åº•å±‚æ¡†æ¶(æ‹¥æŠ±è„¸ã€PyTorchç­‰)å¦‚ä½•éƒ½å¯ä»¥å·¥ä½œã€‚)ï¼Œæ‰€ä»¥å¦‚æœæ‚¨æƒ³åœ¨ä¸€ä¸ªæ— æœåŠ¡å™¨çš„HTTPç«¯ç‚¹ä¸Šæ‰§è¡Œæ¨ç†ï¼Œäº†è§£å®ƒæ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</p><p id="a65d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">è¿™ä¸ªå°æ•…äº‹åˆ†ä¸º:</p><ol class=""><li id="27ee" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">ç®€è¦èƒŒæ™¯</li><li id="4343" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">åœ¨AWS Lambdaä¸Šéƒ¨ç½²å®ƒçš„åˆ†æ­¥æŒ‡å—</li><li id="8a56" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">æˆ‘çŠ¯çš„æ„šè ¢çš„é”™è¯¯</li></ol><h1 id="b1b1" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">å…³äºç¨³å®šæ‰©æ•£çš„ä¸€äº›èƒŒæ™¯</h1><p id="c7c3" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">ä½†æ˜¯åœ¨æˆ‘ä»¬å¼€å§‹ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹æˆ‘ä»¬æ­£åœ¨åšçš„äº‹æƒ…çš„èƒŒæ™¯ã€‚ä½ å¯èƒ½å¬è¯´è¿‡äººå·¥æ™ºèƒ½ç”Ÿæˆçš„å›¾åƒåŠå…¶æœ€è¿‘çš„ç¨³å®šæ‰©æ•£çƒ­æ½®ã€‚å¦‚æœæ²¡æœ‰ï¼Œå¦‚æœä½ å¯¹è¿™ä¸ªè¯é¢˜æ„Ÿå…´è¶£ï¼Œä½ å¯èƒ½ä¼šæƒ³çœ‹çœ‹ã€Šæ‹¥æŠ±è„¸ã€‹å…³äºè¿™ä¸ªè¯é¢˜çš„ç²¾å½©åšå®¢:<a class="ae kv" href="https://huggingface.co/blog/stable_diffusion" rel="noopener ugc nofollow" target="_blank">https://huggingface.co/blog/stable_diffusion</a>ã€‚</p><p id="a696" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">è¿™æ˜¯æˆ‘ç”¨ç¨³å®šæ‰©æ•£ç”Ÿæˆçš„ä¸€åªå¤ªç©ºçŒ«çš„æ ·æœ¬å›¾ç‰‡:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/02e83fc522244364161ab023c9d9a803.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*ahDKvCznzEzQO18_nFXMKg.jpeg"/></div></figure><p id="c910" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ‰§è¡Œè¿™ä¸ªç¥ç»ç½‘ç»œæ¥ç”Ÿæˆå›¾åƒéœ€è¦å¤§é‡çš„GPUèƒ½åŠ›ï¼Œå°½ç®¡è¯¥æ¨¡å‹æ­£åœ¨éšç€æ—¶é—´çš„æ¨ç§»è€Œä¼˜åŒ–ï¼Œå¹¶ä¸”éšç€æ—¶é—´çš„æ¨ç§»ï¼Œå¯¹äºä»»ä½•æ‹¥æœ‰ç°ä»£å°å¼æœºæˆ–ç¬”è®°æœ¬ç”µè„‘çš„æœ€ç»ˆç”¨æˆ·æ¥è¯´ï¼Œåº”è¯¥å˜å¾—æ›´å®¹æ˜“ä½¿ç”¨ã€‚</p><p id="4fcd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å› ä¸ºç¨³å®šæ‰©æ•£æ¨¡å‹æ˜¯å¼€æºçš„ï¼Œä¸åŒçš„äººä¹Ÿä¸€ç›´è‡´åŠ›äºæä¾›ä¼˜åŒ–çš„æ›¿ä»£æ–¹æ¡ˆ:ä¸ºMacBook M1èŠ¯ç‰‡ä¼˜åŒ–å®ƒï¼Œä¸ºè‹±ç‰¹å°”èŠ¯ç‰‡ä¼˜åŒ–å®ƒï¼Œç­‰ç­‰ã€‚</p><p id="aaa4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">é€šå¸¸ï¼Œæ‰€éœ€çš„æ—¶é—´åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºå®é™…çš„ç¡¬ä»¶ã€‚æˆ‘é’ˆå¯¹ä¸åŒç±»å‹çš„å¤„ç†å™¨æå–äº†ä»¥ä¸‹è®¡ç®—è¿‘ä¼¼å€¼(ä½¿ç”¨RTX 3090å’Œi9åœ¨æœ¬åœ°è¿›è¡Œäº†æµ‹è¯•ï¼Œå¹¶ä¸”åªåœ¨ç½‘ä¸Šé˜…è¯»äº†M1çš„ç›¸å…³èµ„æ–™):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/b54d96b3f05709b38da0fa5efef0b91a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x0ZONq9b8DAPXtXf8mMbCQ.png"/></div></div></figure><p id="9118" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¦‚æ‚¨æ‰€è§ï¼Œå½“åœ¨<code class="fe nf ng nh ni b">i9</code>ä¸Šæ‰§è¡Œæ—¶ï¼ŒOpenvinoè§£å†³æ–¹æ¡ˆä¸å…¶ä»–è§£å†³æ–¹æ¡ˆç›¸æ¯”æ…¢å¾—ä»¤äººç—›è‹¦ã€‚</p><p id="6dd8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ç”±HuggingFaceæä¾›çš„ONNXç‰ˆæœ¬(åœ¨ç”¨<code class="fe nf ng nh ni b">onnx simplifier</code>(ã€https://github.com/daquexian/onnx-simplifierã€‘)å¯¹å…¶è¿›è¡Œä¼˜åŒ–åï¼Œå®ƒå…·æœ‰ç›¸ä¼¼çš„è®¡ç®—æ—¶é—´)ã€‚</p><p id="a9b6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">æ³¨</strong>:ç®€åŒ–å™¨éœ€è¦å¤§çº¦27GBå†…å­˜æ¥ç®€åŒ–è¿™ä¸ªæ¨¡å‹ã€‚æˆ‘æ€€ç–‘å¦‚æœæˆ‘ä½¿ç”¨ONNXç‰ˆæœ¬ï¼Œæœ€ç»ˆçš„ç»“æœä¼šæ˜¯ç›¸ä¼¼çš„ã€‚</p><p id="b62e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å°½ç®¡CPUæ¨ç†å¾ˆæ…¢ï¼Œä½†æœ‰è¶£çš„æ˜¯å®ƒå¯ä»¥åœ¨AWS Lambdaä¸­æ‰§è¡Œï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥ç”¨äºå…è´¹è¯•ç”¨/æ¼”ç¤ºï¼Œå› ä¸ºæœ‰å¤§é‡çš„AWS Lambdaå…è´¹å±‚ã€‚æˆ‘æ­£åœ¨æ„å»ºç±»ä¼¼çš„ä¸œè¥¿ï¼Œä¾‹å¦‚ï¼Œæˆ‘åœ¨<a class="ae kv" href="https://app.openimagegenius.com/" rel="noopener ugc nofollow" target="_blank">https://app.openimagegenius.com</a>ä¸‹å‘å¸ƒçš„å…è´¹ç©å…·äº§å“ã€‚</p><p id="2d29" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¦‚æœä½ æƒ³å°è¯•ä¸€ä¸‹ï¼Œä¸€å®šè¦æœ‰è€å¿ƒï¼Œç­‰å¾…äº”åˆ†é’Ÿå›¾åƒç”Ÿæˆã€‚Lambdaåªä½¿ç”¨äº†12ä¸ªæ¨ç†æ­¥éª¤æ¥åŠ é€Ÿ(ä¸€æ—¦Lambdaå˜çƒ­ï¼Œå¤§çº¦éœ€è¦60ç§’çš„æ‰§è¡Œæ—¶é—´)ã€‚</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/1cc64254577f7f02707e9d91be4727bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H5hNy_pHJsAioFd9oMI4fQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">ä¸ºæˆ‘5å²çš„å„¿å­åˆ¶é€ é‡‘è‰²çš„æœºå™¨çŒ«</p></figure><p id="cbaf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">è¿™ä¸ªä¾‹å­çš„æºä»£ç å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ã€‚ä½ å¯ä»¥éšæ„ä½¿ç”¨å®ƒï¼Œä¸éœ€è¦å¾å¾—æˆ‘çš„åŒæ„(è¿™æ˜¯éº»çœç†å·¥å­¦é™¢çš„è®¸å¯)ã€‚è¯·è®°ä½æ¨¡ç‰¹çš„æ‰§ç…§ã€‚</p><p id="9b64" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://github.com/paolorechia/openimagegenius/tree/main/serverless/stable-diffusion-open-vino-engine" rel="noopener ugc nofollow" target="_blank">https://github . com/paolorechia/open image genius/tree/main/server less/stable-diffusion-open-vino-engine</a></p><p id="05f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">èŠå¤Ÿäº†ã€‚è®©æˆ‘ä»¬å¼€å§‹è§£å†³é—®é¢˜å§ã€‚</p><h1 id="55fe" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">æ— æœåŠ¡å™¨èƒ¶æ°´</h1><p id="ab49" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">(å·¥ä½œç‰ˆæœ¬:åŸºäºå®¹å™¨çš„Lambdaå’ŒEFSğŸ‰)</p><h1 id="f15d" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">æ‰‹åŠ¨éƒ¨åˆ†</h1><p id="41ce" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">ä¸å¹¸çš„æ˜¯ï¼Œè¿™é‡Œæœ‰è®¸å¤šæ‰‹åŠ¨æ­¥éª¤ã€‚è™½ç„¶å¯ä»¥è‡ªåŠ¨å®Œæˆå…¶ä¸­çš„å¤§éƒ¨åˆ†å·¥ä½œï¼Œä½†æˆ‘è®¤ä¸ºæŠ•å…¥è¿™ä¹ˆå¤šæ—¶é—´æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚ç²¾é€šé€ äº‘æˆ–åœ°å½¢çš„äººå¯èƒ½ä¼šè‡ªåŠ¨å®Œæˆè¿™äº›æ­¥éª¤ä¸­çš„å¤§éƒ¨åˆ†(å¦‚æœä¸æ˜¯å…¨éƒ¨)ã€‚</p><p id="256d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¦‚æœä½ è¯•å›¾éµå¾ªè¿™äº›æ­¥éª¤ï¼Œå´é‡åˆ°äº†å›°éš¾ï¼Œä¸è¦çŠ¹è±«ï¼Œè¯·è”ç³»æˆ‘ï¼Œæˆ‘å¾ˆä¹æ„å¸®åŠ©ä½ ã€‚</p><h2 id="6f24" class="nk mh iq bd mi nl nm dn mm nn no dp mq lf np nq ms lj nr ns mu ln nt nu mw nv bi translated"><strong class="ak">è®©æˆ‘ä»¬ä»VPCå’ŒEC2å¼€å§‹</strong></h2><ol class=""><li id="362a" class="ls lt iq ky b kz my lc mz lf nw lj nx ln ny lr lx ly lz ma bi translated">åˆ›å»ºä¸€ä¸ªVPCæˆ–ä½¿ç”¨é»˜è®¤çš„ã€‚å“ªç§æ–¹å¼éƒ½å¯ä»¥ã€‚</li><li id="2a49" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">åˆ›å»ºä¸€ä¸ªè¿æ¥åˆ°æ­¤VPCçš„EC2å®ä¾‹ï¼Œå¹¶æœ€å¥½å°†å…¶éƒ¨ç½²åˆ°å…¬å…±å­ç½‘ã€‚æ‚¨éœ€è¦é€šè¿‡SSHè¿æ¥åˆ°å®ä¾‹ï¼Œå½“æ‚¨ä½¿ç”¨å…¬å…±å­ç½‘æ—¶ï¼Œè¿™è¦å®¹æ˜“å¾—å¤šã€‚</li><li id="7dc7" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">åˆ›å»ºæ–°çš„å®‰å…¨å­ç»„æˆ–ä¿®æ”¹æ‚¨ä½¿ç”¨çš„å®‰å…¨å­ç»„ã€‚æ‚¨éœ€è¦åœ¨å…¥å£æ‰“å¼€ç«¯å£22å’Œ2049ã€‚</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/ec757e25b3b63846eb9540e83f95dd35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*odaEmwvjW1_Lk2Oo"/></div></div></figure><h2 id="340e" class="nk mh iq bd mi nl nm dn mm nn no dp mq lf np nq ms lj nr ns mu ln nt nu mw nv bi translated"><strong class="ak">ç°åœ¨çš„EFS </strong></h2><ol class=""><li id="0fc8" class="ls lt iq ky b kz my lc mz lf nw lj nx ln ny lr lx ly lz ma bi translated">åˆ›å»ºEFSã€‚ç¡®ä¿å®ƒåœ¨EC2å®ä¾‹è®¾ç½®çš„ç›¸åŒå­ç½‘ä¸­å¯ç”¨ï¼Œå¹¶ä½¿ç”¨æ‚¨å®šä¹‰çš„ç›¸åŒå®‰å…¨ç»„ã€‚</li><li id="7907" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">SSHåˆ°æ‚¨çš„EC2å®ä¾‹ã€‚</li><li id="8220" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">éµå¾ªAWSæŒ‡å—ï¼Œäº†è§£å¦‚ä½•åœ¨EC2:<a class="ae kv" href="https://docs.aws.amazon.com/efs/latest/ug/wt1-test.html" rel="noopener ugc nofollow" target="_blank">https://docs.aws.amazon.com/efs/latest/ug/wt1-test.html</a>ä¸­å®‰è£…EFS</li><li id="3f32" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">æ€»ä¹‹ï¼Œæ‚¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤(ä½¿ç”¨ä»AWSæ§åˆ¶å°/ CLIæå–çš„å®é™…è£…è½½æ–‡ä»¶å¤¹å’Œè£…è½½ç›®æ ‡DNS(æ‚¨å¯ä»¥åœ¨EFSæ–‡ä»¶ç³»ç»ŸUIå±å¹•ä¸­æ‰¾åˆ°DNS ),é€‚å½“åœ°ä¿®æ”¹å‚æ•°)</li><li id="0a25" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe nf ng nh ni b">mkdir mnt-folder</code></li><li id="9c97" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe nf ng nh ni b">sudo mount -t nfs -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport mount-target-DNS:/ ~/mnt-folder</code></li><li id="91ca" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">å°†openvinoæ¨¡å‹æ–‡ä»¶ä¿å­˜åˆ°EFSã€‚åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä½¿ç”¨è¿™æ®µä»£ç (<a class="ae kv" href="https://github.com/bes-dev/stable_diffusion.openvino/blob/master/stable_diffusion_engine.py" rel="noopener ugc nofollow" target="_blank">https://github . com/bes-dev/stable _ diffusion . open vino/blob/master/stable _ diffusion _ engine . py</a>)æ‰‹åŠ¨ä¸‹è½½äº†å®ƒä»¬ï¼Œå¹¶åœ¨ä¹‹å‰å°†å®ƒä»¬ä¸Šä¼ åˆ°äº†ä¸€ä¸ªS3æ¡¶ä¸­ã€‚ç„¶ååœ¨æˆ‘çš„EC2å®ä¾‹ä¸­ï¼Œæˆ‘ä»S3æ¡¶ä¸‹è½½åˆ°EFS</li></ol><p id="a0c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">(<strong class="ky ir">æ³¨æ„</strong>:ä¸ºæ­¤ï¼Œæ‚¨å¯èƒ½éœ€è¦ä¸ºæ‚¨çš„EC2åˆ†é…ä¸€ä¸ªè§’è‰²ï¼Œå¦‚ä¸‹é¢çš„å±å¹•æˆªå›¾æ‰€ç¤ºã€‚)</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/c49520f58ffacc07bde1173aa29f1831.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ahN8Oy6aHWMXxg9Q"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/80aef3e270facc0daa59d091a290835c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TPRcJctsNnlcVt4J"/></div></div></figure><p id="84d4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ä¸€æ—¦æ‚¨æ­£ç¡®é…ç½®äº†è§’è‰²ï¼Œaws-cliå°±åº”è¯¥å·¥ä½œäº†ï¼Œä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œåƒ<code class="fe nf ng nh ni b">aws3 sync s3://your-bucket</code>è¿™æ ·çš„å‘½ä»¤ã€‚</p><h2 id="7c41" class="nk mh iq bd mi nl nm dn mm nn no dp mq lf np nq ms lj nr ns mu ln nt nu mw nv bi translated">ç„¶åä¸ºå¼¹æ€§æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºä¸€ä¸ªè®¿é—®ç‚¹</h2><p id="2570" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">ä¸ºæ‚¨é…ç½®çš„å¼¹æ€§æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºä¸€ä¸ªEFSè®¿é—®ç‚¹ã€‚</p><p id="e0cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">è¿™é‡Œéœ€è¦æ³¨æ„å‡ ä»¶äº‹:</p><p id="c3e6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ–‡ä»¶ç³»ç»Ÿç”¨æˆ·æƒé™â€”â€”å¦‚æœå®ƒä»¬å¤ªä¸¥æ ¼ï¼Œå½“ä»Lambdaè®¿é—®EFSæ–‡ä»¶æ—¶ï¼Œæ‚¨å°†å¾—åˆ°<code class="fe nf ng nh ni b">PermissionError</code>ã€‚åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œè¿™ä¸ªEFSä¸“ç”¨äºè¿™ä¸ªLambdaï¼Œæ‰€ä»¥æˆ‘ä¸å…³å¿ƒç²’åº¦ï¼Œåªæä¾›å®Œå…¨å¼€æ”¾çš„è®¿é—®(æˆ‘ç¨åå°†åœ¨æ— æœåŠ¡å™¨æ–‡ä»¶ä¸­åšåŒæ ·çš„äº‹æƒ…):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/3e2c352eed53b5706dcb19414869247a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Cmx5YnB9Ng-rPG5u"/></div></div></figure><p id="3204" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ­¤å¤–ï¼Œé¿å…å°†<code class="fe nf ng nh ni b">/</code> <strong class="ky ir"> </strong>åˆ†é…åˆ°æ‚¨ä¸ºè®¿é—®ç‚¹å®šä¹‰çš„æ ¹ç›®å½•è·¯å¾„ï¼Œè¿™å¯èƒ½ä¼šåœ¨æŒ‚è½½æ—¶å¯¼è‡´é—®é¢˜ã€‚æ­¤å¤–ï¼Œè¯·åŠ¡å¿…è®°ä¸‹æ‚¨é€‰æ‹©çš„å€¼ã€‚ä½ éœ€è¦åœ¨Lambdaå‡½æ•°ä¸­ä½¿ç”¨å®ƒã€‚æˆ‘ä¸ªäººç”¨è¿‡:<code class="fe nf ng nh ni b">/mnt/fs</code>ï¼Œåœ¨å¦ä¸€ä¸ªæŒ‡å—ä¸­æœ‰æè¿°ã€‚</p><p id="eecb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¥½äº†ï¼Œæˆ‘ä»¬å·²ç»å·®ä¸å¤šå®Œæˆäº†æ‰‹åŠ¨åˆ›å»ºèµ„æºçš„å·¥ä½œã€‚</p><h1 id="fa35" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">æ— æœåŠ¡å™¨æ¡†æ¶</h1><p id="b7db" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">æˆ‘ä»<a class="ae kv" href="https://medium.com/swlh/mount-your-aws-efs-volume-into-aws-lambda-with-the-serverless-framework-470b1c6b1b2d" rel="noopener">https://medium . com/swlh/mount-your-AWS-EFS-volume-into-AWS-lambda-with-the-server less-framework-470 B1 c 6 B1 b 2</a>dæ”¶é›†çš„å…³äºEFSéƒ¨åˆ†çš„æ— æœåŠ¡å™¨æ¨¡æ¿çš„å¤§éƒ¨åˆ†ç¹é‡å·¥ä½œ</p><p id="0a8c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">è¿™æ˜¯å®Œæ•´çš„æ¨¡æ¿ã€‚æ‚¨å‡ ä¹å¿…é¡»æ›¿æ¢è‡ªå·±çš„èµ„æºidã€‚</p><pre class="kg kh ki kj gt oc ni od bn oe of bi"><span id="553a" class="og mh iq ni b be oh oi l oj ok">service: stable-diffusion-open-vino<br/>frameworkVersion: "3"<br/>provider:<br/>  name: aws<br/>  runtime: python3.8<br/>  stage: ${opt:stage}<br/>  region: eu-central-1<br/>  memorySize: 10240<br/>  iam:<br/>    role:<br/>      statements:<br/>        - Effect: Allow<br/>          Action:<br/>            - "elasticfilesystem:*"<br/>          Resource:<br/>            - "arn:aws:elasticfilesystem:${aws:region}:${aws:accountId}:file-system/${self:custom.fileSystemId}"<br/>            - "arn:aws:elasticfilesystem:${aws:region}:${aws:accountId}:access-point/${self:custom.efsAccessPoint}"<br/>functions:<br/>  textToImg:<br/>    url: true<br/>    image:<br/>      name: appimage<br/>    timeout: 300<br/>    environment:<br/>      MNT_DIR: ${self:custom.LocalMountPath}<br/>    vpc:<br/>      securityGroupIds:<br/>        - ${self:custom.securityGroup}<br/>      subnetIds:<br/>        - ${self:custom.subnetsId.subnet0}<br/>custom:<br/>  efsAccessPoint: YOUR_ACCESS_POINT_ID<br/>  fileSystemId: YOUR_FS_ID<br/>  LocalMountPath: /mnt/fs<br/>  subnetsId:<br/>    subnet0: YOUR_SUBNET_ID<br/>  securityGroup: YOUR_SECURITY_GROUP<br/>resources:<br/>  extensions:<br/>    TextToImgLambdaFunction:<br/>      Properties:<br/>        FileSystemConfigs:<br/>          - Arn: "arn:aws:elasticfilesystem:${self:provider.region}:${aws:accountId}:access-point/${self:custom.efsAccessPoint}"<br/>            LocalMountPath: "${self:custom.LocalMountPath}"</span></pre><p id="8d56" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å€¼å¾—ä¸€æçš„å‡ ä¸ªéƒ¨åˆ†:</p><p id="3913" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å†…å­˜å¤§å°:é»˜è®¤æƒ…å†µä¸‹ï¼Œä½ ä¸èƒ½ä½¿ç”¨10GBçš„å†…å­˜ã€‚æ‚¨éœ€è¦å‘AWSå¼€ä¸€ä¸ªç¥¨è¯æ¥æ”¯æŒæ­¤ç”¨ä¾‹ã€‚è¯·æ³¨æ„ï¼Œæ‚¨ä¸ä¼šæ‰¾åˆ°æ­¤è¯·æ±‚çš„å…·ä½“æ¡ˆä¾‹ã€‚æˆ‘è¯·æ±‚å¢åŠ Lambdaå­˜å‚¨ï¼Œå¹¶è§£é‡Šè¯´æˆ‘éœ€è¦æ›´å¤šå†…å­˜ã€‚AWSèŠ±äº†å‡ å¤©æ—¶é—´æ‰æ¥å—å®ƒã€‚</p><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="8cfc" class="nk mh iq ni b gy oo op l oq ok">memorySize: 10240</span></pre><p id="e6fc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å‡½æ•°URL:è¿™ä¸€è¡Œ<code class="fe nf ng nh ni b">url: true</code>å…è®¸ä¸€ä¸ªå…¬å…±URLè°ƒç”¨æ‚¨çš„å‡½æ•°ï¼Œä¸»è¦ç”¨äºå¼€å‘/è°ƒè¯•ç›®çš„ã€‚</p><h2 id="b81c" class="nk mh iq bd mi nl nm dn mm nn no dp mq lf np nq ms lj nr ns mu ln nt nu mw nv bi translated"><strong class="ak">ç å¤´å·¥äººé›†è£…ç®±å»ºé€ æ¨¡å¼</strong></h2><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="42f6" class="nk mh iq ni b gy oo op l oq ok">provider:<br/>	...<br/>  ecr:<br/>    images:<br/>      appimage:<br/>        path: ./</span><span id="4088" class="nk mh iq ni b gy or op l oq ok">...</span><span id="95bf" class="nk mh iq ni b gy or op l oq ok">functions:<br/>  textToImg:<br/>    url: true<br/>    image:<br/>      name: appimage<br/>    timeout: 300</span></pre><p id="4d8e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ— æœåŠ¡å™¨æ¡†æ¶åœ¨è¿™é‡Œä¸ºæ‚¨åšäº†å¾ˆå¤š:ä»…è¿™äº›å—å°±å°†:</p><ol class=""><li id="151e" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">åˆ›å»ºç§æœ‰ECRå­˜å‚¨åº“</li><li id="6a82" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">ä½¿ç”¨æœ¬åœ°dockeræ–‡ä»¶æ¥æ„å»ºæ‚¨çš„å®¹å™¨</li><li id="0b2b" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">ç»™å›¾åƒåŠ æ ‡ç­¾</li><li id="f0a1" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">å°†å…¶æ¨é€åˆ°ç§æœ‰ECRå­˜å‚¨åº“</li><li id="da14" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">åˆ›å»ºä¸€ä¸ªLambdaå‡½æ•°ï¼Œè¯¥å‡½æ•°ä½¿ç”¨åˆšåˆšåˆ›å»ºçš„dockerå›¾åƒ</li></ol><p id="162c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">è¯è™½å¦‚æ­¤ï¼Œè¿˜æ˜¯è¦åšå¥½å‡†å¤‡ã€‚ä¸åŸç”ŸAWS Lambdaç›¸æ¯”ï¼Œæˆ‘ä»¬çš„æ„å»º/éƒ¨ç½²å°†èŠ±è´¹ç›¸å½“å¤šçš„æ—¶é—´ã€‚</p><p id="a12a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ä¸‹é¢æ˜¯æˆ‘ç”¨è¿‡çš„Dockerfileæ–‡ä»¶:</p><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="1604" class="nk mh iq ni b gy oo op l oq ok">FROM python:3.9.9-bullseye</span><span id="0555" class="nk mh iq ni b gy or op l oq ok">WORKDIR /src</span><span id="f0bd" class="nk mh iq ni b gy or op l oq ok">RUN apt-get update &amp;&amp; \\<br/>    apt-get install -y \\<br/>    libgl1 libglib2.0-0 \\<br/>    g++ \\<br/>    make \\<br/>    cmake \\<br/>    unzip \\<br/>    libcurl4-openssl-dev</span><span id="1c3f" class="nk mh iq ni b gy or op l oq ok">COPY requirements.txt /src/<br/> <br/>RUN pip3 install -r requirements.txt --target /src/<br/>COPY handler.py stable_diffusion_engine.py /src/</span><span id="08ab" class="nk mh iq ni b gy or op l oq ok">ENTRYPOINT [ "/usr/local/bin/python", "-m", "awslambdaric" ]<br/>CMD [ "handler.handler" ]</span></pre><p id="d26c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å®ƒå®‰è£…äº†AWS Lambdaè¿è¡Œæ—¶æ¥å£å’Œæˆ‘ä»¬æ‰§è¡Œç¨³å®šæ‰©æ•£æ‰€éœ€çš„ä¾èµ–é¡¹(openvinoç‰ˆæœ¬)ã€‚</p><p id="376f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">åŒæ ·ï¼Œé¸£è°¢å½’openvinoè§£å†³æ–¹æ¡ˆçš„åŸä½œè€…æ‰€æœ‰:<a class="ae kv" href="https://github.com/bes-dev/stable_diffusion.openvino" rel="noopener ugc nofollow" target="_blank">https://github.com/bes-dev/stable_diffusion.openvino</a>ã€‚</p><p id="5dd5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">åœ¨æ„å»ºdockeræ˜ åƒä¹‹å‰ï¼Œæ‚¨éœ€è¦ä¿®æ”¹<code class="fe nf ng nh ni b">stable_diffusion_engine</code>æ¨¡å—å¹¶è·å¾—Lambdaå¤„ç†ç¨‹åºã€‚ä½ å¯ä»¥ä»æˆ‘çš„ä»“åº“ä¸­æå–æˆ–è€…ä»ä¸Šé¢çš„ä»“åº“ä¸­æ”¹ç¼–ã€‚</p><p id="b614" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¼•æ“æ‰€éœ€çš„ä¸»è¦å˜åŒ–æ˜¯å…³äºå¦‚ä½•åŠ è½½æ¨¡å‹:</p><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="71c9" class="nk mh iq ni b gy oo op l oq ok">        self.tokenizer = CLIPTokenizer.from_pretrained(<br/>             "/mnt/fs/models/clip")</span><span id="3309" class="nk mh iq ni b gy or op l oq ok">				(...)<br/>        self._text_encoder = self.core.read_model(<br/>            "/mnt/fs/models/text_encoder/text_encoder.xml")</span><span id="e396" class="nk mh iq ni b gy or op l oq ok">				(...)<br/>        self._unet = self.core.read_model(<br/>	    "/mnt/fs/models/unet/unet.xml")</span><span id="1dd0" class="nk mh iq ni b gy or op l oq ok">				(...)<br/>        self._vae_decoder = self.core.read_model(<br/>            "/mnt/fs/models/vae_decoder/vae_decoder.xml")</span><span id="1d1c" class="nk mh iq ni b gy or op l oq ok">				(...)<br/>        self._vae_encoder = self.core.read_model(<br/>            "/mnt/fs/models/vae_encoder/vae_encoder.xml")</span></pre><p id="26af" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ç„¶åä½ å¯ä»¥åœ¨æˆ‘çš„å¤„ç†ç¨‹åºä¸­ä½¿ç”¨è¿™ä¸ªæ¨¡å—(å®ƒåªæ˜¯æ”¹ç¼–è‡ªhttps://github.com/bes-dev/stable_diffusion.openvino<a class="ae kv" href="https://github.com/bes-dev/stable_diffusion.openvino" rel="noopener ugc nofollow" target="_blank">çš„<code class="fe nf ng nh ni b">demo.py</code>æ–‡ä»¶):</a></p><pre class="kg kh ki kj gt oc ni od bn oe of bi"><span id="bfa7" class="og mh iq ni b be oh oi l oj ok"># -- coding: utf-8 --`<br/>print("Starting container code...")<br/>from dataclasses import dataclass<br/>import numpy as np<br/>import cv2<br/>from diffusers import LMSDiscreteScheduler, PNDMScheduler<br/>from stable_diffusion_engine import StableDiffusionEngine<br/>import json<br/>import os<br/>@dataclass<br/>class StableDiffusionArguments:<br/>    prompt: str<br/>    num_inference_steps: int<br/>    guidance_scale: float<br/>    models_dir: str<br/>    seed: int = None<br/>    init_image: str = None<br/>    beta_start: float = 0.00085<br/>    beta_end: float = 0.012<br/>    beta_schedule: str = "scaled_linear"<br/>    model: str = "bes-dev/stable-diffusion-v1-4-openvino"<br/>    mask: str = None<br/>    strength: float = 0.5<br/>    eta: float = 0.0<br/>    tokenizer: str = "openai/clip-vit-large-patch14"<br/>def run_sd(args: StableDiffusionArguments):<br/>    if args.seed is not None:<br/>        np.random.seed(args.seed)<br/>    if args.init_image is None:<br/>        scheduler = LMSDiscreteScheduler(<br/>            beta_start=args.beta_start,<br/>            beta_end=args.beta_end,<br/>            beta_schedule=args.beta_schedule,<br/>            tensor_format="np",<br/>        )<br/>    else:<br/>        scheduler = PNDMScheduler(<br/>            beta_start=args.beta_start,<br/>            beta_end=args.beta_end,<br/>            beta_schedule=args.beta_schedule,<br/>            skip_prk_steps=True,<br/>            tensor_format="np",<br/>        )<br/>    engine = StableDiffusionEngine(<br/>        model=args.model, scheduler=scheduler, tokenizer=args.tokenizer, models_dir=args.models_dir<br/>    )<br/>    image = engine(<br/>        prompt=args.prompt,<br/>        init_image=None if args.init_image is None else cv2.imread(<br/>            args.init_image),<br/>        mask=None if args.mask is None else cv2.imread(args.mask, 0),<br/>        strength=args.strength,<br/>        num_inference_steps=args.num_inference_steps,<br/>        guidance_scale=args.guidance_scale,<br/>        eta=args.eta,<br/>    )<br/>    is_success, im_buf_arr = cv2.imencode(".jpg", image)<br/>    if not is_success:<br/>        raise ValueError("Failed to encode image as JPG")<br/>    byte_im = im_buf_arr.tobytes()<br/>    return byte_im<br/>def handler(event, context, models_dir=None):<br/>    print("Getting into handler, event: ", event)<br/>    print("Working dir at handler...", )<br/>    current_dir = os.getcwd()<br/>    print(current_dir)<br/>    print(os.listdir(current_dir))<br/>    print("Listing root")<br/>    print(os.listdir("/"))<br/>    # Get args<br/>    # randomizer params<br/>    body = json.loads(event.get("body"))<br/>    prompt = body["prompt"]<br/>    seed = body.get("seed")<br/>    num_inference_steps: int = int(body.get("num_inference_steps", 32))<br/>    guidance_scale: float = float(body.get("guidance_scale", 7.5))<br/>    args = StableDiffusionArguments(<br/>        prompt=prompt,<br/>        seed=seed,<br/>        num_inference_steps=num_inference_steps,<br/>        guidance_scale=guidance_scale,<br/>        models_dir=models_dir<br/>    )<br/>    print("Parsed args:", args)<br/>    image = run_sd(args)<br/>    print("Image generated")<br/>    body = json.dumps(<br/>        {"message": "wow, no way", "image": image.decode("latin1")})<br/>    return {"statusCode": 200, "body": body}</span></pre><h1 id="0502" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">æµ‹è¯•éƒ¨ç½²</h1><p id="7b5c" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">å½“æ‚¨å®Œæˆéƒ¨ç½²æ—¶ï¼Œæ— æœåŠ¡å™¨æ¡†æ¶åº”è¯¥ä¼šç»™æ‚¨ä¸€ä¸ªURLï¼Œæ‚¨å¯ä»¥è¿™æ ·è°ƒç”¨å®ƒ:</p><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="8508" class="nk mh iq ni b gy oo op l oq ok">curl -X POST \\<br/>https://your_lambda_url_id.lambda-url.eu-central-1.on.aws/ \\<br/>-H 'content-type: application/json' \\<br/>-d '{"prompt": "tree"}'</span></pre><p id="12c5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæ‚¨åº”è¯¥åœ¨äº‘è§‚å¯Ÿæ—¥å¿—ä¸­çœ‹åˆ°å®ƒæ­£åœ¨ç”Ÿæˆä»¥ä¸‹å›¾åƒ:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi os"><img src="../Images/e5a8aa5c67f331e7ee494c30c9e1a4bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:672/0*KC-yo5P6UGVI2bub"/></div></figure><p id="9430" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å½“æˆ‘æµ‹è¯•æ—¶ï¼Œå®ƒåœ¨ä¸»å¾ªç¯ä¸­èŠ±äº†å°†è¿‘3åˆ†é’Ÿï¼Œæ‰§è¡Œå®Œæ•´çš„Lambdaç”¨äº†238ç§’(4åˆ†é’Ÿ)ã€‚</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/4ac20c82d7a02d67633aa9a2cb4e0ee3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vw7JTyRCQwgUDQeD"/></div></div></figure><p id="e32c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ä¸Šé¢çš„å·æ›²ä¼šç»™ä½ ä¸€ä¸ªä¸å¯è¯»çš„å­—ç¬¦ä¸²ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªç¼–ç æˆ<code class="fe nf ng nh ni b">latin1</code>çš„å›¾åƒã€‚å¦‚æœä½ æ‰“ç®—å®é™…ä½¿ç”¨ä½ çš„Lambdaï¼Œä¹Ÿè®¸ä½ ä¼šæƒ³è¦è¿™æ ·çš„ä¸œè¥¿(æˆ‘ç”¨å®ƒæ¥æœ¬åœ°æµ‹è¯•æˆ‘çš„å®¹å™¨ï¼Œæ›¿æ¢URL):</p><pre class="kg kh ki kj gt oc ni od bn oe of bi"><span id="03f6" class="og mh iq ni b be oh oi l oj ok">import requests<br/>import json<br/>headers = {"content-type": "application/json"}<br/>url = "&lt;http://localhost:9000/2015-03-31/functions/function/invocations&gt;"<br/>body = json.dumps({"prompt": "beautiful tree", "num_inference_steps": 1})<br/>response = requests.post(url, json={"body": body}, headers=headers)<br/>response.raise_for_status()<br/>j = response.json()<br/>body = json.loads(j["body"])<br/>bytes_img = body["image"].encode("latin1")<br/>with open("test_result.png", "w+b") as fp:<br/>    fp.write(bytes_img)</span></pre><p id="a1cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å”·ï¼é‚£æ˜¯è®¸å¤šæ­¥éª¤ï¼ç°åœ¨ï¼Œæ‚¨å¯ä»¥å°†æ‚¨çš„ç¨³å®šæ‰©æ•£æ¨¡å‹éƒ¨ç½²åˆ°AWS Lambdaã€‚æˆ‘å¸Œæœ›ä½ å–œæ¬¢é˜…è¯»è¿™ä¸ªç®€çŸ­çš„æ•™ç¨‹ã€‚æˆ‘ä¼šç»™ä½ ç•™ä¸‹ä¸€äº›æˆ‘å°è¯•è¿‡çš„äº‹æƒ…â€”â€”ä½†æ˜¯æ²¡æœ‰æˆåŠŸâ€”â€”æ‰€ä»¥ä¹Ÿè®¸æˆ‘å¯ä»¥è¯´æœä½ ä¸è¦å°è¯•å®ƒä»¬ã€‚</p><h1 id="3e4c" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">é”™è¯¯çš„å†å²</h1><p id="9e7e" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">ä½ æƒ³çŸ¥é“æˆ‘çš„åå¤è¯•éªŒæœ‰å¤šç³Ÿç³•å—ï¼Ÿå—¯ï¼Œæˆ‘ä¸ä»‹æ„åˆ†äº«â€”â€”å¤±è´¥å°±æ˜¯å­¦ä¹ ã€‚</p><h1 id="d850" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">ç¬¬ä¸€æ¬¡å°è¯•:å…¨EFSï¼ŒåŸç”ŸAWS Lambda</h1><p id="c29b" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">æ‰€ä»¥ï¼Œæˆ‘æ›¾å¤šæ¬¡é˜…è¯»åœ¨Lambdaä¸Šéƒ¨ç½²å¤§å‹æ¨¡å‹å¹¶ä½¿ç”¨AWSå¼¹æ€§æ–‡ä»¶ç³»ç»Ÿã€‚æ‰€ä»¥æˆ‘è¿™æ ·åšäº†ã€‚</p><p id="8df3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æˆ‘å·²ç»é…ç½®äº†ä¸€ä¸ªå¸¸è§„çš„AWS Lambdaï¼Œå¹¶å°†å…¶è¿æ¥åˆ°ä¸€ä¸ªEFSã€‚ç„¶è€Œï¼Œå½“æˆ‘æ‰§è¡Œä»£ç æ—¶ï¼Œæˆ‘åœ¨å¯¼å…¥<code class="fe nf ng nh ni b">openvino</code>è¿è¡Œæ—¶:<code class="fe nf ng nh ni b">libm.so.6 not found</code>æ—¶é‡åˆ°äº†ä¸€ä¸ªé”™è¯¯ã€‚</p><p id="f58f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ç»è¿‡ä¸€ç•ªç»å°½è„‘æ±çš„ç ”ç©¶ï¼Œæˆ‘äº†è§£åˆ°AWS Lambdaè¿è¡Œåœ¨Amazon Linuxä¸Šï¼Œæˆ‘å¯èƒ½åº”è¯¥ç›´æ¥åœ¨EC2å®ä¾‹ä¸­æ„å»ºæˆ‘çš„åº“çš„ä¾èµ–é¡¹ã€‚</p><p id="5196" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">é™¤æ­¤ä¹‹å¤–ï¼Œå½“æˆ‘å°è¯•è¿™æ ·åšæ—¶ï¼Œæˆ‘å‘ç°ã€https://pypi.org/project/openvino/ã€‘<a class="ae kv" href="https://pypi.org/project/openvino/" rel="noopener ugc nofollow" target="_blank"/><code class="fe nf ng nh ni b">openvino</code>æ²¡æœ‰é€‚ç”¨äºäºšé©¬é€ŠLinuxçš„è¿è¡Œæ—¶ç‰ˆæœ¬2022ã€‚å•Šå“¦ï¼Œæ­»èƒ¡åŒ</p><h1 id="e319" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">ç¬¬äºŒæ¬¡å°è¯•:æ»¡å®¹å™¨æ¨¡å¼</h1><p id="a439" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">å‡ å¤©åï¼Œåœ¨ä¸ä¸€ä¸ªæœ‹å‹è®¨è®ºäº†ä¸ä½¿ç”¨æ— æœåŠ¡å™¨æŠ€æœ¯ç›¸æ¯”ï¼Œæˆ‘æœ‰å¤šæ€€å¿µä½¿ç”¨dockerä¹‹åï¼Œæˆ‘çªç„¶æƒ³åˆ°:å¦‚æœæˆ‘ä½¿ç”¨Dockeræ˜ åƒæ¥éƒ¨ç½²Lambdaä¼šæ€ä¹ˆæ ·ï¼Ÿ</p><p id="7896" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">äº‹å®è¯æ˜ï¼Œå®¹å™¨å›¾åƒå¤§å°é™åˆ¶æ˜¯10GBï¼Œè¿™æ˜¯ç›¸å½“å¤§çš„é™åˆ¶(<a class="ae kv" href="https://aws.amazon.com/blogs/aws/new-for-aws-lambda-container-image-support/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/AWS/new-for-AWS-lambda-container-image-support/</a>)â€”è¿™å¿…é¡»æœ‰æ•ˆï¼</p><p id="42b2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å—¯ï¼Œæ²¡é‚£ä¹ˆå¿«ã€‚å½“äº‹æƒ…ä¼¼ä¹æ¥è¿‘å·¥ä½œçš„æ—¶å€™ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ã€‚</p><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="7849" class="nk mh iq ni b gy oo op l oq ok">[ERROR] RuntimeError: Model file /src/models/unet/unet.xml cannot be opened!<br/>Traceback (most recent call last):<br/>  File "/src/handler.py", line 129, in handler<br/>    image = run_sd(args)<br/>  File "/src/handler.py", line 76, in run_sd<br/>    engine = StableDiffusionEngine(<br/>  File "/src/stable_diffusion_engine.py", line 59, in __init__<br/>    self._unet = self.core.read_model(unet_xml, unet_bin)</span></pre><p id="5278" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å•Šï¼Ÿæˆ‘ç›¯ç€è¿™ä¸ªé”™è¯¯çœ‹äº†å‡ ä¸ªå°æ—¶ï¼Œè°ƒè¯•æˆ‘çš„ç¯å¢ƒï¼Œç¡®ä¿æ–‡ä»¶å¯ç”¨ï¼Œç­‰ç­‰ã€‚æ ¹æ®OpenVINO APIå‚è€ƒï¼Œå› ä¸º<code class="fe nf ng nh ni b">core.read_model</code>ä¹Ÿå¯ä»¥ç›´æ¥æ¥å—äºŒè¿›åˆ¶æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ç¨å¾®ä¿®æ”¹äº†ä¸€ä¸‹ä»£ç ï¼Œå¹¶å°è¯•æå‰å°†æ¨¡å‹åŠ è½½åˆ°äºŒè¿›åˆ¶ç¼“å†²åŒºçš„å­—å…¸ä¸­ã€‚</p><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="4976" class="nk mh iq ni b gy oo op l oq ok">models = {}<br/>for model in ["text_encoder", "unet", "vae_decoder", "vae_encoder"]:<br/>    with open(f"./models/{model}/{model}.xml", "r+b") as fp:<br/>        models[f"{model}-xml"] = fp.read()<br/>    with open(f"./models/{model}/{model}.bin", "r+b") as fp:<br/>        models[f"{model}-bin"] = fp.read()</span></pre><p id="3b6c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»ç„¶ä¼šé‡åˆ°é”™è¯¯ï¼Œä½†è¿™æ¬¡å®ƒä»¬æ›´æœ‰æ„ä¹‰ã€‚</p><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="b50f" class="nk mh iq ni b gy oo op l oq ok">[ERROR] OSError: [Errno 30] Read-only file system: './models/text_encoder/text_encoder.xml'<br/>Traceback (most recent call last):<br/>  File "/usr/local/lib/python3.9/importlib/__init__.py", line 127, in import_module<br/>    return _bootstrap._gcd_import(name[level:], package, level)<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 1030, in _gcd_import<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 1007, in _find_and_load<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 986, in _find_and_load_unlocked<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 680, in _load_unlocked<br/>  File "&lt;frozen importlib._bootstrap_external&gt;", line 850, in exec_module<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 228, in _call_with_frames_removed<br/>  File "/src/handler.py", line 23, in &lt;module&gt;<br/>    from stable_diffusion_engine import StableDiffusionEngine<br/>  File "/src/stable_diffusion_engine.py", line 30, in &lt;module&gt;<br/>    with open(f"./models/{model}/{model}.xml", "r+b") as fp:</span></pre><p id="c204" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æˆ‘ä»”ç»†æ£€æŸ¥äº†Pythonæ–‡æ¡£ï¼Œæ„è¯†åˆ°<code class="fe nf ng nh ni b">r+b</code>å®é™…ä¸Šæ„å‘³ç€â€œå¼€æ”¾æ›´æ–°(è¯»å†™)â€å¯èƒ½æ–‡ä»¶ç³»ç»Ÿæ˜¯åªè¯»çš„ã€‚è®©æˆ‘ä»¬ä¸ç”¨å®ƒå†è¯•ä¸€æ¬¡ï¼Œåªç”¨<code class="fe nf ng nh ni b">rb</code>ä»£æ›¿:</p><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="397d" class="nk mh iq ni b gy oo op l oq ok">[ERROR] PermissionError: [Errno 13] Permission denied: './models/text_encoder/text_encoder.xml'<br/>Traceback (most recent call last):<br/>  File "/usr/local/lib/python3.9/importlib/__init__.py", line 127, in import_module<br/>    return _bootstrap._gcd_import(name[level:], package, level)<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 1030, in _gcd_import<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 1007, in _find_and_load<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 986, in _find_and_load_unlocked<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 680, in _load_unlocked<br/>  File "&lt;frozen importlib._bootstrap_external&gt;", line 850, in exec_module<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 228, in _call_with_frames_removed<br/>  File "/src/handler.py", line 23, in &lt;module&gt;<br/>    from stable_diffusion_engine import StableDiffusionEngine<br/>  File "/src/stable_diffusion_engine.py", line 30, in &lt;module&gt;<br/>    with open(f"./models/{model}/{model}.xml", "rb") as fp:</span></pre><p id="9a5f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¥½å§ï¼Œä¹Ÿè®¸æˆ‘éœ€è¦å…ˆæŠŠæ–‡ä»¶å¤åˆ¶åˆ°<code class="fe nf ng nh ni b">/tmp</code>ï¼Ÿä¸ï¼Œé‚£åªæ˜¯ç»™äº†æˆ‘åŒæ ·çš„é”™è¯¯ã€‚æˆ‘æä¸æ‡‚å®ƒâ€”â€”åŒæ ·çš„ä»£ç åœ¨æœ¬åœ°å·¥ä½œå¾—å¾ˆå¥½ï¼Œæˆ‘ç”šè‡³ç”¨<a class="ae kv" href="https://github.com/aws/aws-lambda-runtime-interface-emulator" rel="noopener ugc nofollow" target="_blank"> Lambdaè¿è¡Œæ—¶æ¥å£ä»¿çœŸå™¨</a>æµ‹è¯•äº†å®ƒã€‚ä¸€å®šæ˜¯ç¯å¢ƒçš„åŸå› ã€‚</p><p id="3fab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å‡ºäºå®‰å…¨åŸå› ï¼ŒAWSé˜»æ­¢ä»å®¹å™¨æ˜ åƒæ–‡ä»¶è·¯å¾„è¿›è¡ŒäºŒè¿›åˆ¶è¯»å–ã€‚æˆ‘ä¸€ç›´ä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚åˆ‡æ¢åˆ°æ··åˆæ–¹æ³•ï¼Œæ¨¡å‹å­˜å‚¨åœ¨EFSï¼Œä»£ç ä¾èµ–/åº“å­˜å‚¨åœ¨Dockeré•œåƒä¸­ï¼Œå·¥ä½œé¡ºåˆ©ã€‚</p><p id="9aaa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¥½äº†ï¼Œä»Šå¤©å°±åˆ°è¿™é‡Œå§ï¼</p><p id="da12" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æˆ‘å¸Œæœ›ä½ å–œæ¬¢è¯»å®ƒã€‚å¹²æ¯ï¼</p></div></div>    
</body>
</html>