# ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¼‚æ­¥ç”Ÿæˆå™¨ï¼Ÿ

> åŸæ–‡ï¼š<https://betterprogramming.pub/why-would-you-use-async-generators-eabbd24c7ae6>

## è®¨è®ºä¸å¼‚æ­¥ç”Ÿæˆå™¨ç›¸å…³çš„æ¦‚å¿µå’Œç­–ç•¥

![](img/76845eed1c4065744fd6aa28a93cd6dc.png)

ä»Šå¹´ 6 æœˆï¼Œæˆ‘å‚åŠ äº†å‡¯å°”Â·è¾›æ™®æ£®åœ¨é˜¿å§†æ–¯ç‰¹ä¸¹ä¸¾åŠçš„ç ”è®¨ä¼šâ€œ [JavaScript:æœ€è¿‘çš„éƒ¨åˆ†](https://frontendmasters.com/courses/js-recent-parts/)â€ã€‚ææ–™å’Œè¡¨æ¼”éƒ½å¾ˆæ£’ï¼Œå‡¯å°”æ˜¯è¡¨æ¼”å·¥ä½œåŠçš„çœŸæ­£å¤§å¸ˆï¼

æˆ‘æœ€å…´å¥‹çš„ä¸€ä¸ªè¯é¢˜æ˜¯`async generators`ï¼Œå®ƒåœ¨æ´»åŠ¨æ¥è¿‘å°¾å£°æ—¶è¢«æåŠã€‚è§‚ä¼—å‚ä¸è¿›æ¥ï¼Œå¹¶è¢«é—®äº†å‡ ä¸ªå…³äºä½¿ç”¨`async generators`æŠ€æœ¯å¯ä»¥å®ç°çš„ä¸åŒç­–ç•¥å’Œè¿­ä»£é¡ºåºçš„é—®é¢˜ã€‚ä¸ºäº†æ›´å¥½åœ°ç†è§£å®ƒï¼Œæˆ‘å†³å®šå†™ä¸€ç¯‡å…³äºè¿™äº›æ¨¡å¼çš„çŸ­æ–‡ã€‚æˆ‘å°†è§£é‡Šä¸€äº›ä¸`generators`è¯é¢˜ç›¸å…³çš„æ¦‚å¿µï¼Œå¹¶è¯¦ç»†æè¿°è¿™äº›ç­–ç•¥ã€‚

æœ‰å¾ˆå¤šå¾ˆå¥½çš„æ–‡ç« å’Œæ•™ç¨‹è¯¦ç»†è§£é‡Šäº†[è¿­ä»£å™¨](https://codeburst.io/a-simple-guide-to-es6-iterators-in-javascript-with-examples-189d052c3d8e)ã€‚æ‰€ä»¥ï¼Œä¸ºäº†æ›´æ¥è¿‘è¿™ç¯‡æ–‡ç« çš„ç›®æ ‡ï¼Œæˆ‘ä¼šç®€å•åœ°è¯´ä¸€ä¸‹ã€‚

# è¿­ä»£å™¨

[è¿­ä»£å™¨](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Iterators_and_generators)ç®€è€Œè¨€ä¹‹å°±æ˜¯ä»»ä½•å®ç°[è¿­ä»£å™¨åè®®](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols#The_iterator_protocol)çš„å¯¹è±¡ã€‚åŸºæœ¬ä¸Šï¼Œ`Iterator`å¯¹è±¡å¿…é¡»åŒ…å«`next`å‡½æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªå…·æœ‰ä»»æ„ç±»å‹`value`å’Œå¸ƒå°”`done`å±æ€§çš„å¯¹è±¡ã€‚`next`æ–¹æ³•å®šä¹‰äº†è¿­ä»£çš„é¡ºåºä»¥åŠæ¯ä¸€æ­¥äº§ç”Ÿçš„å€¼ã€‚

è¦è¿­ä»£è¿™æ ·çš„å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„æŠ€æœ¯:

è®¸å¤šå†…ç½®å¯¹è±¡ï¼Œå¦‚æ•°ç»„ã€å­—ç¬¦ä¸²ã€æ˜ å°„å’Œé›†åˆï¼Œå·²ç»å®ç°äº†å¯è¿­ä»£æ¥å£ã€‚é€šå¸¸ï¼Œä¸ºäº†ä¸`generators`å…¼å®¹ï¼Œè¿­ä»£å™¨åœ¨`Symbol.iterator`å±æ€§ä¸Šå£°æ˜ã€‚

æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œåœ¨åˆ°è¾¾ç»“æŸçŠ¶æ€åï¼Œafter done çœ‹èµ·æ¥æ˜¯`true`ã€‚å¯¹è¿­ä»£å™¨æ–¹æ³•çš„`next()`è°ƒç”¨è¿”å›ç›¸åŒçš„ç»“æœ- `{value: undefined, done: true}`ã€‚

ç”Ÿæˆå™¨æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒç®€åŒ–äº†è¿­ä»£å™¨çš„å£°æ˜ã€‚å®ƒå¯ä»¥**åœæ­¢æ‰§è¡Œ**å’Œ**è¿”å›å¤šä¸ªå€¼**ã€‚

ä¸€ä¸ªç”Ÿæˆå™¨ä»¥`function*`æ“ä½œç¬¦å¼€å§‹ï¼Œå®ƒçš„ä¸»ä½“å°±åƒä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼Œæ‰©å±•äº†ä¸€äº›ç‰¹æ€§ã€‚

# å¼‚æ­¥è¿­ä»£å™¨

å¼‚æ­¥è¿­ä»£å™¨å…è®¸å»¶è¿ŸåŒ…å«å¼‚æ­¥é€»è¾‘çš„è¿­ä»£è¿‡ç¨‹ã€‚å¼‚æ­¥è¿­ä»£å™¨`next()`æ–¹æ³•çš„æ¯ä¸ªç»“æœè¿”å›ä¸€ä¸ª`Promise`ï¼Œè§£ææˆä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«`value`å’Œ`done`å±æ€§ã€‚

**å¼‚æ­¥å‡½æ•°**å…è®¸æˆ‘ä»¬ä½¿ç”¨`await`è¯­æ³•å¹¶è¿”å›`Promise`ã€‚ä»é€»è¾‘ä¸Šè®²ï¼Œ**å¼‚æ­¥å‘ç”µæœº**å…è®¸`await`å¹¶äº§ç”Ÿ`Promises`ã€‚

> é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆæœ‰äººä¼šä½¿ç”¨å¼‚æ­¥å‘ç”µæœºå‘¢ï¼Ÿ

å¥½é—®é¢˜ï¼`Async iterators`è‡ªå¸¦é…·ç‚«*å¾ªç¯æ„é€ :*

```
for await (const item of asyncIterator) {
  // ...
}
```

è¿™å°±æ˜¯åŸå› ï¼ğŸ˜‰è¿™æ„å‘³ç€å¼€å‘äººå‘˜å¯ä»¥å®šä¹‰ä»»ä½•ä»–æˆ–å¥¹å–œæ¬¢çš„å¼‚æ­¥è¿­ä»£é¡ºåºã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è¿­ä»£[èŠ‚ç‚¹è¯»å–æµ](https://nodejs.org/api/stream.html#stream_readable_symbol_asynciterator)ã€‚

```
const fs = require('fs')
const readStream = fs.createReadStream('./test.txt', { encoding: 'utf8' })async function print() { 
  for await (const chunk of readStream) {
    console.log(chunk)
  }
}

print()
```

ä¸è¦å¿˜è®°åˆ‡æ¢åˆ°æ›´æ–°ç‰ˆæœ¬çš„`Node`:

```
nvm use 12
Now using node v12.4.0 (npm v6.9.0)
```

è¯·æ³¨æ„ï¼Œ`for-await`åªèƒ½åœ¨`async`å‡½æ•°å†…éƒ¨ä½¿ç”¨ã€‚ä»å®ç°çš„è§’åº¦æ¥çœ‹ï¼Œ`async iterators`åº”è¯¥ç”¨`Symbol.asyncIterator`å±æ€§æ¥å£°æ˜ã€‚

# **å¼‚æ­¥ç­–ç•¥**

å‡è®¾æ‚¨æƒ³è¦è¯·æ±‚å¤šä¸ªå¼‚æ­¥æº:

```
async function* inOrderRequests(urls) {
  for (const url of urls) {
    const response = await fetch(url)
    const text = await response.text()
    yield text
  }
}
```

ç°åœ¨ï¼Œå¯ä»¥åœ¨å¼‚æ­¥å‡½æ•°ä¸­è¿­ä»£`urls`:

```
async function pageText(urls) {
  for await (const responseText of inOrderRequests(urls)) {
    console.log(responseText) 
  }
}pageText([location.href])
```

`pageText([location.href])`å‡½æ•°è°ƒç”¨è¾“å‡ºå½“å‰æµè§ˆå™¨é¡µé¢çš„åˆå§‹æ–‡æœ¬ã€‚

åœ¨ç ”è®¨ä¼šæœŸé—´ï¼ŒKyle ç¡®å®šäº†å¯ç”¨äºè¯·æ±‚å¼‚æ­¥èµ„æºçš„ä¸‰ç§ä¸åŒç­–ç•¥:

*   `in order - in order`å½“ä¸€ä¸ªè¯·æ±‚åœ¨å¦ä¸€ä¸ªè¯·æ±‚çš„å“åº”è¿”å›åæ‰§è¡Œã€‚ä¸Šé¢çš„`pageText`å°±æ˜¯è¿™ç§ç­–ç•¥çš„ä¸€ä¸ªä¾‹å­ã€‚
*   `asap - in order`å½“è¯·æ±‚è¢«ä¸€èµ·æ‰§è¡Œå¹¶ä¸”å“åº”ä»¥åˆå§‹é¡ºåºè¿”å›æ—¶ã€‚æˆ‘ä»¬å°†ç”¨ä¸€ä¸ª`asapInOrderRequests`å‡½æ•°æ¥ä¿®æ”¹å‰é¢çš„ä¾‹å­ã€‚

ç°åœ¨ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šç«‹å³æ‰§è¡Œã€‚è¯¥å‡½æ•°ç­‰å¾…æ¯ä¸ªè¯·æ±‚è§£å†³ï¼Œä½†æ˜¯è¯·æ±‚æ‰€èŠ±è´¹çš„æ€»æ—¶é—´å—é™äºå®ƒæœ€å¤§çš„å»¶è¿Ÿ`Promise`ã€‚

*   æœ€åï¼Œå½“è¯·æ±‚å’Œç»“æœéƒ½è¢«æ‰§è¡Œå¹¶å°½å¿«è¿”å›æ—¶ï¼Œåº”ç”¨`asap - asap`ç­–ç•¥ã€‚

åœ¨ç ”è®¨ä¼šä¸Šï¼Œ[å‡¯å°”](https://me.getify.com/)å±•ç¤ºäº†æ‰€æœ‰ä¸‰ç§å¯èƒ½æ€§ï¼Œå…¶ä¸­`asap - asap`æ˜¯æœ€éš¾çš„ï¼Œå› ä¸ºä»–æ­£åœ¨å³å…´åˆ›ä½œã€‚æˆ‘ç¡®å®ä¹Ÿå‘ç°åè€…æœ€æœ‰è¶£

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒJavaScript é—­åŒ…ç‰¹æ€§è¢«ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªå·²è§£å†³çš„`Promise`ã€‚æ¯å½“å®ƒè¢«æ»¡è¶³ï¼Œå‘ç”µæœº`yields`çš„ç»“æœï¼Œæ‰€ä»¥æ•´ä¸ªæ¯”èµ›çš„`Promises`æ­£åœ¨å‘ç”Ÿã€‚å®Œæˆè¿™ä¸ªç»ƒä¹ èŠ±äº†æˆ‘ä¸€äº›æ—¶é—´å’ŒåŠªåŠ›ã€‚å¸Œæœ›ä½ ä¼šè§‰å¾—æœ‰ç”¨ã€‚

æˆ‘å¯¹ä½ çš„åé¦ˆå¾ˆæ„Ÿå…´è¶£ã€‚è¯·è®©æˆ‘çŸ¥é“ä½ å¯¹é‚£æ®µä»£ç çš„çœ‹æ³•ã€‚ä½ ä¼šåœ¨ä½ çš„é¡¹ç›®ä¸­ä½¿ç”¨ç±»ä¼¼çš„ç»“æ„å—ï¼Ÿè¯„è®ºä¸­å†è§ğŸ™‚

å¹¶æœ‰ä¸€ä¸ªä¸é”™çš„ç¼–ç ï¼