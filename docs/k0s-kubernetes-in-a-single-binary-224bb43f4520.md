# k0s:å•ä¸ªäºŒè¿›åˆ¶ä¸­çš„ Kubernetes

> åŸæ–‡ï¼š<https://betterprogramming.pub/k0s-kubernetes-in-a-single-binary-224bb43f4520>

## è¿™ç§æ–°çš„ Kubernetes åˆ†å¸ƒçš„åˆæ­¥ç ”ç©¶

![](img/2216ca0fb33de312157cbcfcb1c79070.png)

å®‰å¦®Â·æ–¯æ™®æ‹‰ç‰¹åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šçš„ç…§ç‰‡

ğŸ”¥æ›´æ–°:è‡ªä»æ’°å†™æœ¬æ–‡ä»¥æ¥ï¼Œk0s å·²ç»å¢åŠ äº†è®¸å¤šé™„åŠ ç‰¹æ€§ã€‚è¯·æŸ¥çœ‹[è¿™ç¯‡æ–°æ–‡ç« ](https://itnext.io/k0s-multi-node-cluster-with-k0sctl-922fc2cb4dc8)ï¼Œå®ƒè¯¦ç»†ä»‹ç»äº†å•èŠ‚ç‚¹æˆ–å¤šèŠ‚ç‚¹ k0s é›†ç¾¤çš„ç®€å•è®¾ç½®ã€‚

å‡ å¤©å‰ï¼Œä¸€ä¸ªæœ‹å‹å‘Šè¯‰æˆ‘å…³äº$ multipass exec node1 cat /var/lib/k0s/pki/admin.conf > k0s.cfg

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”¨`node1`çš„å¤–éƒ¨ IP åœ°å€æ›¿æ¢å†…éƒ¨ IP åœ°å€:

```
# Replace IP address
$ NODE1_IP=$(multipass info node1 | grep IP | awk '{print $2}')
sed -i '' "s/localhost/$NODE1_IP/" k0s.cfg
```

ç„¶åï¼Œæˆ‘ä»¬é…ç½®æœ¬åœ° kubectl å®¢æˆ·æœºä¸ k0s API æœåŠ¡å™¨é€šä¿¡:

```
export KUBECONFIG=$PWD/k0s.cfg
```

æˆ‘ä»¬åœ¨è®¿é—®æ–°é›†ç¾¤æ—¶è¿è¡Œçš„ç¬¬ä¸€ä¸ªå‘½ä»¤å¯èƒ½æ˜¯åˆ—å‡ºæ‰€æœ‰å¯ç”¨èŠ‚ç‚¹çš„å‘½ä»¤ï¼Œè®©æˆ‘ä»¬è¯•è¯•:

```
**$ kubectl get no**
NAME    STATUS   ROLES    AGE   VERSION
node1   Ready    <none>   78s   v1.19.4
```

è¿™å¹¶ä¸å¥‡æ€ªã€‚`node1`æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªé›†ç¾¤çš„ä¸»èŠ‚ç‚¹ï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬åœ¨å¯åŠ¨å‘½ä»¤ä¸­æŒ‡å®šçš„`--enable-worker`æ ‡å¿—ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªå·¥ä½œè€…èŠ‚ç‚¹ã€‚å¦‚æœæ²¡æœ‰é‚£ä¸ªæ ‡å¿—ï¼Œ`node1`å°†åªæ˜¯ä¸€ä¸ªå·¥äººï¼Œä¸ä¼šå‡ºç°åœ¨è¿™é‡Œçš„èŠ‚ç‚¹åˆ—è¡¨ä¸­ã€‚

# æ·»åŠ å·¥ä½œèŠ‚ç‚¹

ä¸ºäº†å°†`node2`å’Œ`node3`æ·»åŠ åˆ°æˆ‘ä»¬çš„é›†ç¾¤ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ä»`node1`åˆ›å»ºä¸€ä¸ª join ä»¤ç‰Œ(è¿™ä¸€æ­¥å¾ˆå¸¸è§ï¼Œå› ä¸ºå®ƒç”¨åœ¨ç”¨ kubeadm åˆ›å»ºçš„ Docker Swarm å’Œ Kubernetes é›†ç¾¤ä¸­)ã€‚

```
$ TOKEN=$(k0s token create --role=worker)
```

ä¸Šé¢çš„å‘½ä»¤ç”Ÿæˆä¸€ä¸ªé•¿(éå¸¸é•¿)çš„ä»¤ç‰Œã€‚ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬å¯ä»¥å°†`node2`å’Œ`node3`åŠ å…¥æˆ‘ä»¬çš„é›†ç¾¤:

```
ubuntu@node2:~$ k0s worker $TOKENubuntu@node3:~$ k0s worker $TOKEN
```

**æ³¨æ„:**åœ¨ä¸€ä¸ªçœŸå®çš„é›†ç¾¤ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ systemd(æˆ–å¦ä¸€ä¸ª supervisor)æ¥ç®¡ç†å·¥ä½œèŠ‚ç‚¹çš„ k0s è¿›ç¨‹ï¼Œå°±åƒæˆ‘ä»¬å¯¹ä¸»èŠ‚ç‚¹æ‰€åšçš„é‚£æ ·ã€‚

æˆ‘ä»¬çš„ä¸‰èŠ‚ç‚¹é›†ç¾¤ç°åœ¨å·²ç»å¯åŠ¨å¹¶è¿è¡Œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å†æ¬¡åˆ—å‡ºèŠ‚ç‚¹æ¥çœ‹åˆ°è¿™ä¸€ç‚¹:

```
**$ kubectl get no** NAME    STATUS  ROLES    AGE   VERSION
node1   Ready   <none>   30m   v1.19.4
node2   Ready   <none>   35s   v1.19.4
node3   Ready   <none>   32s   v1.19.4
```

æˆ‘ä»¬è¿˜å¯ä»¥æ£€æŸ¥è·¨æ‰€æœ‰åç§°ç©ºé—´è¿è¡Œçš„ pod:

![](img/19f4e3b9ce7a9ff1a2aea2a2ffa04c21.png)

è·¨æ‰€æœ‰å‘½åç©ºé—´åœ¨é›†ç¾¤ä¸­è¿è¡Œçš„ pod åˆ—è¡¨

è¿™é‡Œéœ€è¦æ³¨æ„ä¸€äº›äº‹æƒ…:

*   åƒå¾€å¸¸ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°`kube-proxy`è±†èšï¼Œç½‘ç»œæ’ä»¶(åŸºäº Calico)ï¼Œä»¥åŠä¸€ä¸ªæ ¸å¿ƒåŸŸåè±†èš
*   `api-server`ã€`scheduler`å’Œ`controller-manager`çª—æ ¼æ²¡æœ‰å‡ºç°åœ¨æ­¤åˆ—è¡¨ä¸­ï¼Œå› ä¸ºå®ƒä»¬ä½œä¸ºå¸¸è§„è¿›ç¨‹è¿è¡Œï¼Œä¸åœ¨çª—æ ¼å†…

# æ·»åŠ ç”¨æˆ·

k0s 0 . 8 . 0 ç‰ˆæœ¬å¸¦æ¥äº†`user`å­å‘½ä»¤ã€‚å®ƒå…è®¸æˆ‘ä»¬ä¸ºé¢å¤–çš„ç”¨æˆ·/ç»„åˆ›å»ºä¸€ä¸ª`kubeconfig`ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„å‘½ä»¤åˆ›å»ºåä¸º`demo`çš„æ–°ç”¨æˆ·çš„`kubeconfig`æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä½äºåä¸º`development`çš„è™šæ‹Ÿç»„ä¸­ã€‚

**æ³¨æ„:**åœ¨ Kubernetes ä¸­ï¼Œç”¨æˆ·å’Œç»„ç”±é›†ç¾¤å¤–çš„ç®¡ç†å‘˜ç®¡ç†ï¼Œè¿™æ„å‘³ç€ K8s ä¸­æ²¡æœ‰ç”¨æˆ·-éç»„èµ„æºã€‚

```
$ sudo k0s user create demo --groups development > demo.kubeconfig
```

ä¸ºäº†æ›´å¥½åœ°ç†è§£ï¼Œæˆ‘ä»¬å°†ä»è¿™ä¸ª`kubeconfig`æ–‡ä»¶ä¸­æå–å®¢æˆ·ç«¯çš„è¯ä¹¦ï¼Œå¹¶ä»å…¶ base64 è¡¨ç¤ºä¸­å¯¹å…¶è¿›è¡Œè§£ç :

```
$ cat demo.kubeconfig | grep client-certificate-data | awk '{print $2}' | base64 --decode > demo.crt
```

ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª`openssl`å‘½ä»¤æ¥è·å–è¯¥è¯ä¹¦çš„å†…å®¹:

```
**ubuntu@node1:~$ openssl x509 -in demo.crt -noout -text** Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            71:8b:a4:4d:be:76:70:8a:...:07:60:67:c1:2d:51:94
        Signature Algorithm: sha256WithRSAEncryption
        **Issuer: CN = kubernetes-ca**
        Validity
            Not Before: Dec  2 13:50:00 2020 GMT
            Not After : Dec  2 13:50:00 2021 GMT
        **Subject: O = development, CN = demo**
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                RSA Public-Key: (2048 bit)
                Modulus:
                    00:be:87:dd:15:46:91:98:eb:b8:38:34:77:a4:99:
                    da:4b:d6:ca:09:92:f3:29:28:2d:db:7a:0b:9f:91:
                    65:f3:11:bb:6c:88:b1:8f:46:6e:38:71:97:b7:b5:
                    9b:8d:32:86:1f:0b:f8:4e:57:4f:1c:5f:9f:c5:ee:
                    40:23:80:99:a1:77:30:a3:46:c1:5b:3e:1c:fa:5c:
```

*   `issuer`å±æ€§æ˜¯`kubernetes-ca`ï¼Œæ˜¯æˆ‘ä»¬ k0s é›†ç¾¤çš„è®¤è¯æœºæ„
*   `Subject`æ˜¯`O = development, CN = demo`ï¼›è¿™ä¸€éƒ¨åˆ†å¾ˆé‡è¦ï¼Œå› ä¸ºè¿™æ˜¯ç”¨æˆ·åå’Œç”¨æˆ·ç»„å‡ºç°çš„åœ°æ–¹ã€‚å› ä¸ºè¯ä¹¦æ˜¯ç”±é›†ç¾¤çš„ CA ç­¾ç½²çš„ï¼Œ`api-server`ä¸­çš„ä¸€ä¸ªæ’ä»¶èƒ½å¤Ÿæ ¹æ®è¯ä¹¦ä¸»é¢˜ä¸­çš„é€šç”¨åç§°(CN)å’Œç»„ç»‡(O)æ¥è®¤è¯ç”¨æˆ·/ç»„ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å‘Šè¯‰ kubectl ä½¿ç”¨è¿™ä¸ªæ–°çš„`kubeconfig`æ–‡ä»¶ä¸­å®šä¹‰çš„ä¸Šä¸‹æ–‡:

```
$ export KUBECONFIG=$PWD/demo.kubeconfig
```

ç„¶åï¼Œæˆ‘ä»¬å†æ¬¡åˆ—å‡ºé›†ç¾¤çš„èŠ‚ç‚¹:

```
**$ kubectl get no** Error from server (Forbidden): nodes is forbidden: User â€œdemoâ€ cannot list resource â€œnodesâ€ in API group â€œâ€ at the cluster scope
```

æ­¤é”™è¯¯æ¶ˆæ¯æ˜¯æ„æ–™ä¹‹ä¸­çš„ã€‚å³ä½¿ç”¨æˆ·å·²ç»é€šè¿‡äº†`api-server`çš„è®¤è¯(ä¸ç”¨æˆ·è¯·æ±‚ä¸€èµ·å‘é€çš„è¯ä¹¦å·²ç»ç”±é›†ç¾¤è¯ä¹¦é¢å‘æœºæ„ç­¾å)ï¼Œä»–ä»¬ä¹Ÿæ— æƒåœ¨é›†ç¾¤ä¸­æ‰§è¡Œä»»ä½•æ“ä½œã€‚

é€šè¿‡åˆ›å»º`Role` / `ClusterRole`å¯ä»¥å¾ˆå®¹æ˜“åœ°æ·»åŠ é¢å¤–çš„æƒé™ï¼Œå¹¶é€šè¿‡`RoleBinding` / `ClusterRoleBinding`ç»‘å®šåˆ°ç”¨æˆ·ï¼Œä½†æˆ‘å°†æ­¤ä½œä¸ºè¯»è€…çš„ç»ƒä¹ ã€‚

# ç»“è®º

k0s ç»å¯¹å€¼å¾—ä¸€çœ‹ã€‚ç”¨ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æ¥ç®¡ç†æ‰€æœ‰çš„è¿›ç¨‹æ˜¯ä¸€ä¸ªéå¸¸æœ‰è¶£çš„æ–¹æ³•ã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯å¿«é€Ÿæµè§ˆäº†ä¸€ä¸‹ k0sï¼Œä½†æ˜¯æˆ‘ä¼šç¡®ä¿è·Ÿè¸ªå®ƒçš„å‘å±•ï¼Œå¹¶åœ¨ä»¥åçš„æ–‡ç« ä¸­ä¸“é—¨ä»‹ç»è¿™ä¸ªæ–°çš„ã€æœ‰å‰é€”çš„ Kubernetes å‘è¡Œç‰ˆã€‚ä¸€äº›æœªæ¥çš„åŠŸèƒ½çœ‹èµ·æ¥å¾ˆæœ‰å‰é€”ï¼Œæˆ‘çœŸçš„å¾ˆæœŸå¾…æµ‹è¯•å®ƒä»¬ã€‚