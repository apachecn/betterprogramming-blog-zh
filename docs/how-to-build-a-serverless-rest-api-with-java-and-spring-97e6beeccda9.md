# å¦‚ä½•ç”¨ Java å’Œ Spring æ„å»ºæ— æœåŠ¡å™¨ REST API

> åŸæ–‡ï¼š<https://betterprogramming.pub/how-to-build-a-serverless-rest-api-with-java-and-spring-97e6beeccda9>

## ä½¿ç”¨ Javaã€Spring å’Œ AWS SAM å®ç°æ— æœåŠ¡å™¨åŒ–

![](img/d959403502893c1701d0eedc0d9cc680.png)

ä½œè€…æä¾›çš„å›¾ç‰‡

ç»§ä¸Šä¸€ç¯‡å…³äºç”¨ TypeScript å’Œ NestJS æ„å»º[æ— æœåŠ¡å™¨ REST API çš„æ–‡ç« ä¹‹åï¼Œæˆ‘ä»¬ç°åœ¨å°†æ·±å…¥ä¸€äº›å…¶ä»–æŠ€æœ¯ã€‚åœ¨è¿™ä¸ªæ•…äº‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ AWS SAMã€Java å’Œ Spring æ„å»ºä¸€ä¸ªæ— æœåŠ¡å™¨ REST APIã€‚ä½œä¸ºä¸€ä¸ªæ„å»ºå·¥å…·ï¼Œæˆ‘ä»¬é€‰æ‹©äº†](https://blog.devgenius.io/how-to-build-a-serverless-rest-api-with-nestjs-and-dynamodb-7b58b5b59bf6) [Gradle](https://gradle.org/) ï¼Œå®ƒæ˜¯è‡ªåŠ¨åŒ–æ„å»ºè¿‡ç¨‹æœ€å¿«çš„å·¥å…·ï¼Œå¹¶ä¸”åœ¨ Java é¢†åŸŸå—åˆ° ide çš„å¹¿æ³›æ”¯æŒã€‚

> ä¸ç¡®å®šæ— æœåŠ¡å™¨æŠ€æœ¯èƒ½æä¾›ä»€ä¹ˆï¼Ÿé˜…è¯»[æˆ‘ä»¥å‰çš„æ–‡ç« ](https://serverlesscorner.com/serverless-just-ship-the-code-c1214214a5f7)æ— æœåŠ¡å™¨æŠ€æœ¯å¦‚ä½•å¸®åŠ©ä½ æ›´å¿«åœ°æ„å»ºã€‚

API å°†åœ¨ AWS Lambda ä¸Šè¿è¡Œï¼Œå¹¶ä¸ API ç½‘å…³ç›¸å…³è”(è§ä¸‹å›¾)ã€‚è¿™ç§æ— æœåŠ¡å™¨æ¶æ„å…è®¸æ‚¨ä»¥æŒ‰è¯·æ±‚ä»˜è´¹çš„å®šä»·æ¨¡å¼è¿è¡ŒæœåŠ¡ï¼Œåªéœ€æœ€å°‘çš„æ“ä½œç»´æŠ¤ã€‚

![](img/e9e626cd1e04d598daf2cfbd61b611cd.png)

æ— æœåŠ¡å™¨æ¶æ„

è®©æˆ‘ä»¬å¿«é€Ÿä»‹ç»ä¸€ä¸‹æ‰€æ¶‰åŠçš„æŠ€æœ¯ï¼Œè®©æ‚¨æ›´å¥½åœ°äº†è§£æˆ‘ä»¬å°†åœ¨è¿™é‡Œæ„å»ºä»€ä¹ˆã€‚

# AWS SAM

AWS æ— æœåŠ¡å™¨åº”ç”¨ç¨‹åºæ¨¡å‹(AWS SAM)æ˜¯ AWS è‡ªå·±çš„æŠ€æœ¯ï¼Œå¯ä»¥å¸®åŠ©æ‚¨æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½² AWS Lambda åŠŸèƒ½ã€‚ä»¥å‰æˆ‘ä½¿ç”¨æ— æœåŠ¡å™¨æ¡†æ¶ï¼ŒAWS SAM æ›´é€‚åˆç”¨ Java å®Œæˆçš„ Lambda å‡½æ•°ã€‚

> è¦ä½¿ç”¨ AWS SAM åœ¨æœ¬åœ°è¿è¡Œå’Œæµ‹è¯•æ‚¨çš„ Lambdaï¼Œæ‚¨è¿˜éœ€è¦å®‰è£… [Docker](https://docs.docker.com/get-docker/) ã€‚

## å¼¹ç°§æ¡†æ¶

Spring æ¡†æ¶æ˜¯æœ€æµè¡Œçš„ Java å¼€æºæ¡†æ¶ã€‚å®ƒä¸º webã€æ•°æ®åº“ã€é›†æˆç­‰æä¾›äº†è®¸å¤šæ¨¡å—ã€‚Spring å…è®¸å¼€å‘è€…ä½¿ç”¨ POJOs å¹¶éšè—äº†å¤æ‚æ€§ã€‚å¼€å‘äººå‘˜ä½¿ç”¨ Spring æ¡†æ¶æ•ˆç‡æ›´é«˜ã€‚Spring æ¡†æ¶çš„æ ¸å¿ƒæ˜¯æ§åˆ¶æ¨¡å¼çš„åè½¬ã€‚Spring IoC å®¹å™¨å¤„ç†å¯¹è±¡åˆ›å»ºå’Œä¾èµ–æ³¨å…¥ï¼Œå…è®¸ç±»ä¹‹é—´æ›´æ¾æ•£çš„è€¦åˆï¼Œè¿™æä¾›äº†çµæ´»æ€§ã€‚

## æ ¼æ‹‰å¾·å‹’

ä¸ Maven ç›¸æ¯”ï¼ŒGradle æ˜¯æœ€å¿«çš„ Java æ„å»ºå·¥å…·ï¼Œæé«˜äº†æ‚¨çš„å·¥ä½œæ•ˆç‡ã€‚

# è®¾è®¡é€‰æ‹©

ä½¿ç”¨ AWS Lambda æ„å»º REST API æœ‰å¾ˆå¤šæ–¹æ³•ã€‚åœ¨è¿™ä¸ªæ•…äº‹ä¸­ï¼Œæˆ‘åšäº†ä»¥ä¸‹é€‰æ‹©:

API ç½‘å…³ Lambda ä»£ç†é›†æˆâ€”â€”æ‚¨é€šå¸¸ä¼šå°† API ç½‘å…³ä¸­çš„æ¯ä¸ª API è¯·æ±‚æ˜ å°„åˆ°ä¸€ä¸ª Lambda å‡½æ•°ï¼Œä»£ç†é›†æˆå…è®¸æ‚¨å°†æ‰€æœ‰ API è¯·æ±‚æ˜ å°„åˆ°ä¸€ä¸ª Lambda å‡½æ•°ã€‚è¿™ç§ä¸ API ç½‘å…³çš„åˆ†ç¦»å‡è½»äº†æ‚¨åœ¨ API ç½‘å…³ä¸­ç®¡ç† API é…ç½®çš„è´Ÿæ‹…ï¼Œå¹¶åŠ å¿«äº†å¼€å‘è¿‡ç¨‹ã€‚åœ¨ä¸€ä¸ªæœåŠ¡ä¸­æ†ç»‘ç›¸åŒé¢†åŸŸçš„åŠŸèƒ½éå¸¸é€‚åˆå¾®æœåŠ¡æ¶æ„ã€‚

ä¸€ä¸ªé¢å¤–çš„æ•ˆæœæ˜¯ï¼Œæ†ç»‘åŠŸèƒ½é™ä½äº†â€œå†·å¯åŠ¨â€çš„å‡ ç‡

è¿™ç¡®å®éœ€è¦æ‚¨è‡ªå·±å¤„ç†ä¼ å…¥çš„è¯·æ±‚ã€‚æ­£å¦‚æˆ‘ä»¬å°†çœ‹åˆ°çš„ï¼ŒSpring æ¡†æ¶ä¸è´¹å¹ç°ä¹‹åŠ›å°±èƒ½åšåˆ°è¿™ä¸€ç‚¹ã€‚

## æ— æœåŠ¡å™¨ Java å®¹å™¨

ç”¨ Java å®ç° AWS Lambda å¯ä»¥è€ƒè™‘å¤šç§æ¡†æ¶ï¼Œæ¯”å¦‚ Spring Cloudã€‚ç„¶è€Œï¼Œæˆ‘é€‰æ‹©ä½¿ç”¨ AWS å®éªŒå®¤çš„â€œ[æ— æœåŠ¡å™¨ Java å®¹å™¨](https://github.com/awslabs/aws-serverless-java-container)â€æ¡†æ¶ã€‚å®ƒç”± AWS ç»´æŠ¤ï¼Œå¹¶åœ¨ Lambda ä¸­æä¾›ä¸€ä¸ªè¿è¡Œ Spring çš„éå¸¸è–„çš„ Java åŒ…è£…å™¨ã€‚ç†:[å°‘ç ï¼Œå°‘å†·å¯åŠ¨](https://serverlesscorner.com/5-ways-to-deal-with-cold-starts-dcbb8967edf9)ã€‚

# è®©æˆ‘ä»¬å¼€å§‹å»ºé€ å§

æ‰€ä»¥ï¼Œç°åœ¨æˆ‘ä»¬çŸ¥é“äº†æˆ‘ä»¬å°†ä½¿ç”¨çš„æŠ€æœ¯å’Œæˆ‘ä»¬å‰è¿›çš„æ–¹å‘ï¼Œè®©æˆ‘ä»¬å¼€å§‹æ„å»ºå§ã€‚æˆ‘ä»¬å°†ç”¨ Java å’Œ Spring æ„å»ºä¸€ä¸ªåœ¨çº¿å›¾ä¹¦é¦†æœåŠ¡ä½œä¸ºè¿è¡Œåœ¨ AWS Lambda ä¸Šçš„ REST APIã€‚

> *æœ¬æ–‡çš„å®Œæ•´é¡¹ç›®å¯ä»¥åœ¨ Github*[*https://github.com/cyberworkz/examples*](https://github.com/cyberworkz/examples)*çš„* `*online-library-java*` *æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°ã€‚*

## å…ˆå†³æ¡ä»¶

1.  AWS å¸æˆ·â€”â€”æŸ¥çœ‹æ­¤[æ•…äº‹](https://aws.plainenglish.io/get-your-serverless-api-in-the-cloud-77bd70b26788)ä»¥è·å¾—è®¾ç½®å¸®åŠ©ã€‚
2.  Java å’Œ Spring çš„åŸºç¡€çŸ¥è¯†

## å®‰è£… AWS SAM

AWS SAM CLI ä½¿æ‚¨å¯ä»¥è½»æ¾åˆ›å»ºå’Œç®¡ç†æ— æœåŠ¡å™¨åº”ç”¨ç¨‹åºã€‚ä½¿ç”¨ä»¥ä¸‹[é“¾æ¥](http://makes it easy for you to create and manage serverless applications)å°†å…¶å®‰è£…åˆ°æ‚¨çš„æ“ä½œç³»ç»Ÿä¸Šã€‚

## è®¾ç½®é¡¹ç›®

ç°åœ¨ SAM å·²ç»å®‰è£…å¥½äº†ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥è®¾ç½®æˆ‘ä»¬çš„æ— æœåŠ¡å™¨é¡¹ç›®ã€‚æˆ‘ä»¬å°†ä½¿ç”¨é¢„å®šä¹‰çš„æ¨¡æ¿ç«‹å³æŠ•å…¥ä½¿ç”¨ã€‚æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥ç”Ÿæˆé¡¹ç›®:

```
sam init --location gh:cyberworkz/sam-templates
```

è¿™å°†ä½¿ç”¨ä»£ç†æ¨¡å¼ç”Ÿæˆä¸€ä¸ª Java Spring é¡¹ç›®ï¼Œå¹¶å¸¦æœ‰æ‰€æœ‰å¿…éœ€çš„ä¾èµ–é¡¹ã€‚ç”Ÿæˆçš„é¡¹ç›®æœ‰ä¸€ä¸ª AWS SAM æ¨¡æ¿æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¸¥æ ¼éµå¾ª AWS CloudFormation çš„æ ¼å¼ã€‚`template.yml`æ–‡ä»¶åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

SAM æ¨¡æ¿æ–‡ä»¶

è®©æˆ‘ä»¬è®¨è®ºä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶ä¸­æœ€é‡è¦çš„å‚æ•°ã€‚ä½¿ç”¨æ¨¡æ¿æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥ä¸ºæ‚¨çš„ Lambda å®šä¹‰ä»¥ä¸‹å‚æ•°:

*   è¿è¡Œæ—¶(java11)
*   å†…å­˜å¤§å°(512)
*   CodeUri å’Œå¤„ç†ç¨‹åºç±»ã€‚

å¦å¤–ï¼Œè¯·æ³¨æ„ events éƒ¨åˆ†ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å®šä¹‰äº†ä»£ç†ä¸ API ç½‘å…³çš„é›†æˆæ–¹å¼ã€‚

```
Events:        
  Service:          
    Type: Api 
    Properties:            
      Path: /{proxy+}            
      Method: any
```

`CodeUri`å‚æ•°å®šä¹‰äº†ä½œä¸º Lambda ä»£ç éƒ¨ç½²çš„ java åŒ…ã€‚Gradle æ„å»ºæ–‡ä»¶åŒ…å«ä»»åŠ¡ shadowJarï¼Œå®ƒå°†æ„å»ºä»£ç ï¼ŒåŒ…æ‹¬ä¾èµ–é¡¹ä¸­çš„æ‰€æœ‰ç±»ï¼Œä»¥ä¾¿å®ƒå¯ä»¥è¿è¡Œã€‚

Gradle æ„å»ºæ–‡ä»¶

# è¯·æ±‚å¤„ç†ç¨‹åº

ç°åœ¨æˆ‘ä»¬å·²ç»å»ºç«‹äº†é¡¹ç›®ã€‚æˆ‘ä»¬å°†æŸ¥çœ‹å¤„ç†æ¥è‡ª API ç½‘å…³çš„ä¼ å…¥è¯·æ±‚çš„ä»£ç ã€‚`StreamLambdaHandler`ç±»å¤„ç†ä¼ å…¥çš„è¯·æ±‚ã€‚

è¯·æ±‚å¤„ç†ç¨‹åº

è¯¥ç±»åŒ…å«ä¸€ä¸ªé™æ€éƒ¨åˆ†ï¼Œå®ƒåœ¨åˆå§‹åŒ–é˜¶æ®µè¢«è°ƒç”¨ã€‚ä½¿ç”¨å®ƒæ¥å»ºç«‹ä¸ä½œä¸ºæ•°æ®åº“çš„èµ„æºçš„è¿æ¥ã€‚å¤„ç†å®Œè¯·æ±‚åï¼Œè¿™äº›èµ„æºä¼šåœ¨ä¸‹æ¬¡è°ƒç”¨æ—¶ä¿ç•™ã€‚

`handleRequest`æ–¹æ³•å°†è¯·æ±‚ä½œä¸ºä¸€ä¸ª`Inputstream`æ¥å¤„ç†ï¼Œå¹¶è¿”å›ä¸€ä¸ª`OutputStream`ä½œä¸ºå“åº”ã€‚è¯¥æ–¹æ³•ä»£ç†å¯¹`SpringLambdaContainer`çš„è°ƒç”¨ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿåº”ç”¨ Spring æ¡†æ¶é­”æ³•ã€‚

## è¯­å¢ƒæ–¹æ³•

[ä¸Šä¸‹æ–‡å¯¹è±¡](https://docs.aws.amazon.com/lambda/latest/dg/java-context.html)åŒ…å«è·å–è¯·æ±‚ä¿¡æ¯çš„é’©å­ã€‚æœ‰å…³ä¸Šä¸‹æ–‡å¯¹è±¡å¯ä»¥æä¾›çš„å†…å®¹ï¼Œè¯·å‚è§ä»¥ä¸‹åˆ—è¡¨ã€‚

*   `getRemainingTimeInMillis()`â€“è¿”å›æ‰§è¡Œè¶…æ—¶å‰å‰©ä½™çš„æ¯«ç§’æ•°ã€‚
*   `getFunctionName()`â€“è¿”å› Lambda å‡½æ•°çš„åç§°ã€‚
*   `getFunctionVersion()`â€“è¿”å›å‡½æ•°çš„[ç‰ˆæœ¬](https://docs.aws.amazon.com/lambda/latest/dg/configuration-versions.html)ã€‚
*   `getInvokedFunctionArn()`â€“è¿”å›ç”¨äºè°ƒç”¨è¯¥å‡½æ•°çš„äºšé©¬é€Šèµ„æºåç§°(ARN)ã€‚æŒ‡ç¤ºè°ƒç”¨ç¨‹åºæ˜¯å¦æŒ‡å®šäº†ç‰ˆæœ¬å·æˆ–åˆ«åã€‚
*   `getMemoryLimitInMB()`â€“è¿”å›åˆ†é…ç»™è¯¥å‡½æ•°çš„å†…å­˜é‡ã€‚
*   `getAwsRequestId()`â€“è¿”å›è°ƒç”¨è¯·æ±‚çš„æ ‡è¯†ç¬¦ã€‚
*   `getLogGroupName()`â€“è¿”å›å‡½æ•°çš„æ—¥å¿—ç»„ã€‚
*   `getLogStreamName()`â€“è¿”å›å‡½æ•°å®ä¾‹çš„æ—¥å¿—æµã€‚
*   `getIdentity()`â€“(ç§»åŠ¨åº”ç”¨ç¨‹åº)è¿”å›æˆæƒè¯·æ±‚çš„ Amazon Cognito èº«ä»½çš„ä¿¡æ¯ã€‚
*   `getClientContext()`â€“(ç§»åŠ¨åº”ç”¨)è¿”å›å®¢æˆ·ç«¯åº”ç”¨æä¾›ç»™ Lambda çš„å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡ã€‚
*   `getLogger()`â€“è¿”å›å‡½æ•°çš„[è®°å½•å™¨å¯¹è±¡](https://docs.aws.amazon.com/lambda/latest/dg/java-logging.html)ã€‚

## API ç«¯ç‚¹

ç°åœ¨ï¼Œæˆ‘ä»¬è½¬å‘å®šä¹‰ API ç«¯ç‚¹ã€‚æˆ‘ä»¬ä½¿ç”¨ä»£ç†é›†æˆæ¨¡å¼ï¼Œå…¶ä¸­ API ç½‘å…³ä¸Šçš„æ¯ä¸ªè¯·æ±‚éƒ½è¢«è½¬å‘ç»™ Lambda ä»£ç ã€‚ä½¿ç”¨ Spring MVCï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ³¨é‡Šéå¸¸å®¹æ˜“åœ°å®šä¹‰ç«¯ç‚¹ã€‚å‚è§ä¸‹é¢çš„`OnlineLibraryController.java`ä»£ç :

OnlineLibraryController.java

`EnableWebMvc`æ³¨é‡Šè¡¨æ˜æ‚¨å°†ä½¿ç”¨æ³¨é‡Šæ¥é…ç½®è¯·æ±‚æ˜ å°„ã€‚`RestController`æ³¨é‡Šè¡¨æ˜è¯¥ç±»æ˜¯ Spring æ¡†æ¶ä¸­çš„æ‰˜ç®¡ç»„ä»¶ï¼Œå°†åœ¨å¯åŠ¨ Spring å®¹å™¨æ—¶è¢«åˆå§‹åŒ–ã€‚

`RequestMapping`æ³¨é‡Šè¯´æ˜äº†æ§åˆ¶å™¨ç±»æ–¹æ³•å°†è¢«æ˜ å°„åˆ°çš„è·¯å¾„ã€‚`GetMapping`æ³¨é‡Šæ˜¯`RequestMapping`çš„ä¸“é—¨åŒ–ï¼Œå°†æ–¹æ³•æ˜ å°„åˆ° GET è¯·æ±‚ã€‚æ³¨é‡Š`GetMapping`çš„å€¼æ·»åŠ åˆ°åœ¨ç±»çº§åˆ«å®šä¹‰çš„`RequestMapping`ä¸­ï¼Œå¹¶ä¸”å¯ä»¥åŒ…å«è·¯å¾„å˜é‡ã€‚æœ¬ä¾‹ä¸­çš„ URL `/books/author/tolkien/jrr`è¢«æ˜ å°„åˆ°`getBooksByAuthor`æ–¹æ³•ã€‚

ç”¨äºæ˜ å°„ä¼ å…¥ HTTP è¯·æ±‚çš„ä¸€äº›å…¶ä»–é‡è¦æ³¨é‡Šæ˜¯:

*   `PostMapping`
*   `PutMapping`
*   `PathVariable`
*   `RequestParam`
*   `Headers`
*   `RequestBody`
*   `ResponseBody`

æˆ‘å¸Œæœ›è¿™æ¼”ç¤ºäº†ä½¿ç”¨ SpringMVC æ³¨é‡Šå°†è¯·æ±‚æ˜ å°„åˆ°ä¸åŒçš„æ–¹æ³•æ˜¯å¤šä¹ˆå®¹æ˜“ï¼Œå¹¶ä¸”èŠ‚çœäº†æ‚¨åœ¨ API ç½‘å…³ä¸­ç®¡ç†æ˜ å°„çš„å·¥ä½œé‡ã€‚

æ‰€ä»¥ï¼Œè¿™å°±ç»“æŸäº†ã€‚æˆ‘å¸Œæœ›è¿™å¯¹ä½ çš„æ— æœåŠ¡å™¨ä¹‹æ—…æœ‰æ‰€å¸®åŠ©ã€‚åŒæ ·ï¼Œè¿™ä¸ªé¡¹ç›®çš„ä»£ç å¯ä»¥åœ¨ GitHub ä¸Šæ‰¾åˆ°ã€‚[https://github.com/cyberworkz/examples](https://github.com/cyberworkz/examples)åœ¨`online-library-java`æ–‡ä»¶å¤¹é‡Œã€‚

æ„Ÿè°¢é˜…è¯»ï¼

# æµ·ç§‘Â·èŒƒå¾·æ²™å¤«

*   ***å¦‚æœä½ å–œæ¬¢è¿™ä¸ªï¼Œè¯·è·Ÿéš Serverlesscorner.com ä¸Š***[](https://serverlesscorner.com/about)****ã€‚****
*   ****çˆ±æƒ…*** â¤ï¸ ***é˜…è¯»*** ***æˆ‘çš„æ•…äº‹å’Œå…¶ä»–å…³äºåª’ï¼Ÿ*** [***æˆä¸ºä¼šå‘˜***](https://serverlesscorner.com/membership) ***å¦‚æœä½ è¿˜ä¸æ˜¯ä¼šå‘˜ã€‚****
*   ****æƒ³é˜…è¯»æ›´å¤šæ— æœåŠ¡å™¨ï¼ŸæŠ¥åå‚åŠ æˆ‘çš„*** [***æœˆåˆŠ***](https://serverlessconsulting.org/newsletter) ***ğŸ“¬å…³äºæ— æœåŠ¡å™¨æŠ€æœ¯å’Œä½¿ç”¨æ¡ˆä¾‹çš„å¯å‘æ€§å’Œæ·±åˆ»çš„æ•…äº‹ã€‚****

# *å‚è€ƒ*

1.  *[https://docs . AWS . Amazon . com/server less-application-model/latest/developer guide/what-is-Sam . html](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html)*
2.  *[https://en.wikipedia.org/wiki/Inversion_of_control](https://en.wikipedia.org/wiki/Inversion_of_control)*
3.  *[https://docs . AWS . Amazon . com/API gateway/latest/developer guide/set-up-lambda-proxy-integrations . html](https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html)*