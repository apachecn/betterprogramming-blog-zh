# ä½¿ç”¨ UIMenuController å¹¶æ“ä½œå“åº”å™¨é“¾

> åŸæ–‡ï¼š<https://betterprogramming.pub/uimenucontroller-and-manipulating-the-responder-chain-c06fad73c64b>

## ä½¿ç”¨ Swift é€šè¿‡ UIMenuController å¤„ç†äº‹ä»¶çš„è¯¦ç»†æŒ‡å—

![](img/29362c7419c57d2b3732533e0638a920.png)

æœ¬æ–‡é‡ç‚¹ä»‹ç» UIMenuController åŠŸèƒ½ï¼Œä»¥åŠå®ƒå¦‚ä½•ä¸ UIResponder é“¾äº¤äº’æ¥å¤„ç†äº‹ä»¶ã€‚å®ƒå‡è®¾æ‚¨è‡³å°‘å¯¹è¿™ä¸¤è€…éƒ½æœ‰æ‰€äº†è§£ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰ï¼Œè¯·åœ¨ç»§ç»­ä¹‹å‰é˜…è¯»ä¸€ä¸‹ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨æœ€åæ‰¾åˆ°ä¸€ä¸ªè¿™æ ·çš„ä¾‹å­ã€‚

*   [UIMenuController API](https://developer.apple.com/documentation/uikit/uimenucontroller)
*   [ä¸è®°è€…åˆä½œ](https://developer.apple.com/documentation/uikit/touches_presses_and_gestures/using_responders_and_the_responder_chain_to_handle_events)

å¥½äº†ï¼Œç°åœ¨è®©æˆ‘ä»¬è¿›å…¥ä¸»è¦éƒ¨åˆ†ã€‚å½“æ˜¾ç¤º UIMenuController æ—¶ï¼Œå®ƒéœ€è¦æœ‰ä¸€ä¸ª firstResponder å¯¹è±¡ã€‚é€šå¸¸ï¼Œæ‚¨åªéœ€å°†ä¸Šé¢æ˜¾ç¤ºèœå•çš„è§†å›¾è®¾ç½®ä¸ºç¬¬ä¸€å“åº”è€…å°±å¯ä»¥äº†ï¼Œä½†æ˜¯å¦‚æœæ‚¨æƒ³åœ¨ä¸€ä¸ªè§†å›¾ä¸Šé¢æ˜¾ç¤ºè¿™ä¸ªèœå•ï¼Œè€Œå¦ä¸€ä¸ªè§†å›¾ä½œä¸ºç¬¬ä¸€å“åº”è€…å‘¢ï¼Ÿä¾‹å¦‚ï¼Œå½“ UITextView/UITextField å¤„äºæ´»åŠ¨çŠ¶æ€æ—¶ï¼Œç”¨æˆ·æ­£åœ¨é”®å…¥æŸäº›å†…å®¹ï¼Œè€Œæ— éœ€å…³é—­é”®ç›˜ã€‚å—¯ï¼Œæ­£å¥½æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥å¤„ç†è¿™ç§æƒ…å†µï¼Œä½†æ˜¯æ‚¨å¿…é¡»å¯¹å“åº”è€…é“¾è¿›è¡Œä¸€äº›æ“ä½œæ‰èƒ½å®ç°ã€‚å€¼å¾—åº†å¹¸çš„æ˜¯ï¼Œè‹¹æœå·²ç»è®©è¿™ä¸ªç›®æ ‡ç›¸å¯¹å®¹æ˜“å®ç°ã€‚

æˆ‘ä»¬è¦åšçš„æ˜¯è·å–ä¸¤ä¸ªç‹¬ç«‹çš„ UIResponder é“¾ï¼Œä¸€ä¸ªä»£è¡¨èœå•å‘ˆç°çš„è§†å›¾ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œæ°”æ³¡è§†å›¾â€ï¼Œå¦ä¸€ä¸ªä»£è¡¨ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬è§†å›¾ï¼Œç„¶ååˆå¹¶å®ƒä»¬ã€‚è¿™å°†æ˜¯åœ¨ä¿¡æ¯åŠŸèƒ½çš„èƒŒæ™¯ä¸‹ï¼Œç±»ä¼¼äº Instagram çš„èŠå¤©ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®©ç”¨æˆ·åœ¨èƒ½å¤Ÿé•¿æŒ‰æ¶ˆæ¯æ°”æ³¡æ¥æ‰§è¡Œæ“ä½œçš„åŒæ—¶è¾“å…¥æ¶ˆæ¯ã€‚

è¿™æ˜¯æˆ‘ä»¬ç›®æ ‡çš„ä¸€ä¸ªä¾‹å­:

![](img/7454b4281b364ac55b74f5b0976e2f6c.png)

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®å¹¶é™„åŠ ä¸€ä¸ªé•¿æŒ‰æ‰‹åŠ¿ï¼Œå®šåˆ¶ UIMenuController singletonï¼Œå¹¶åœ¨ presenting è§†å›¾ä¸­è¦†ç›–`canPerformAction`ä»¥ä½¿å…¶èƒ½å¤Ÿæ˜¾ç¤ºèœå•ã€‚æˆ‘å‡è®¾ä»ç°åœ¨å¼€å§‹å·²ç»å‡†å¤‡å¥½äº†ï¼Œä½†å¦‚æœä½ æƒ³äº†è§£æ›´å¤šç»†èŠ‚ï¼Œè¿™ç¯‡æ–‡ç« çš„åº•éƒ¨æœ‰å‚è€ƒèµ„æ–™ã€‚

æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½èœå•å¹¶å¼€å§‹è¿è¡Œï¼Œä½†æ˜¯æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°ä¸€ä¸ªé—®é¢˜ã€‚æ¯å½“èœå•å¼¹å‡ºæ—¶ï¼Œå®ƒä¼šéšè—é”®ç›˜ã€‚

![](img/dd88bd37e79adc3f82854f91a8ac6511.png)

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°†ç¨å¾®è°ƒæ•´ä¸€ä¸‹å“åº”é“¾ã€‚æœ¬è´¨ä¸Šï¼Œæˆ‘ä»¬éœ€è¦è¾“å…¥æ–‡æœ¬å­—æ®µä½œä¸ºç¬¬ä¸€å“åº”è€…ï¼Œä½†æ˜¯å¯¹äºè§†å›¾ï¼Œæˆ‘ä»¬æ˜¯åœ¨å†³å®šèœå•åœ¨å“ªé‡Œæ˜¾ç¤ºä»¥åŠæ˜¾ç¤ºä»€ä¹ˆåŠ¨ä½œã€‚è¿™æ˜¯é€šè¿‡ç”¨æˆ‘ä»¬ç‚¹å‡»çš„è§†å›¾æ›¿æ¢æ–‡æœ¬å­—æ®µçš„â€œä¸‹ä¸€ä¸ªå“åº”è€…â€å¯¹è±¡æ¥å®ç°çš„ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å­ç±»åŒ– UITextField å’Œ override `nextResponder`å¹¶æä¾›æˆ‘ä»¬è‡ªå·±çš„è¦†ç›–ã€‚è¿™ä¸ªè¦†ç›–å°†æ˜¯ä»ä¸Šé¢çš„â€œæ°”æ³¡è§†å›¾â€ã€‚

```
weak var nextResponderOverride: UIResponder?override var next: UIResponder? {
  if nextResponderOverride != nil {
    return nextResponderOverride
  } else {
    return super.next
  }
}
```

é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¦†ç›– UITextField ä¸Šçš„`canPerformAction`æ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å…è®¸è¢«è¦†ç›–çš„`nextResponder`åšå‡ºå†³å®šã€‚è¿™å°†æ˜¯æˆ‘ä»¬å¦‚ä½•å…è®¸æ–‡æœ¬å­—æ®µâ€œå‡è£…â€å®ƒå¯ä»¥ç¨åæ‰§è¡Œ UIMenuController çš„æ“ä½œã€‚

```
override func canPerformAction(_ action: Selector, withSender sender: Any?) -> Bool {
  if nextResponderOverride != nil {
    return false
  } else {
    return super.canPerformAction(action, withSender: sender)
  }
}
```

è¿™é‡Œå‘ç”Ÿçš„äº‹æƒ…çš„è¦ç‚¹æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å·²ç»è®¾ç½®äº†`nextResponderOverride`ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›â€œæ°”æ³¡è§†å›¾â€æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œé‚£ä¹ˆæ— è®ºå¦‚ä½•æˆ‘ä»¬éƒ½ä¼šè¿”å› falseã€‚è¿™å¯¼è‡´ UIMenuController æ£€æŸ¥æ–‡æœ¬è§†å›¾çš„`next`å“åº”å™¨ï¼Œæˆ‘ä»¬å·²ç»å°†å…¶è¦†ç›–ä¸ºæˆ‘ä»¬çš„â€œæ°”æ³¡è§†å›¾â€ï¼Œè¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº†å“åº”å™¨é“¾çš„äº¤æ¢ã€‚

ç°åœ¨å‰©ä¸‹å”¯ä¸€è¦åšçš„äº‹æƒ…å°±æ˜¯è®¾ç½®æˆ‘ä»¬çš„â€œæ°”æ³¡è§†å›¾â€æ¥å¤„ç†æœŸæœ›çš„åŠ¨ä½œã€‚æˆ‘ä»¬é€šè¿‡ä»¥ä¸‹æ–¹å¼åšåˆ°è¿™ä¸€ç‚¹:

```
// Ensure our bubble view can be the first responder
override var canBecomeFirstResponder: Bool {
  return true
}// Set it to be able to perform desired actions
override func canPerformAction(_ action: Selector, withSender sender: Any?) -> Bool {
  // Extend this to check for all actions
  if action == #selector(oneMethod) { 
    return true
  } else {
    return false
  }
}
```

ç°åœ¨ï¼Œå½“ä½ æ‰“å¼€é”®ç›˜å¹¶è§¦å‘ä½ çš„èœå•æ˜¾ç¤ºæ—¶ï¼Œå®ƒä¼šæ˜¾ç¤ºå‡ºæ¥ï¼Œè€Œä¸éœ€è¦æ¥ç®¡å’Œéšè—é”®ç›˜ï¼ğŸ‰

è¯·åœ¨ä¸‹é¢ç•™ä¸‹æ‚¨åœ¨å®æ–½æ—¶é‡åˆ°çš„ä»»ä½•é—®é¢˜æˆ–å›°éš¾çš„è¯„è®ºã€‚

å¾ˆå¿«è¿˜ä¼šæœ‰ä¸€ç¯‡åç»­æ–‡ç« ï¼Œå°†æ¶µç›–ä¸€äº›åœ¨æ„å»ºè¿™ç§ç”¨æˆ·äº¤äº’æ—¶å¯èƒ½å‡ºç°çš„è¾¹ç¼˜æƒ…å†µé”™è¯¯ï¼Œä¾‹å¦‚é•¿æŒ‰æ–‡æœ¬å­—æ®µæ—¶æ“ä½œè¢«å¤åˆ¶ã€‚ä½ å¯ä»¥åœ¨ä¸‹é¢çš„ä¾‹å­å’Œ Instagram çš„èŠå¤©åŠŸèƒ½ä¸­çœ‹åˆ°è¿™ç§æƒ…å†µã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªè¿™æ–¹é¢çš„ä¾‹å­:[https://github.com/alexpersian/MenuItemTester](https://github.com/alexpersian/MenuItemTester)

å †æ ˆæº¢å‡ºå‚è€ƒç­”æ¡ˆ:[https://stackoverflow.com/a/23849955/3434244](https://stackoverflow.com/a/23849955/3434244)