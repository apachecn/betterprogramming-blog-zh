# ä»¥å¤ªåŠ DApp ç”¨ Ethers.js å’Œ IPFS ç”¨ Angularï¼ŒAngular Material å’Œ NgRxã€‚ç¬¬ä¸€éƒ¨åˆ†

> åŸæ–‡ï¼š<https://betterprogramming.pub/ethereum-dapp-with-ethers-js-and-ipfs-using-angular-angular-material-and-ngrx-part-i-dcf049430cbf>

![](img/536c709bd2fef24db76bb961558878db.png)

å›¾ç‰‡ç”±æ¥è‡ª [Pixabay](https://pixabay.com/?utm_source=link-attribution&utm_medium=referral&utm_campaign=image&utm_content=3342242) çš„[æ–¯è’‚èŠ¬Â·å‡¯å‹’](https://pixabay.com/users/KELLEPICS-4893063/?utm_source=link-attribution&utm_medium=referral&utm_campaign=image&utm_content=3342242)æ‹æ‘„

## è¿™æ˜¯æˆ‘ä»¬æ­£åœ¨è¿›è¡Œçš„ç³»åˆ—å·¥ä½œçš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œæ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Angular å’Œ NgRx æ„å»ºæ‰˜ç®¡æ™ºèƒ½åˆçº¦ DAppã€‚

åœ¨[ä¸Šä¸€ç¯‡æ–‡ç« ](https://medium.com/coinmonks/https-medium-com-alexanddanik-ethereum-dapp-with-angular-angular-material-and-ngrx-f2c91435871b)ä¸­ï¼Œæˆ‘ä»¬å¼€å§‹æ¢ç´¢ä½¿ç”¨ Angular NgRx æ„å»ºä»¥å¤ªåŠæ™ºèƒ½åˆçº¦ DApp çš„æŠ€æœ¯ã€‚

åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥ç ”ç©¶ä¸€ä¸ªæ›´å¤æ‚ã€æ›´æœ‰è¶£çš„åä¸º *FleaMarket* çš„ Solidity Escrow æ™ºèƒ½åˆåŒæ¡ˆä¾‹ã€‚å»ºé€ è¿™åº§ DApp çš„çµæ„Ÿæ¥æºäº[Jackson Ng](https://medium.com/coinmonks/smart-contract-explained-by-demonstration-93b06e938474)å‘è¡¨çš„[åšå®¢](https://medium.com/coinmonks/smart-contract-explained-by-demonstration-93b06e938474)ã€‚

# è®¾è®¡ FleaMarket æ‰˜ç®¡æ™ºèƒ½åˆåŒ

åœ¨æˆ‘ä»¬å‡ºå”®çš„æ¯ä¸ªæ–°äº§å“ä¸Šï¼Œ`FleaMarket` æ‰˜ç®¡æ™ºèƒ½åˆçº¦å°†äº§ç”Ÿä¸€ä¸ªæ–°çš„*å­*äº§å“åˆçº¦ï¼Œç”±`SafeRemotePurchase` æ™ºèƒ½åˆçº¦è¡¨ç¤ºã€‚æˆ‘ä»¬æŒ‰ç…§ä»¥ä¸‹è¦æ±‚å¤„ç† Solidity CRUD æ¨¡å¼çš„å®ç°:

*   æ¯ä¸ªäº§å“éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„å¯†é’¥ï¼›
*   ç¡®ä¿é”®çš„å”¯ä¸€æ€§ï¼›
*   æ’å…¥å¸¦æœ‰å¯†é’¥æ ‡è¯†ç¬¦çš„äº§å“ï¼›
*   é€šè¿‡äº§å“çš„å…³é”®æ ‡è¯†ç¬¦æ£€ç´¢äº§å“ï¼›
*   é€šè¿‡äº§å“çš„å…³é”®æ ‡è¯†ç¬¦åˆ é™¤äº§å“ï¼›
*   è·å¾—ç°æœ‰äº§å“çš„æ•°é‡ï¼›
*   è¿­ä»£äº§å“ã€‚

å¹¸è¿çš„æ˜¯ï¼Œ[é«˜æ¸…é’±åŒ…æä¾›å•†](https://medium.com/u/391d8f396987#readme):

```
npm install --save truffle-hdwallet-provider
```

åœ¨`truffle-config.js,`ä¸­æ·»åŠ  Ropsten ç½‘ç»œå®šä¹‰:

è¿™é‡Œï¼Œ`mnemonic`æ˜¯ä¸€ä¸ªç”±æˆ‘ä»¬çš„ hdwallet æä¾›è€…ä½¿ç”¨çš„ 12 ä¸ªå­—çš„ç§˜å¯†åŠ©è®°çŸ­è¯­ï¼Œ`infuraProjectToken` æ˜¯ç”± Infura æˆæƒçš„`Project ID`ã€‚

[æ³¨æ„](https://github.com/trufflesuite/truffle-hdwallet-provider#readme)å¦‚æœæˆ‘ä»¬è·³è¿‡`HDWalletProvider`æ„é€ å‡½æ•°ä¸­çš„æœ€åä¸€ä¸ªå‚æ•°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè´Ÿè´£æ™ºèƒ½åˆçº¦éƒ¨ç½²çš„å¸æˆ·å°†æ˜¯åŠ©è®°ç¬¦ç”Ÿæˆçš„ç¬¬ä¸€ä¸ªå¸æˆ·ã€‚å¦‚æœæˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªç‰¹å®šçš„ç´¢å¼•ï¼Œå®ƒå°†ä½¿ç”¨é‚£ä¸ªåœ°å€(ç´¢å¼•æ˜¯ä»é›¶å¼€å§‹çš„)ã€‚

# éƒ¨ç½²å’ŒéªŒè¯æ™ºèƒ½åˆåŒ

å‡ºäºæœ¬åº”ç”¨ç¨‹åºçš„ç›®çš„ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Ropsten ç½‘ç»œä¸Šæœ‰ä¸‰ä¸ªä¸æˆ‘ä»¬çš„åŠ©è®°é”®ç›¸å…³è”çš„æµ‹è¯•å¸æˆ·:

![](img/051fff867ea7123d7f752e1bd2233d7e.png)

éªŒè¯æˆ‘ä»¬åœ¨åŒºå—é“¾ä¸Šä½¿ç”¨çš„å¸æˆ·æ˜¯å¦æ­£ç¡®çš„å¿«é€Ÿæ–¹æ³•æ˜¯æ‰“å¼€ Truffle æ§åˆ¶å°:

![](img/56fc56c632fd087c69f0f4f50f0953fa.png)

æˆ‘ä»¬å¯ä»¥ç¡®è®¤`account[0]`ä¸æˆ‘ä»¬åœ¨å…ƒæ©ç ä¸­æŒ‡å®šçš„ç¬¬ä¸€ä¸ªå¸æˆ·*ä¸»éƒ¨ç½²è€…*ç›¸åŒã€‚ä¸ºäº†å°†æˆ‘ä»¬çš„æ™ºèƒ½åˆçº¦éƒ¨ç½²åˆ° Ropsten ç½‘ç»œï¼Œæˆ‘ä»¬è¿è¡Œä»¥ä¸‹å‘½ä»¤:

`truffle migrate --compile-all --reset --network ropsten`

ä¸ºäº†éªŒè¯æ™ºèƒ½åˆçº¦å·²ç»éƒ¨ç½²åœ¨ Ropsten åŒºå—é“¾ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­æ‰§è¡Œ[ä»¥å¤ªæ‰«æ](https://ropsten.etherscan.io/)å¹¶æ£€æŸ¥æˆ‘ä»¬åœ¨`HDWalletProvider`æ„é€ å‡½æ•°ä¸­æŒ‡å®šçš„ä»¥å¤ªåŠé’±åŒ…å¸æˆ·ã€‚

![](img/292f136281819e074d307de8a80885b4.png)

ç°åœ¨æ˜¯æ£€éªŒæˆ‘ä»¬æ™ºèƒ½åˆçº¦çš„æ—¶å€™äº†ã€‚åœ¨æˆ‘ä»¬è¿è¡Œæµ‹è¯•ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä» [Chai åº“](https://www.chaijs.com/)ä¸­å®‰è£…å¦å¤–ä¸¤ä¸ªä¾èµ–é¡¹:

```
npm install --save-dev chai
npm install --save-dev chai-as-promised
```

ç¬¬ä¸€ä¸ªåº“ç”¨äºåœ¨ Chai ä¸­ä½¿ç”¨æ–­è¨€ã€‚ç¬¬äºŒä¸ªæ˜¯æµ‹è¯• JavaScript æ‰¿è¯ºã€‚

æˆ‘ä»¬å°†æŠŠå•å…ƒæµ‹è¯•åˆ†æˆä¸¤ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚åœ¨ç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›ç¡®è®¤ FleaMarket æ™ºèƒ½å¥‘çº¦å·²ç»æˆåŠŸéƒ¨ç½²ï¼Œå¹¶ä¸”å…·æœ‰æœ‰æ•ˆçš„åœ°å€å’Œåç§°ã€‚

åœ¨ç¬¬äºŒä¸ªæµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œæˆ‘ä»¬åŒ…æ‹¬äº†éªŒè¯æ™ºèƒ½åˆçº¦åŠŸèƒ½çš„ä¸åŒæ–¹é¢çš„æ–¹æ³•ã€‚

# è®¾ç½®è§’åº¦é¡¹ç›®

è®©æˆ‘ä»¬ä»å®‰è£… Angular CLI çš„æœ€æ–°ä¸»è¦ç‰ˆæœ¬å¼€å§‹ã€‚

`npm install -g @angular/cli`

è¦åˆ›å»ºæ–°çš„ Angular é¡¹ç›®ï¼Œè¯·åœ¨ Truffle é¡¹ç›®çš„æ ¹æ–‡ä»¶å¤¹ä¸­æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯ï¼Œå¹¶è¿è¡Œä»¥ä¸‹ CLI å‘½ä»¤:

`ng new ClientApp --skip-install=true --minimal=true --style=css --routing=true --skipGit=true`

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡è¿è¡Œä»¥ä¸‹ç¤ºæ„å›¾å®‰è£…[è§’å½¢ææ–™](https://material.angular.io/)ã€:

`ng add @angular/material`

è®©æˆ‘ä»¬é€šè¿‡è¿è¡Œ`navigation`ç¤ºæ„å›¾å‘åº”ç”¨ç¨‹åºæ·»åŠ ä¸€ä¸ªå¯¼èˆªç»„ä»¶ã€‚

`ng generate @angular/material:nav nav`

æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ææ–™ç¤ºæ„å›¾æ·»åŠ ä»ªè¡¨æ¿ç»„ä»¶:

```
ng generate @angular/material:dashboard dashboard
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®‰è£… [Flex-layout](https://github.com/angular/flex-layout) æ¨¡å—ï¼Œè¿™æ˜¯ä¸€ä¸ªä¼˜ç§€çš„å¸ƒå±€å¼•æ“ï¼Œæœ‰åŠ©äº CSS flex-box ç‰¹æ€§:

`npm install @angular/flex-layout --save`

ä¸‹ä¸€ä»¶äº‹æ˜¯è¿æ¥ [@NgRx](https://ngrx.io/guide/store) çŠ¶æ€ç®¡ç†åº“ï¼Œå®ƒä½äºæˆ‘ä»¬åº”ç”¨ç¨‹åºè®¾è®¡çš„æ ¸å¿ƒã€‚

`npm install @ngrx/store, @ngrx/effects, @ngrx/router-store, @ngrx/entity, @ngrx/store-devtools, ngrx-store-freeze --save`

æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨æ–°çš„ NgRx ç‰ˆæœ¬ 8ï¼Œå®ƒæ”¯æŒè®¸å¤šå¾ˆé…·çš„é™„åŠ åŠŸèƒ½å’Œæœªæ¥åŠŸèƒ½ï¼Œå¦‚`createAction`ã€`createReducer` å’Œ`createEffect` åŠŸèƒ½ã€‚Alex Okrushko åœ¨ä»–æœ€è¿‘çš„æ–‡ç« ä¸­å¾ˆå¥½çš„è§£é‡Šäº†ä½¿ç”¨å®ƒä»¬çš„å¥½å¤„ã€‚

æ¥ä¸‹æ¥ä½†åŒæ ·é‡è¦çš„æ˜¯ï¼Œä¸ºäº†ä¸ä»¥å¤ªåŠåŒºå—é“¾è¿›è¡Œäº¤äº’ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ç”± [RicMoo](https://medium.com/u/889387e95e0b?source=post_page-----dcf049430cbf--------------------------------) (æ¯›åˆ©å°äº”éƒ)*å¼€å‘çš„ [Ethers.js](https://github.com/ethers-io/ethers.js/) åº“ã€‚*

`npm install ethers --save`

# æ ¹çŠ¶æ€å’Œä¿æŠ¤

NgRx ä¸­çš„åº”ç”¨ç¨‹åºçŠ¶æ€æ˜¯å•ä¸ªä¸å¯å˜çš„æ•°æ®æ ‘ç»“æ„ã€‚ä¸€æ—¦`AppModule` è¢«åŠ è½½ï¼ŒçŠ¶æ€æ ‘å°†ä»æ ¹çŠ¶æ€å¼€å§‹ã€‚

æ ¹çŠ¶æ€åœ¨æ‰€æœ‰ç»„ä»¶ä¹‹é—´å…¨å±€å…±äº«ã€‚éšç€æ›´å¤šçš„[å»¶è¿ŸåŠ è½½çš„è§’åº¦æ¨¡å—](https://ultimatecourses.com/blog/ngrx-store-understanding-state-selectors)è¢«åŠ è½½åˆ°åº”ç”¨ç¨‹åºä¸­ï¼Œå®ƒçš„å¤§å°å°†ç»§ç»­å¢é•¿ã€‚æˆ‘ä»¬å°†æ ¹çŠ¶æ€æ¥å£å®šä¹‰å¦‚ä¸‹:

å®ƒç”±è·¯ç”±å™¨çŠ¶æ€ã€å¾®è°ƒå™¨çŠ¶æ€ã€é”™è¯¯çŠ¶æ€å’Œ web3Provider çŠ¶æ€ç»„æˆã€‚

*   **å¾®è°ƒå™¨çŠ¶æ€**è´Ÿè´£åˆ‡æ¢åœ¨åŠ è½½å™¨ç»„ä»¶ä¸­å®šä¹‰çš„åŠ è½½æŒ‡ç¤ºå™¨çš„æ˜¾ç¤ºã€‚æˆ‘ä»¬é€šè¿‡å‘å•†åº—åˆ†æ´¾ä»¥ä¸‹åŠ¨ä½œæ¥ç®¡ç†å¾®è°ƒå™¨çŠ¶æ€:

*   **é”™è¯¯çŠ¶æ€**æ­£åœ¨ç›‘å¬åŠ¨ä½œ:

å®ƒçš„å‰¯ä½œç”¨æ˜¯:

å¦å¤–ï¼Œæœ€è¿‘æœ‰ä¸€äº›å…³äºå¦‚ä½•æ­£ç¡®ç®¡ç† NgRx å­˜å‚¨ä¸­çš„åŠ è½½æˆ–é”™è¯¯çŠ¶æ€çš„éå¸¸æœ‰è¶£çš„è®¨è®ºã€‚å…³äºè¿™ä¸ªè¯é¢˜è¯·æ£€æŸ¥[è¿™ä¸ª](https://blog.angularindepth.com/handling-error-states-with-ngrx-6b16f6d12a08)å’Œ[è¿™ä¸ª](https://blog.angularindepth.com/having-fun-with-state-in-angular-a48932d2fa27)ã€‚

*   web3Provider çš„æ ¹çŠ¶æ€æ˜¯ä¹è¶£çš„å¼€å§‹ã€‚å®ƒå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼Œ

è´Ÿè´£ç›‘æ§ DApp å’ŒåŒºå—é“¾ä»¥å¤ªåŠä¹‹é—´çš„é€šé“ã€‚

æˆ‘ä»¬ä½¿ç”¨çš„æ–¹æ³•éå¸¸ç±»ä¼¼äº GrandSchtroumpf æ’°å†™çš„åšå®¢ä¸­è®¨è®ºçš„æƒ³æ³•ã€‚ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨ MetaMask ä¸ä»¥å¤ªåŠç½‘ç»œé€šä¿¡ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ç›¸åº”çš„ ethers.js web3 æä¾›ç¨‹åºã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰äº†å¯æ‘‡æ ‘`InjectionToken` `MetamaskWeb3Provider`ï¼Œå¹¶æŒ‡ç¤ºå®ƒæ³¨å…¥å…ƒæ©ç `windows.ethereum.`æ³¨å…¥çš„ä»¥å¤ªåŠ web3 æä¾›è€…

ç„¶åï¼Œæˆ‘ä»¬æ‰©å±• ethers . js[web 3 provider provider](https://docs.ethers.io/ethers.js/html/cookbook-providers.html?highlight=metamask)å¹¶å°†`MetamaskWeb3Provider`ä»¤ç‰Œæ³¨å…¥å…¶æ„é€ å‡½æ•°ã€‚ä¸ºäº†è®¿é—®åŒºå—é“¾ä¸Šçš„ç”¨æˆ·å¸æˆ·ï¼ŒMetaMask è¦æ±‚æˆ‘ä»¬è°ƒç”¨å…¶æœ¬æœº web3 æä¾›è€…ä¸Šçš„`enable()`æ–¹æ³•ã€‚æˆ‘ä»¬é€šè¿‡ç›‘å¬`'[Web3/Provider] Init]`åŠ¨ä½œæ¥ç®¡ç†`metaMaskEnable$`æ•ˆæœã€‚

è¿™æ˜¯å¹•åå‘ç”Ÿçš„äº‹æƒ…ã€‚æˆ‘ä»¬å¼•å…¥äº†`EthInitGuard`ï¼Œæˆ‘ä»¬æ„å»ºå®ƒæ¥æ§åˆ¶è·¯ç”±è§£æè¿‡ç¨‹ã€‚

è­¦å«æ­£åœ¨è§‚å¯Ÿå›½å®¶çš„è´¢äº§ã€‚å¦‚æœè¯¥å€¼ä¸ºå‡ï¼Œè­¦å«å°†è°ƒåº¦`'[Web3/Provider] Init]`åŠ¨ä½œï¼Œå‘åŒºå—é“¾å¹¿æ’­è¿æ¥ä»¥å¤ªåŠçš„è¯·æ±‚ã€‚

è¿™ç§æ–¹æ³•çš„æœ€å¤§å¥½å¤„æ˜¯ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥æ§åˆ¶ç”¨æˆ·æ‰¹å‡†çš„å¸æˆ·è®¿é—®çš„å…ƒæ©ç å¼¹å‡ºçª—å£ã€‚

ä¸€æ—¦æˆ‘ä»¬ç¼–è¯‘å¹¶è¿è¡Œè¯¥åº”ç”¨ç¨‹åºï¼Œå®ƒå°†åŠ è½½æˆ‘ä»¬çš„æ ¹çŠ¶æ€ï¼Œå¹¶äº§ç”Ÿä»¥ä¸‹ä¸»é¡µ:

![](img/0040fb0f34f6a5b3042dd9fff5865c70.png)

å¦‚æœæˆ‘ä»¬è¯•å›¾å¯¼èˆªåˆ°ç”±`EthInitGuard`ä¿æŠ¤çš„ä»»ä½•å…¶ä»–è·¯çº¿ï¼Œå®ƒå°†è§¦å‘æ¥è‡ª MetaMask çš„æ‰¹å‡†å¼¹å‡ºçª—å£ï¼Œè¯·æ±‚è®¿é—®ç”¨æˆ·å¸æˆ·çš„è®¸å¯ã€‚

![](img/5321cdd79456a4aa12153c25522d547c.png)

è°¢è°¢å¤§å®¶ï¼è¯·ç»§ç»­å…³æ³¨æœ¬åšå®¢ç³»åˆ—çš„å…¶ä»–æ–‡ç« ã€‚

# å‚è€ƒ

*   [å»ºç­‘ä»¥å¤ªåŠ DApp ç”¨æ£±è§’ã€æ£±è§’åˆ†æ˜çš„ææ–™å’Œ NgRx](https://www.amazon.com/dp/B085B918LG) ï¼Œ*å¯åœ¨*[*http://www.amazon.co.uk/kindlestore*](http://www.amazon.co.uk/kindlestore)*2020 å¹´ 3 æœˆ 5 æ—¥*ç”±[äºšå†å…‹æ–¯Â·å¶å¤«è°¢ç»´å¥‡](https://medium.com/u/4f27e57aa12a?source=post_page-----dcf049430cbf--------------------------------)

ğŸ‘ç‰¹åˆ«æ„Ÿè°¢[è¿ˆå…‹Â·å‰æœ¬æ–¯](https://www.linkedin.com/in/mike-gibbons-8357a510a/)å®¡é˜…æœ¬æ–‡ã€‚