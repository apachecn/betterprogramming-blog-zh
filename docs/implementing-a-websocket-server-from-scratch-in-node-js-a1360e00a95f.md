# åœ¨ Node.js ä¸­å®ç° WebSocket æœåŠ¡å™¨

> åŸæ–‡ï¼š<https://betterprogramming.pub/implementing-a-websocket-server-from-scratch-in-node-js-a1360e00a95f>

## é€šè¿‡è¿™ä¸ªå¿«é€ŸæŒ‡å—æ¢ç´¢å’Œå­¦ä¹  WebSockets çš„å†…éƒ¨åŸç†

![](img/b04b7bcb7bb061e4ef260ce16ad275ea.png)

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä»å¤´å®ç°ä¸€ä¸ªç®€å•çš„ WebSocket æœåŠ¡å™¨æ¥æ¢ç´¢ WebSockets å¦‚ä½•åœ¨åè®®å±‚å†…éƒ¨å·¥ä½œã€‚å®ƒæ—¨åœ¨æ¶µç›–å®¢æˆ·æœº-æœåŠ¡å™¨å¼€æ”¾æ¡æ‰‹å’Œæ•°æ®ç»„å¸§çš„åŸºç¡€çŸ¥è¯†ã€‚

ä½œä¸ºæˆ‘ä»¬çš„ä¸»è¦äº‹å®æ¥æºï¼Œæˆ‘ä»¬å°†å‚è€ƒå®˜æ–¹çš„ WebSocket åè®®è§„èŒƒâ€” [RFC 6455](https://www.rfc-editor.org/rfc/rfc6455) ï¼Œå°¤å…¶æ˜¯ç¬¬ 1 èŠ‚å’Œç¬¬ 4â€“7 èŠ‚ğŸ¤“

å¯¹äºæˆ‘ä»¬çš„ä»£ç ç¤ºä¾‹ï¼Œæˆ‘å°†ä½¿ç”¨ Node.js v18.12.1ã€‚

# **1ã€‚èƒŒæ™¯**

WebSocket æ˜¯ä¸€ç§é€šä¿¡åè®®ï¼Œå®ƒåœ¨å•ä¸ª TCP/IP è¿æ¥ä¸Šè¿è¡Œï¼Œå¹¶åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´æä¾›åŒå‘å…¨åŒå·¥é€šé“ã€‚

ä¸ HTTP è¯·æ±‚-å“åº”èŒƒä¾‹ç›¸åï¼Œå®ƒæœ‰åŠ©äºé€šè¿‡æŒä¹…è¿æ¥è¿›è¡Œå®æ—¶çš„å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶ˆæ¯äº¤æ¢ï¼Œå¯¹äºéœ€è¦å®æ—¶æ•°æ®æ›´æ–°çš„ web åº”ç”¨ç¨‹åºå°¤å…¶æœ‰ç”¨ã€‚

æ­£å¦‚ RFC 6455 çš„æ‘˜è¦æ‰€è¯´ï¼Œ

> è¯¥æŠ€æœ¯çš„ç›®æ ‡æ˜¯ä¸ºåŸºäºæµè§ˆå™¨çš„åº”ç”¨ç¨‹åºæä¾›ä¸€ç§æœºåˆ¶ï¼Œè¿™ç§æœºåˆ¶éœ€è¦ä¸æœåŠ¡å™¨è¿›è¡ŒåŒå‘é€šä¿¡ï¼Œè€Œä¸ä¾èµ–äºæ‰“å¼€å¤šä¸ª HTTP è¿æ¥(ä¾‹å¦‚ï¼Œä½¿ç”¨ XMLHttpRequest æˆ– s å’Œé•¿è½®è¯¢)ã€‚

æœ¬è´¨ä¸Šï¼ŒWebSockets æ˜¯ TCP/IP æ ˆä¹‹ä¸Šçš„ä¸€ä¸ªè–„çš„ä½å¼€é”€ä¼ è¾“å±‚ã€‚

åœ¨æœ¬æ–‡æ¥ä¸‹æ¥çš„éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºè¯¥åè®®çš„ä¸€äº›ç»†èŠ‚ï¼Œè¿˜å°†é€æ­¥æ„å»ºæˆ‘ä»¬çš„ WebSocket æœåŠ¡å™¨ã€‚

# 2.åè®®æ¦‚è¿°

WebSockets è¿è¡Œåœ¨ä¸€ä¸ªæŒä¹…çš„ TCP è¿æ¥ä¸Šï¼Œä½†æ˜¯å®ƒæ˜¯ç”±ä¸€ä¸ªç‰¹æ®Šçš„ HTTP å‡çº§è¯·æ±‚å»ºç«‹çš„ã€‚åœ¨æ‚¨çš„é¡¹ç›®ä¸­ä½¿ç”¨ WebSockets æ—¶ï¼Œæ‚¨å¯èƒ½ç»å¸¸ä¼šåœ¨æµè§ˆå™¨çš„ Network é€‰é¡¹å¡ä¸­çœ‹åˆ°è¿™æ ·ä¸€ä¸ªè¯·æ±‚çš„ç»“æœã€‚

æ ¹æ® RFC ç¬¬ 1.7 èŠ‚ä¸­çš„[:](https://www.rfc-editor.org/rfc/rfc6455#section-1.7)

> WebSocket åè®®æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åŸºäº TCP çš„åè®®ã€‚å®ƒä¸ HTTP çš„å”¯ä¸€å…³ç³»æ˜¯å®ƒçš„æ¡æ‰‹è¢« HTTP æœåŠ¡å™¨è§£é‡Šä¸ºå‡çº§è¯·æ±‚ã€‚

åŸºæœ¬ä¸Šï¼Œè¦å¯åŠ¨ WebSocket æœåŠ¡å™¨ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆåˆ›å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œç„¶åæ ¹æ®æ¥è‡ªå®¢æˆ·ç«¯çš„å‡çº§è¯·æ±‚æ‰§è¡Œä¸€ä¸ªå¼€æ”¾å¼æ¡æ‰‹ï¼Œè¿™å°†å¯¼è‡´åè®®ä» HTTP åˆ‡æ¢åˆ° WebSocketsã€‚

è®©æˆ‘ä»¬é¦–å…ˆé€šè¿‡åˆ›å»ºä¸€ä¸ªæ–‡ä»¶`ws.js`å¹¶å£°æ˜ä¸€ä¸ªç±»`WebSocketServer`æ¥å®ç°æˆ‘ä»¬çš„æœåŠ¡å™¨:

æˆ‘ä»¬æ­£åœ¨æ‰©å±•`EventEmitter`ï¼Œå› ä¸ºå°†æ¥æˆ‘ä»¬çš„æœåŠ¡å™¨å°†éœ€è¦èƒ½å¤Ÿå‘å‡ºå’Œè®¢é˜…åƒ`open`ã€`upgrade`ã€`data`ç­‰äº‹ä»¶ã€‚

æœåŠ¡å™¨æœ¬èº«å°†åœ¨è¯¥ç±»çš„`_init`æ–¹æ³•ä¸­åˆ›å»º:

é™¤äº†å‡çº§ä¹‹å¤–ï¼Œæˆ‘ä»¬çœŸçš„ä¸æƒ³å¤„ç†ä»»ä½• HTTP è¯·æ±‚ï¼Œæ‰€ä»¥å¯¹äºæ‰€æœ‰ä¼ å…¥çš„ HTTP è¯·æ±‚ï¼Œæˆ‘ä»¬ç”¨`426 Upgrade Required`é”™è¯¯è¿›è¡Œå“åº”ğŸš«ã€‚è¿™è¡¨æ˜æˆ‘ä»¬çš„æœåŠ¡å™¨æ‹’ç»ä½¿ç”¨ HTTP åè®®å¤„ç†è¯·æ±‚ï¼Œä½†æ˜¯æ„¿æ„ä½¿ç”¨æ¥è‡ª`Upgrade`å¤´çš„åè®®æ¥å¤„ç†è¯·æ±‚ã€‚

åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¹¶å®ç°ä¸€ä¸ªå®é™…çš„åè®®å‡çº§(ä¸€ä¸ªå¼€æ”¾çš„ WebSocket æ¡æ‰‹)ã€‚

# 3.å¼€åœºæ¡æ‰‹

WebSocket è¿æ¥æ˜¯ç”±å‘èµ·â€œå¼€å§‹æ¡æ‰‹â€çš„å®¢æˆ·ç«¯åˆ›å»ºçš„ã€‚ç„¶åï¼ŒæœåŠ¡å™¨å¿…é¡»é€šè¿‡ç”¨ç‰¹å®šçš„å¤´è¿›è¡Œå“åº”æ¥å®Œæˆæ¡æ‰‹ã€‚ä¹‹åï¼Œåˆå§‹çš„ HTTP è¿æ¥è¢«ä½¿ç”¨ç›¸åŒ TCP å¥—æ¥å­—çš„ WebSocket è¿æ¥æ‰€å–ä»£ã€‚

RFC çš„ç¬¬ 4 éƒ¨åˆ†[æè¿°äº†å¼€åœºæ¡æ‰‹ï¼Œéå¸¸ç®€å•æ˜äº†ã€‚](https://www.rfc-editor.org/rfc/rfc6455#section-4)

å®¢æˆ·ç«¯é€šè¿‡å‘é€å¸¦æœ‰ä»¥ä¸‹æŠ¥å¤´çš„ HTTP GET è¯·æ±‚æ¥å‘èµ·æ¡æ‰‹:

```
GET / HTTP/1.1
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Key: kB2x1cO5zjL1ynwrLTSXUQ==
Sec-WebSocket-Version: 13
```

`Connection`å’Œ`Upgrade`å¤´çš„ç»„åˆå‘æœåŠ¡å™¨å‘å‡ºå®¢æˆ·æœºè¯·æ±‚å»ºç«‹ WebSocket è¿æ¥çš„ä¿¡å·ã€‚

`Sec-WebSocket-Version`ä»£è¡¨è§„èŒƒçš„ç‰ˆæœ¬ã€‚æ ¹æ®è§„èŒƒï¼Œè¿™ä¸ªå¤´å­—æ®µçš„å€¼å¿…é¡»æ˜¯ 13ã€‚

`Sec-WebSocket-Key`æ˜¯ä¸€ä¸ªéšæœºç”Ÿæˆçš„å¯¹å®¢æˆ·ç«¯å”¯ä¸€çš„å­—ç¬¦ä¸²ã€‚æ ¹æ® RFCï¼Œè¿™ä¸ªå¤´çš„å€¼æ˜¯ä¸€ä¸ªéšæœºæ•°ï¼Œç”±éšæœºé€‰æ‹©çš„ 16 å­—èŠ‚å€¼ç»„æˆï¼Œè¯¥å€¼å·²ç»è¿‡ base64 ç¼–ç ã€‚å¿…é¡»ä¸ºæ¯ä¸ªè¿æ¥éšæœºé€‰æ‹©éšæœºæ•°([ç¬¬ 4.1 èŠ‚](https://www.rfc-editor.org/rfc/rfc6455#section-4.1))ã€‚

`Sec-WebSocket-Key`çš„å€¼ç”¨äºåˆ›å»ºæœåŠ¡å™¨çš„æ¡æ‰‹ï¼Œä»¥è¡¨ç¤ºæ¥å—è¿æ¥ã€‚

è¦æ¥å—ä¼ å…¥çš„è¿æ¥ï¼ŒæœåŠ¡å™¨å¿…é¡»ç”¨çŠ¶æ€ä¸º`101 Switching Protocols`çš„ HTTP å“åº”è¿›è¡Œå“åº”ã€‚

å“åº”å¿…é¡»åŒ…å«ä¸€ä¸ª`Sec-WebSocket-Accept`å¤´ï¼Œå…¶å€¼é€šè¿‡ä»¥ä¸‹æ–¹å¼ç”Ÿæˆ:

*   æœåŠ¡å™¨å¿…é¡»è·å–`Sec-WebSocket-Key`çš„å€¼ï¼Œå¹¶å°†å…¶ä¸ GUID å€¼`258EDFA5-E914â€“47DA-95CA-C5AB0DC85B11`è¿æ¥èµ·æ¥(è¿™æ˜¯ä¸€ä¸ª[ç¥å¥‡å­—ç¬¦ä¸²](https://en.wikipedia.org/wiki/Magic_string))
*   é‚£ä¹ˆæ¥æ”¶åˆ°çš„å€¼å¿…é¡»è¢«`SHA-1`æ•£åˆ—
*   é‚£ä¹ˆæ¥æ”¶åˆ°çš„æ•£åˆ—å¿…é¡»åœ¨`base64`ä¸­ç¼–ç ã€‚

é€‰æ‹©ç¥å¥‡å­—ç¬¦ä¸²å€¼æ˜¯å› ä¸º:

> ä¸ç†è§£ WebSocket åè®®çš„ç½‘ç»œç«¯ç‚¹ä¸å¤ªå¯èƒ½ä½¿ç”¨å®ƒ([ç¬¬ 1.3 èŠ‚](https://www.rfc-editor.org/rfc/rfc6455#section-1.3))ã€‚

åŸºæœ¬ä¸Šï¼Œä¸ºäº†ç¡®ä¿å®¢æˆ·æœºå’ŒæœåŠ¡å™¨éƒ½æ”¯æŒ WebSocket åè®®ï¼Œè¿™æ˜¯å¿…éœ€çš„ã€‚è¿™ä¸€æ­¥å¾ˆé‡è¦ï¼Œå› ä¸ºå¦‚æœæœåŠ¡å™¨æ¥å— WebSocket è¿æ¥ï¼Œä½†å°†æ•°æ®è§£é‡Šä¸º HTTP è¯·æ±‚ï¼Œå¯èƒ½ä¼šå‡ºç°æ½œåœ¨çš„å®‰å…¨é—®é¢˜ã€‚

æ¡æ‰‹å“åº”è¿˜å¿…é¡»åŒ…å«æŠ¥å¤´`Connection: Upgrade`å’Œ`Upgrade: websocket`ã€‚

åœ¨å®¢æˆ·ç«¯æ¥æ”¶åˆ°å¸¦æœ‰æ‰€æè¿°çš„å¤´çš„æœåŠ¡å™¨å“åº”ä¹‹åï¼ŒWebSocket è¿æ¥è¢«å»ºç«‹å¹¶æ‰“å¼€ä»¥å¼€å§‹ä¼ è¾“æ•°æ®ã€‚

ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ç”¨ä»£ç å®ç°æ¡æ‰‹ã€‚

æˆ‘ä»¬å°†ç»§ç»­æ„å»ºæˆ‘ä»¬çš„`WebSocketServer`ç¤ºä¾‹ï¼Œå¹¶ä»¥å¦‚ä¸‹æ–¹å¼æ›´æ–°æˆ‘ä»¬çš„`_init`æ–¹æ³•:

å¦‚æœ`Upgrade`æŠ¥å¤´çš„å€¼ä¸ç­‰äº`websocket`ï¼Œæˆ‘ä»¬ç”¨ 400 å“åº”ï¼Œå¹¶ä¸­æ­¢æ¡æ‰‹ã€‚

ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬å‘å‡ºäº†`headers`äº‹ä»¶ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å¤Ÿè®¢é˜…è¿™ä¸ªäº‹ä»¶ï¼Œå¹¶æŸ¥çœ‹åœ¨è¿æ¥è¯·æ±‚æ—¶æ”¶åˆ°äº†ä»€ä¹ˆæ¶ˆæ¯å¤´ã€‚

è®©æˆ‘ä»¬ä¹Ÿå°†â€œç¥å¥‡å­—ç¬¦ä¸²â€å£°æ˜æ·»åŠ åˆ°æˆ‘ä»¬çš„ç±»çš„æ„é€ å‡½æ•°ä¸­:

```
this.GUID = '258EAFA5-E914-47DA-95CA-C5AB0DC85B11';
```

æ–¹æ³•`_generateAcceptValue`æ˜¯ä¸º`Sec-WebSocket-Accept`å¤´ç”Ÿæˆå€¼çš„æ–¹æ³•ï¼Œéå¸¸ç®€å•(æ³¨æ„ï¼Œæˆ‘ä»¬éœ€è¦æ¥è‡ªèŠ‚ç‚¹çš„`crypto`æ¨¡å—):

è¿™æ ·ï¼Œæˆ‘ä»¬çš„æœåŠ¡å™¨å°±å¯ä»¥å»ºç«‹âš¡ï¸çš„ WebSocket è¿æ¥äº†

æˆ‘ä»¬åªéœ€è¦åœ¨æˆ‘ä»¬çš„ç±»ä¸­æ·»åŠ ä¸€ä¸ª`listen`æ–¹æ³•ï¼Œå®ä¾‹åŒ–å®ƒï¼Œç„¶åæ£€æŸ¥æ˜¯å¦ä¸€åˆ‡éƒ½åƒæˆ‘ä»¬é¢„æœŸçš„é‚£æ ·å·¥ä½œã€‚

ç°åœ¨ï¼Œè¦å¯åŠ¨æˆ‘ä»¬çš„æœåŠ¡å™¨ï¼Œæˆ‘ä»¬å¿…é¡»æ‰§è¡Œä»¥ä¸‹æ“ä½œ:

ä¸ºäº†æ£€æŸ¥ä¸€åˆ‡æ˜¯å¦æ­£å¸¸ï¼Œä½¿ç”¨`node ws.js`å‘½ä»¤è¿è¡Œ`ws.js`æ–‡ä»¶ï¼Œæ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„ WebSocket:

```
const ws = new WebSocket('ws://localhost:4000');
```

å›åˆ°æ‚¨çš„ç»ˆç«¯ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„å†…å®¹:

![](img/a2d91bf2dfd632c066cce8286054db8c.png)

ç§ï¼Œæˆ‘ä»¬æ¡æ‰‹äº†ï¼

å°¼æ–¯ï¼ˆæ³•å›½åŸå¸‚åï¼‰ğŸ’¥

åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿æˆ‘ä»¬çš„æœåŠ¡å™¨èƒ½å¤Ÿæ¥æ”¶å’Œè§£ææ¥è‡ªå®¢æˆ·ç«¯çš„æ•°æ®ã€‚

# 4.æ¥æ”¶æ•°æ®

> åœ¨ WebSocket åè®®ä¸­ï¼Œä½¿ç”¨ä¸€ç³»åˆ—å¸§æ¥ä¼ è¾“æ•°æ®ã€‚([ç¬¬ 5.1 èŠ‚](https://www.rfc-editor.org/rfc/rfc6455#section-5.1))

åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ç€é‡äºå®ç°ä¸€ä¸ªè§£æ WebSocket å¸§çš„æ–¹æ³•ã€‚ä½†é¦–å…ˆï¼Œè®©æˆ‘ä»¬è®¨è®ºä¸€ä¸‹æ¡†æ¶å®é™…ä¸Šæ˜¯å¦‚ä½•æ„é€ çš„ã€‚

ä¸‹å›¾æ˜¾ç¤ºäº† WebSocket å¸§çš„æ„å»ºå—åŠå…¶å¤§å°(ä»¥ä½ä¸ºå•ä½)ã€‚

![](img/19d8af15e93e0e93d974cb4a65095b90.png)

æ¥æº:[https://rafalgolarz . com/blog/2016/12/07/web socket _ servers _ 101/](https://rafalgolarz.com/blog/2016/12/07/websocket_servers_101/)

è§„èŒƒçš„ç¬¬ 5.2 èŠ‚ä¸­æè¿°äº†æ¯ä¸ªå—çš„å«ä¹‰ã€‚

*   `FIN` â€” 1 ä½ã€‚è¿™æ˜¯ WebSocket å¸§çš„ç¬¬ä¸€ä½ã€‚å¦‚æœè¯¥ä½è¢«ç½®ä½ï¼Œåˆ™è¡¨æ˜è¿™æ˜¯æŠ¥æ–‡çš„æœ€åä¸€æ®µã€‚
*   `RSV1`ã€`RSV2`ã€`RSV3` â€”å„ 1 ä½ã€‚è¿™äº›æ˜¯ä¿ç•™ç»™ WebSocket æ‰©å±•ä½¿ç”¨çš„ã€‚åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œåªæœ‰ä¸¤ä¸ª[æ³¨å†Œæ‰©å±•](https://www.iana.org/assignments/websocket/websocket.xhtml#extension-name):[web socket Per-Message Deflate](https://www.rfc-editor.org/rfc/rfc7692)å’Œ [BBF USP åè®®](https://usp.technology/)ã€‚è¿™äº›è¶…å‡ºäº†æœ¬æ–‡çš„èŒƒå›´ã€‚
*   `Opcode` â€” 4 ä½ã€‚è¯¥å—ç”¨äºè§£é‡Š`Payload Data`å—ã€‚æœ‰ä»£ç è¡¨ç¤ºæ–‡æœ¬æˆ–äºŒè¿›åˆ¶å¸§ï¼Œè¿æ¥å…³é—­äº‹ä»¶ï¼Œç»§ç»­å¸§ç­‰ã€‚ä»¥ä¸‹æ˜¯`opcode`çš„å¯èƒ½å€¼åŠå…¶å«ä¹‰:

åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†åªä½¿ç”¨`0x01`å’Œ`0x08`æ“ä½œç ã€‚

*   `mask` â€”å®šä¹‰`Payload Data`å—æ˜¯å¦è¢«å±è”½ã€‚å¦‚æœè®¾ç½®ä¸º 1ï¼Œåˆ™å¿…é¡»å­˜åœ¨ä¸€ä¸ª 4 å­—èŠ‚çš„`masking-key`å—ï¼Œå¹¶ç”¨äºè§£é™¤`Payload Data`å—çš„å±è”½ã€‚æ ¹æ®[è§„æ ¼](https://www.rfc-editor.org/rfc/rfc6455#section-5.1):

> å®¢æˆ·ç«¯å¿…é¡»å±è”½å®ƒå‘é€ç»™æœåŠ¡å™¨çš„æ‰€æœ‰å¸§ã€‚æœåŠ¡å™¨ä¸å¾—å±è”½å®ƒå‘é€ç»™å®¢æˆ·ç«¯çš„ä»»ä½•å¸§ã€‚

åŸºæœ¬ä¸Šï¼Œè¿™æ„å‘³ç€å½“ä»æµè§ˆå™¨æµ‹è¯•æˆ‘ä»¬çš„æœåŠ¡å™¨æ—¶ï¼Œæˆ‘ä»¬æ€»æ˜¯ä¼šæ”¶åˆ°å±è”½å¸§ã€‚åŒæ—¶ï¼Œåœ¨å‘é€å“åº”æ—¶ï¼Œæˆ‘ä»¬ä¸èƒ½å±è”½æˆ‘ä»¬çš„æœ‰æ•ˆè½½è·ï¼Œå¦åˆ™æµè§ˆå™¨å°†æ‹’ç»å¤„ç†æˆ‘ä»¬çš„å¸§å¹¶æŠ›å‡ºé”™è¯¯ã€‚

*   `Payload Len` + `Extended payload length` â€” 7 ä½ã€7+16 ä½æˆ– 7+64 ä½ã€‚

å¦‚æœ`Payload Data`å—çš„é•¿åº¦å°äºç­‰äº 125 å­—èŠ‚ï¼Œåˆ™`payload len`å€¼å°±æ˜¯`Payload Data`çš„é•¿åº¦ã€‚å¦‚æœæœ‰æ•ˆè½½è·çš„é•¿åº¦å¤§äº 125 å­—èŠ‚ï¼Œ`Payload len`å—çš„å€¼å¯ä»¥æ˜¯ 126 æˆ– 127:

*   å¦‚æœå®é™…æœ‰æ•ˆè½½è·é•¿åº¦åœ¨ 126 åˆ° 65ï¼Œ535 å­—èŠ‚ä¹‹é—´ï¼Œé‚£ä¹ˆ`Payload len`å°±æ˜¯`126`ï¼Œåé¢çš„ 16 ä½å°†è¢«è§†ä¸ºå®é™…æœ‰æ•ˆè½½è·é•¿åº¦å€¼ã€‚
*   å¦‚æœå®é™…æœ‰æ•ˆè½½è·é•¿åº¦åœ¨ 65ï¼Œ536 å­—èŠ‚å’Œ~9223372036.85 åƒå…†å­—èŠ‚ä¹‹é—´ï¼Œé‚£ä¹ˆ`Payload len`å°±æ˜¯`127`ï¼Œåé¢çš„ 64 ä½å°†è¢«è§†ä¸ºå®é™…æœ‰æ•ˆè½½è·é•¿åº¦å€¼ã€‚

ç„¶è€Œï¼Œå¦‚æœä½ å¿…é¡»å°†`Payload len`è®¾ç½®ä¸º 127ï¼Œä½ çš„å¸§å¤ªå¤§äº†ï¼Œä½ è‚¯å®šåšé”™äº†ã€‚ä½ èƒ½æƒ³è±¡å•ä¸ªæ•°æ®å¸§ 9000 å—ï¼Œlolï¼Ÿ

*   `masking-key` â€” 0 æˆ– 4 ä¸ªå­—èŠ‚ã€‚å¦‚æœè®¾ç½®äº†`mask`ä½ï¼Œåˆ™å¿…é¡»æä¾› 32 ä½å±è”½å¯†é’¥ã€‚å±è”½å¯†é’¥ç”¨äºè§£é™¤ä»å®¢æˆ·ç«¯æ¥æ”¶çš„æœ‰æ•ˆè½½è·æ•°æ®çš„å±è”½ã€‚
*   `Payload Data` â€”å‘é€æˆ–æ¥æ”¶çš„å®é™…æœ‰æ•ˆè½½è·ã€‚å¤§å¤šæ•°æ—¶å€™ï¼Œå®ƒåŒ…å«åº”ç”¨ç¨‹åºæ•°æ®(æˆ‘ä»¬â€”â€”åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜â€”â€”å‘é€æˆ–æ¥æ”¶çš„ä»»æ„æ•°æ®)ã€‚ä½†æ˜¯ï¼Œå¦‚æœåœ¨å¼€å§‹æ¡æ‰‹æœŸé—´å·²ç»åå•†äº†æ‰©å±•ï¼Œå®ƒä¹Ÿå¯ä»¥åŒ…å«æ‰©å±•æ•°æ®ã€‚

ç°åœ¨è®©æˆ‘ä»¬è¯•ç€è‡ªå·±å®ç°ä¸€ä¸ªå¸§è§£æå‡½æ•°ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç”¨å°†è¦ä½¿ç”¨çš„ä»£ç åœ¨`WebSocketServer`æ„é€ å‡½æ•°ä¸­å®šä¹‰æ“ä½œç æ˜ å°„:

```
this.OPCODES = { text: 0x01, close: 0x08 };
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåä¸º`parseFrame`çš„æ–¹æ³•ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªç¼“å†²åŒºï¼Œä»ä¸­æå–æœ‰æ•ˆè½½è·å¹¶è¿”å›ä¸€ä¸ª`utf-8`å­—ç¬¦ä¸²ã€‚

ç”±äºæˆ‘ä»¬ä¸æ‰“ç®—ä½¿ç”¨`0x00`æ“ä½œç (å»¶ç»­å¸§)ï¼Œæˆ‘ä»¬å°†å‡è®¾`FIN`ä½æ€»æ˜¯è¢«ç½®ä½ã€‚

æˆ‘ä»¬è¯»å–ç¼“å†²åŒºçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œå¹¶æå–ç¬¬ä¸€ä¸ªå­—èŠ‚çš„æœ€å 4 ä½å€¼`opcode`ã€‚å¦‚æœ`opcode`æ˜¯`0x08`ï¼Œé‚£ä¹ˆæˆ‘ä»¬å‘å‡ºä¸€ä¸ª`close`äº‹ä»¶å¹¶è¿”å› nullã€‚æˆ‘ä»¬ä¹Ÿæ‹’ç»å¤„ç†é™¤çº¯æ–‡æœ¬(`opcode` 0x01)ä¹‹å¤–çš„ä»»ä½•å†…å®¹ã€‚

ä¸ºäº†å¤„ç†è¿æ¥å…³é—­äº‹ä»¶ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ª`close`äº‹ä»¶ç›‘å¬å™¨å¹¶é”€æ¯å…¶å›è°ƒâ˜ ï¸ä¸­çš„å¥—æ¥å­—

ç°åœ¨è®©æˆ‘ä»¬å°è¯•æå–æœ‰æ•ˆè½½è·é•¿åº¦ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†è¯»å–ç¼“å†²åŒºçš„ç¬¬äºŒä¸ªå­—èŠ‚ï¼Œå¹¶ä»ä¸­æå–æœ€å 7 ä½ã€‚è¿™å°†æ˜¯æ¡†æ¶çš„`payload len`æ¨¡å—ã€‚å¦‚æœè¯¥å€¼ç­‰äº 126 æˆ– 127ï¼Œåˆ™å®é™…æœ‰æ•ˆè½½è·é•¿åº¦å°†åˆ†åˆ«åœ¨ç¼“å†²åŒºçš„åç»­ 2 æˆ– 8 ä¸ªå­—èŠ‚ä¸­å®šä¹‰ã€‚

æˆ‘ä»¬ä¸æ‰“ç®—ä½¿ç”¨æœ‰æ•ˆè½½è·é•¿åº¦å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†åªè®¾ç½®ä¸€ä¸ªåç§»è®¡æ•°å™¨æ¥çŸ¥é“å®é™…çš„æœ‰æ•ˆè½½è·æ•°æ®ä½•æ—¶åœ¨ç¼“å†²åŒºä¸­å¼€å§‹ã€‚

åˆå§‹çš„`offset`å€¼æ˜¯`2`ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»è¯»å–äº†ç¼“å†²åŒºçš„ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªå­—èŠ‚ã€‚å¦‚æœ`payload len`å—å€¼æ˜¯ 126 æˆ– 127ï¼Œæˆ‘ä»¬çŸ¥é“æ¥ä¸‹æ¥çš„ 2 æˆ– 8 ä¸ªå­—èŠ‚å°†è¢«å®é™…æœ‰æ•ˆè½½è·é•¿åº¦å ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å„è‡ªçš„å€¼åŠ åˆ°åç§»é‡ä¸Šã€‚

æˆ‘ä»¬è¿˜éœ€è¦æ³¨æ„çš„æ˜¯æ£€æŸ¥`mask`ä½(ç¬¬äºŒä¸ªå­—èŠ‚çš„ç¬¬ä¸€ä½)å¹¶æå–`masking-key`:

å¦‚æœ`mask`ä½è¢«ç½®ä½ï¼Œé‚£ä¹ˆæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬çš„å®é™…æœ‰æ•ˆè½½è·ä» 4 ä¸ªå­—èŠ‚å¼€å§‹(åœ¨å±è”½é”®ä¹‹åå†™å…¥)ï¼Œæ‰€ä»¥æˆ‘ä»¬å°† 4 åŠ åˆ°æˆ‘ä»¬çš„`offset`ä¸­ã€‚å¦‚æœ`mask`ä½æœªç½®ä½ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„`offset`å€¼å·²ç»æŒ‡ç¤ºäº†ç¼“å­˜ä¸­`payload data`çš„å¼€å§‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¯»å–å®ƒç›´åˆ°ç»“æŸå¹¶è¿”å›ã€‚

ä¸ºäº†å¾—åˆ°ä¸€ä¸ªå±è”½é”®ï¼Œæˆ‘ä»¬ä½¿ç”¨`readUInt32BE`å‡½æ•°ï¼Œä»`offset`å­—èŠ‚å¼€å§‹ä»æˆ‘ä»¬çš„ç¼“å†²åŒºæå– 32 ä½æ•°æ®ã€‚

ç°åœ¨ï¼Œæœ‰äº†å±è”½é”®ï¼Œæˆ‘ä»¬éœ€è¦è§£é™¤æœ‰æ•ˆè½½è·çš„å±è”½ã€‚

å±è”½å’Œå–æ¶ˆå±è”½çš„ç®—æ³•æ˜¯ç›¸åŒçš„ï¼Œå¹¶åœ¨è§„èŒƒçš„ç¬¬ 5.3 èŠ‚ä¸­å®šä¹‰ã€‚æœ¬è´¨ä¸Šå¯ä»¥å½’ç»“ä¸º:

> è½¬æ¢æ•°æ®çš„å…«ä½å­—èŠ‚ I æ˜¯åŸå§‹æ•°æ®çš„å…«ä½å­—èŠ‚ I ä¸å±è”½å¯†é’¥çš„ç´¢å¼• I å¤„çš„å…«ä½å­—èŠ‚æ¨¡ 4 çš„å¼‚æˆ–

æˆ‘ä»¬åœ¨å­—èŠ‚çº§åˆ«ä¸Šæ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€äº›äºŒè¿›åˆ¶ç®—æ³•æ¥è½¬æ¢æœ‰æ•ˆè½½è·çš„æ¯ä¸€ä½ã€‚æˆ‘ä»¬å°†éå†æœ‰æ•ˆè½½è·çš„æ¯ä¸ªå­—èŠ‚ï¼Œå¹¶å°†å…¶ä¸å±è”½å¯†é’¥çš„é€‚å½“å­—èŠ‚è¿›è¡Œå¼‚æˆ–è¿ç®—:

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ›´æ–°`_init`æ–¹æ³•ä¸­çš„è¯·æ±‚å‡çº§å›è°ƒï¼Œä»¥æ·»åŠ `data`äº‹ä»¶ç›‘å¬å™¨ã€‚

å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬åªæ˜¯é‡æ–°å‘å‡ºäº†`data`äº‹ä»¶ï¼Œä½†æ˜¯ä¹Ÿå‘å¤–ä¼ é€’äº†è§£æåçš„æ•°æ®(ä½¿ç”¨`parseFrame(buffer)`)ã€‚

ä½ å¯ä»¥è¿™æ ·ä½¿ç”¨å®ƒ:

è¦æµ‹è¯•å®ƒæ˜¯å¦å·¥ä½œï¼Œæ‚¨å¯ä»¥è½¬åˆ°æµè§ˆå™¨æ§åˆ¶å°ï¼Œè¿è¡Œå¦‚ä¸‹å†…å®¹:

```
const ws = new WebSocket('ws://localhost:4000');

ws.send(JSON.stringify({ message: 'Hello World' }));
```

åœ¨æ‚¨çš„ç»ˆç«¯ä¸­ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°æ¥è‡ªæµè§ˆå™¨çš„æ¶ˆæ¯:

![](img/6f422a38e43c200cc504c0d1bded4d29.png)

ä¸‡å²ï¼ğŸ¤˜

ä½†æ˜¯å¦‚æœæˆ‘ä»¬åªèƒ½æ¥æ”¶æ•°æ®è€Œä¸èƒ½å‘å›æ•°æ®ï¼Œæˆ‘ä»¬çš„æœåŠ¡å™¨å°±æ²¡æœ‰å¤šå¤§ç”¨å¤„äº†ã€‚åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚

# 5.å‘é€æ•°æ®

æˆ‘ä»¬å·²ç»çŸ¥é“äº† WebSocket æ¡†æ¶çš„ç»“æ„ï¼Œæ‰€ä»¥ç°åœ¨åˆ›å»ºä¸€ä¸ªæ¡†æ¶ä¼šå®¹æ˜“å¾—å¤šã€‚å¦å¤–ï¼Œæˆ‘ä»¬ä¸éœ€è¦åšæ©è”½ï¼

è¦åˆ›å»ºä¸€ä¸ªå¸§ï¼Œæˆ‘ä»¬éœ€è¦å›ç­”è¿™ä¸ªé—®é¢˜:æˆ‘ä»¬åº”è¯¥ä¸ºä¸€ä¸ªå¸§åˆ†é…å¤šå¤§çš„ç¼“å†²åŒºï¼Ÿ

ä»¥ä¸‹æ˜¯æˆ‘ä»¬å·²ç»çŸ¥é“çš„:

*   æˆ‘ä»¬éœ€è¦ç¬¬ä¸€ä¸ªå­—èŠ‚ç”¨äº`FIN`ã€`RSV`ä½å’Œ`opcode`ï¼›
*   æˆ‘ä»¬éœ€è¦ç¬¬äºŒä¸ªå­—èŠ‚æ¥å­˜å‚¨`mask`ä½å’Œ`payload len`ï¼›
*   æˆ‘ä»¬éœ€è¦å†³å®šæˆ‘ä»¬æ˜¯å¦éœ€è¦é¢å¤–çš„ 2 æˆ– 8 å­—èŠ‚ç”¨äºå¤§çš„æœ‰æ•ˆè½½è·ï¼›
*   è¿˜æœ‰æˆ‘ä»¬å®é™…æœ‰æ•ˆè½½è·çš„å­—èŠ‚é•¿åº¦ã€‚

æ³¨æ„ï¼Œæˆ‘ä»¬ç¨å¾®ç®€åŒ–äº†ä¸€ä¸‹ï¼Œæ²¡æœ‰ä¸ºå±è”½é”®åˆ†é… 4 ä¸ªå­—èŠ‚ã€‚

ä¸ºäº†è¿›ä¸€æ­¥ç®€åŒ–ï¼Œè®©æˆ‘ä»¬å‡è®¾`FIN`ä½æ€»æ˜¯è¢«è®¾ç½®ï¼Œå¹¶ä¸”`opcode`å€¼æ€»æ˜¯`0x01`(æ–‡æœ¬æ¡†)ã€‚

ç„¶åæˆ‘ä»¬å¯ä»¥ç¡¬ç¼–ç ç¬¬ä¸€ä¸ªå¸§å­—èŠ‚â€” `0b10000001`:

> é³(1)ï¼ŒRSV1 (0)ï¼ŒRSV2 (0)ï¼ŒRSV3 (0)ï¼ŒOpÑode (0001)

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–¹æ³•`createFrame(data)`å¹¶å¡«å……å‰ 2 ä¸ªå­—èŠ‚å’Œå¯é€‰çš„éšåçš„ 2 æˆ– 8 ä¸ªå­—èŠ‚ä½œä¸ºä¸€ä¸ª`extra payload length`å€¼ã€‚ä¹‹åï¼Œæˆ‘ä»¬åªéœ€å°†æœ‰æ•ˆè½½è·æ•°æ®æ·»åŠ åˆ°ç»“æœç¼“å†²åŒºçš„æœ«å°¾:

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€æ¸å¢åŠ `payloadBytesOffset`å˜é‡ï¼Œä½¿å…¶ä¸ç¼“å†²åŒºä¸­å®é™…æœ‰æ•ˆè½½è·çš„èµ·å§‹åç§»é‡ç›¸åŒ¹é…ã€‚

ä¸€æ—¦æˆ‘ä»¬çŸ¥é“äº†`payloadBytesOffset`ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°é€šè¿‡å°†æœ‰æ•ˆè½½è·çš„å­—èŠ‚é•¿åº¦å’Œåç§»é‡ç›¸åŠ æ¥è®¡ç®—å¾—åˆ°çš„ç¼“å†²åŒºçš„æ€»é•¿åº¦ã€‚

ç„¶åï¼Œæˆ‘ä»¬å°†`payload len`å’Œå¯é€‰çš„`extra payload length`å†™å…¥ç»“æœç¼“å†²åŒºã€‚æ„Ÿè°¢ [Buffer](https://nodejs.org/api/buffer.html) çš„åŠ©æ‰‹å‡½æ•°â€”â€”`writeUInt16BE`å’Œ`writeBigUInt64BE`â€”â€”è¿™åªæ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨çš„é—®é¢˜ã€‚

æœ€åï¼Œæˆ‘ä»¬çš„æœ‰æ•ˆè½½è·ã€‚

å°±è¿™æ ·ï¼Œå¾ˆç®€å•ã€‚ğŸ˜

ç°åœ¨è®©æˆ‘ä»¬åœ¨ä¸‹ä¸€èŠ‚æŠŠæ‰€æœ‰çš„ä¸œè¥¿æ”¾åœ¨ä¸€èµ·ï¼Œçœ‹çœ‹æˆ‘ä»¬çš„æœåŠ¡å™¨æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚

# 6.æŠŠæ‰€æœ‰çš„æ”¾åœ¨ä¸€èµ·

æˆ‘ä»¬æœ‰è§£æå’Œåˆ›å»º WebSocket å¸§çš„æ–¹æ³•ï¼Œæˆ‘ä»¬è¿˜å®ç°äº†å¼€å§‹æ¡æ‰‹è¿‡ç¨‹ğŸ’ª

ä¸ºäº†å°†æ‰€æœ‰è¿™äº›æŠ•å…¥ä½¿ç”¨ï¼Œè®©æˆ‘ä»¬é¦–å…ˆä¿®æ”¹æˆ‘ä»¬çš„`data`å›è°ƒï¼Œå°†ä¸€ä¸ª`reply`å‡½æ•°ä¼ é€’ç»™æœ€ç»ˆç”¨æˆ·:

è¿™æ ·ï¼Œæˆ‘ä»¬ä¸ä»…èƒ½å¤Ÿæ¥æ”¶æ•°æ®ï¼Œè¿˜èƒ½å¤Ÿå°†æ•°æ®å‘é€å›å®¢æˆ·ç«¯:

ç»§ç»­å¹¶åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­é”®å…¥

```
const ws = new WebSocket('ws://localhost:4000');

ws.addEventListener('message', ({ data }) => { console.log(JSON.parse(data)) });
ws.send(JSON.stringify({ ping: 'Hello World' }));
```

æ‚¨å°†çœ‹åˆ°æˆ‘ä»¬çš„æœåŠ¡å™¨ç”¨ä¸€ä¸ª`pong`å“åº”:

![](img/22fdbf12a31e2f9bca1cd05ef0785459.png)

å¥½å§ã€‚ç°åœ¨è®©æˆ‘ä»¬å»ºç«‹ä¸€äº›æ›´å®é™…çš„ä¸œè¥¿ã€‚

è®©æˆ‘ä»¬å®šä¹‰ä¸€äº›æˆ‘ä»¬çš„æœåŠ¡å™¨å°†ä¸ºå®¢æˆ·æœºæä¾›çš„ API æ–¹æ³•:

`sleep`å‡½æ•°åªæ˜¯`setTimeout`å‡½æ•°çš„é‡å‘½åå¯¼å…¥:

```
const { setTimeout: sleep } = require('node:timers/promises');
```

ç°åœ¨è®©æˆ‘ä»¬çš„æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æä¾›è¿™ä¸ª API:

ç°åœ¨å°±ç”¨å§ï¼

åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿æ¥åˆ°æˆ‘ä»¬çš„æœåŠ¡å™¨å¹¶å‘é€ä¸€äº›è¯·æ±‚:

```
const ws = new WebSocket('ws://localhost:4000');

ws.addEventListener('message', ({ data }) => { console.log(JSON.parse(data)) });

ws.send(JSON.stringify({ method: 'auth', args: ['admin', 'wrong'] }));
ws.send(JSON.stringify({ method: 'auth', args: ['admin', 'secret'] }));
ws.send(JSON.stringify({ method: 'getUsers' }));
```

åœ¨æ‚¨çš„æµè§ˆå™¨æ§åˆ¶å°ä¸­ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„å†…å®¹:

![](img/46b57a77a79a40c0acea089a11760d6b.png)

å“‡ï¼Œé‚£ä¸ª RPC ç”¨çš„æ˜¯ WebSockets å—ï¼Ÿ

æ˜¯çš„ï¼Œçœ‹èµ·æ¥æ˜¯è¿™æ ·ğŸ˜

æ­å–œä½ ã€‚æ‚¨å·²åˆ°è¾¾è¿™ç¯‡æ–‡ç« çš„ç»“å°¾ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‚¨åº”è¯¥çŸ¥é“ WebSocket åè®®åœ¨å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼ŒåŒ…æ‹¬å®¢æˆ·æœº-æœåŠ¡å™¨æ¡æ‰‹å’Œæ•°æ®ç»„å¸§ã€‚æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼ŒWebSockets ä¸æ˜¯ä¸€ä¸ªå¤ªå¤æ‚çš„åè®®ï¼Œç”šè‡³æ˜¯ RFC ä¹Ÿå¾ˆå®¹æ˜“ç†è§£ã€‚

å‡ºäºå­¦ä¹ çš„ç›®çš„ï¼Œä½ å¯ä»¥è¯•ç€ç”¨æˆ‘ä»¬çš„`WebSocketServer`(åˆ©ç”¨è¿ç»­å¸§)å®ç°æµå¼ä¼ è¾“ï¼Œè¿™åº”è¯¥ä¸ä¼šå¤ªéš¾ï¼Œæˆ–è€…ç»™æˆ‘ä»¬çš„æœåŠ¡å™¨æ·»åŠ çœŸæ­£çš„ JWT è®¤è¯ğŸ¤–

ä¸‹é¢æ˜¯æœ¬æ–‡çš„å®Œæ•´ä»£ç (æˆ‘è¿˜åœ¨è¯¥ç±»çš„ä¸€ä¸ª`clients`å±æ€§ä¸­æ·»åŠ äº†è¿æ¥è·Ÿè¸ª):

# 7.è¦é˜…è¯»çš„å…¶ä»–èµ„æº

1.  [RFC 6455â€”web socket åè®®](https://www.rfc-editor.org/rfc/rfc6455)
2.  [web socketsâ€”â€”æ¦‚å¿µæ€§çš„æ·±åº¦ç ”ç©¶(Ably)](https://ably.com/topic/websockets)
3.  [ç¼–å†™ WebSocket æœåŠ¡å™¨(MDN)](https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_servers)

æ„Ÿè°¢é˜…è¯»ã€‚