<html>
<head>
<title>Two Tips to Better Handle Go Concurrency</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">æ›´å¥½åœ°å¤„ç†Goå¹¶å‘çš„ä¸¤ä¸ªæŠ€å·§</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://betterprogramming.pub/two-tips-to-better-handle-go-concurrency-d369b86a32f4?source=collection_archive---------7-----------------------#2022-02-28">https://betterprogramming.pub/two-tips-to-better-handle-go-concurrency-d369b86a32f4?source=collection_archive---------7-----------------------#2022-02-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="982e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">ä»¥ä¸‹æ˜¯æˆ‘åœ¨goroutinesä¸ŠçŠ¯çš„ä¸¤ä¸ªé”™è¯¯ï¼Œä»¥åŠå¦‚ä½•é¿å…å®ƒä»¬ã€‚</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4d264aac66dee08674c90631a199415a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qdT44yZ1dGFJ13ocV4AqqQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@steve_j?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">æ–¯è’‚å¤«Â·çº¦ç¿°æ£®</a>åœ¨<a class="ae ky" href="https://unsplash.com/s/photos/parallel?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>ä¸Šæ‹ç…§</p></figure><p id="38ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">å¤§å¤šæ•°Goå¼€å‘è€…å¯èƒ½ä¼šåŒæ„ï¼ŒGoä½¿å¾—å®ç°å¹¶å‘å˜å¾—<strong class="lb iu">æ¯«ä¸è´¹åŠ›</strong>ã€‚é€šè¿‡goroutineså’Œchannelsï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°ä¸€èµ·è¿è¡Œç‹¬ç«‹çš„åŠŸèƒ½ï¼Œå®‰æ’åå°ä»»åŠ¡ï¼Œç­‰ç­‰ã€‚</p><p id="3cf4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">å½“æˆ‘åœ¨Goä¸­å¤„ç†å¤§å‹ç³»ç»Ÿæ—¶ï¼Œæ‹¥æœ‰Goä¼˜é›…è€Œä¸°å¯Œçš„å¹¶å‘æ”¯æŒæ˜¯ä¸€ä»¶å¹¸äº‹ã€‚å®ƒå¸®åŠ©æˆ‘åŠ å¿«äº†æ•°æ®å¤„ç†é€Ÿåº¦ï¼Œæœ€å¤§é™åº¦åœ°åˆ©ç”¨äº†ç¡¬ä»¶èµ„æºã€‚</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/954a4a1cd075b465c4993ed9f7832323.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3q92-XNCHoIH7LFfI_njkg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">æ¥æº:<a class="ae ky" href="https://talks.golang.org/2012/waza.slide#1" rel="noopener ugc nofollow" target="_blank"> Go Talks </a></p></figure><p id="9e32" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">ä½†æ˜¯ï¼Œæ­£å¦‚æœ¬Â·å¸•å…‹æ›¾ç»è¯´è¿‡çš„ï¼Œ</p><blockquote class="lw lx ly"><p id="5ae7" class="kz la lz lb b lc ld ju le lf lg jx lh ma lj lk ll mb ln lo lp mc lr ls lt lu im bi translated">å¼ºå¤§çš„ğŸ•¸ ï¸ä¼´éšç€å·¨å¤§çš„è´£ä»»â€¦</p></blockquote><p id="8ea3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">æ²¡æœ‰æ¯”è¿™æ›´çœŸå®çš„è¯äº†ã€‚å°½ç®¡å®ƒä»¬åŠŸèƒ½å¼ºå¤§ï¼Œä½†å¾ˆå®¹æ˜“è¢«æ»¥ç”¨ã€‚æˆ‘ç›®ç¹å¹¶çŠ¯äº†å‡ ä¸ªé”™è¯¯ã€‚ä»–ä»¬ä¸­çš„ä¸€äº›äººå·²ç»é€ æˆäº†ç”Ÿæ´»ï¼Œç”Ÿäº§é—®é¢˜ï¼</p><p id="e73a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†ä¸æ‚¨åˆ†äº«ä¸¤ä¸ªæœ‰ç”¨çš„æŠ€å·§ï¼Œå®ƒä»¬å¯ä»¥å¸®åŠ©æ‚¨æ›´æ™ºèƒ½åœ°ä½¿ç”¨goroutinesã€‚è¿™äº›å»ºè®®æ¥è‡ªå®é™…äº‹ä»¶ï¼Œæ‰€ä»¥ç³»å¥½å®‰å…¨å¸¦ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ï¼ğŸƒ</p></div><div class="ab cl md me hx mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="im in io ip iq"><h1 id="0c1e" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">ä½¿ç”¨å¹¶å‘é™åˆ¶</h1><p id="6239" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">å¹¶å‘çš„ä¸€ä¸ªç”¨ä¾‹æ˜¯åœ¨åå°æ‰§è¡Œæ˜‚è´µçš„ä»»åŠ¡ï¼Œè€Œä¸é˜»å¡ä¸»é€»è¾‘æµã€‚è¿™æ ·ï¼Œæˆ‘ä»¬çš„ä»£ç å¯ä»¥(å‡ ä¹)ä¸€èµ·å¤„ç†è®¸å¤šè¿™æ ·çš„ä»»åŠ¡ï¼Œè€Œä¸æ˜¯è®©å®ƒä»¬ç­‰å¾…è½®åˆ°è‡ªå·±ã€‚</p><p id="577b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">é«˜å¼€é”€ä»»åŠ¡çš„ä¸€ä¸ªä¾‹å­æ˜¯åœ¨æ•°æ®å­˜å‚¨ä¸­æ‰¹é‡æ’å…¥æˆ–æ›´æ–°æ•°æ®ã€‚</p><p id="0f9b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªç®€å•çš„ç³»ç»Ÿã€‚æ¯å½“æœ‰æ•°æ®æ›´æ”¹æ—¶ï¼ŒæœåŠ¡å™¨éƒ½ä¼šå‘é˜Ÿåˆ—å‘é€æ¶ˆæ¯ã€‚ç„¶åï¼Œå·¥ä½œäººå‘˜å°†ä½¿ç”¨è¿™äº›æ¶ˆæ¯ï¼Œå°†å®ƒä»¬åˆ†ç»„ï¼Œå¹¶å°†å…¶å‘é€åˆ°å­˜å‚¨å™¨è¿›è¡Œæ›´æ–°ã€‚</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/e6c3ba1231391f4655788a3e39142f98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E1finbiBIb5DV-44bj6FSw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">å¼‚æ­¥æ›´æ–°çš„ç»å…¸ä¾‹å­</p></figure><p id="46ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">å·¥äººçš„ä»£ç å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºã€‚è¿™æ˜¯éå¸¸ç®€å•çš„ï¼Œä½†å®ƒçš„è¦ç‚¹æ˜¯å­˜åœ¨çš„ã€‚</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="587d" class="nn ml it nj b be no np l nq nr">type Message struct {<br/>  // Contain data updates<br/>}<br/><br/>type Worker struct {<br/>  msgChan          chan *Message // channel to receive messages from queue<br/>  batch            []*Message    // a batch of messages<br/>  maxBatchSize     uint32        // the maximum size of the batch<br/>}<br/><br/>func newWorker() *Worker {<br/>  return &amp;Worker {<br/>    msgChan:      make(chan *Message, 10000), // an internal queue size of 10000<br/>    maxBatchSize: 5000,<br/>  }<br/>}<br/><br/>// Start the worker<br/>func (w *Worker) start() {<br/>  go w.consume()   // a goroutine to consume<br/>  go w.process()   // a goroutine to process<br/>  <br/>  // Do something else...<br/>}<br/><br/>// Runs in a loop to consume from queue<br/>func (w *Worker) consume() {<br/>  for {<br/>    // blocks until there is a message<br/>    msg := consumeFromQueue()<br/>    w.msgChan &lt;- msg <br/>  }<br/>}<br/><br/>// Runs in a loop to process messages<br/>func (w *Worker) process() {<br/>  var batch []*Message<br/>  <br/>  for {<br/>    // blocks until there is a message<br/>    msg := &lt;- w.msgChan<br/>    <br/>    batch = w.batch<br/>    if batch == nil {<br/>      batch = make([]*Message, 0, w.maxBatchSize)<br/>    }<br/>    batch = append(batch, msg)<br/>    <br/>    // only commit when batch is full<br/>    if len(batch) &lt; w.maxBatchSize {<br/>      continue<br/>    }<br/>    <br/>    // batch update<br/>    go func(batch *[]Message) {<br/>      updateDataByBatch(batch)<br/>    }(batch)<br/>    <br/>    w.batch = nil // start new batch<br/>  }<br/>}</span></pre><p id="38fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">æ³¨æ„æ¯æ‰¹æ•°æ®æ˜¯å¦‚ä½•åœ¨å…¶goroutineä¸­å¤„ç†çš„ã€‚é€šè¿‡è¿™ç§è®¾è®¡ï¼Œå¤§é‡æ¶Œå…¥çš„æ¶ˆæ¯å°†ä¸ä¼šè¢«é˜»å¡ï¼Œå·¥ä½œäººå‘˜å¯ä»¥ä»¥éå¸¸å¿«çš„é€Ÿåº¦å¤„ç†å®ƒä»¬ã€‚</p><p id="ac92" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">ä½ èƒ½çœ‹å‡ºè¿™ä¸ªè®¾è®¡ä¸­çš„ç¼ºé™·å—ï¼Ÿ</p><p id="a406" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">æ¯æ‰¹æ¶ˆæ¯éƒ½ä¼šå ç”¨workerä¸­çš„å†…å­˜ã€‚åªæœ‰åœ¨goroutineå®Œæˆå…¶æ‰¹æ¬¡åï¼Œå³<code class="fe ns nt nu nj b">updateDataByBatch</code>è¿”å›åï¼Œå†…å­˜æ‰ä¼šè¢«é‡Šæ”¾ã€‚</p><p id="e855" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">å¦‚æœåœ¨å¤§é‡æ¶ˆæ¯æ¶Œå…¥æœŸé—´<code class="fe ns nt nu nj b">updateDataByBatch</code>æœ‰å»¶è¿Ÿï¼Œé‚£ä¹ˆgoroutineså°†å¼€å§‹å †ç§¯ã€‚ç”±äºå®ƒä»¬æ¯ä¸ªéƒ½ä¿å­˜ä¸€æ‰¹æ•°æ®ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ¶ˆè€—æº¢å‡ºã€‚</p><p id="c5d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">ä¸‹é¢æ˜¯æˆ‘ä¸ºæˆ‘çš„å‘˜å·¥è®¾ç½®çš„å†…å­˜ç›‘æ§ã€‚åœ¨é«˜å»¶è¿Ÿäº‹ä»¶ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°å†…å­˜ä½¿ç”¨çš„æŒç»­å³°å€¼ã€‚å®ƒç”šè‡³æ¥è¿‘100%çš„ä½¿ç”¨ç‡ï¼Œå¯¼è‡´å†…å­˜ä¸è¶³å’ŒæœåŠ¡å™¨å´©æºƒã€‚</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/d26df34642c1052614e2aff425d2b33a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hlXfJiZFzaX1W_3IrbgRdQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">ä¸‰ä¸ªå·¥ä½œå®ä¾‹å†…å­˜æº¢å‡º</p></figure><p id="1a63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">è¿™æ˜¯ä¸€ä¸ªç»å…¸çš„æ€§èƒ½bugï¼Œè§£å†³æ–¹æ³•éå¸¸ç®€å•ã€‚æˆ‘ä»¬åªéœ€è¦åº”ç”¨å¹¶å‘é™åˆ¶ã€‚</p><p id="a2e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">å¹¶å‘é™åˆ¶é™åˆ¶äº†ä¸€ä¸ªç¨‹åºåœ¨æ‰§è¡Œä»»åŠ¡æ—¶å¯ä»¥æ‹¥æœ‰çš„çº¿ç¨‹æ•°ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é™åˆ¶è°ƒç”¨<code class="fe ns nt nu nj b">updateDataByBatch</code>æ—¶å¯ä»¥å­˜åœ¨çš„goroutinesçš„æ•°é‡ã€‚</p><p id="503f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">è¿™ç§é™åˆ¶å¯ä»¥é€šè¿‡ä½¿ç”¨ç©ºç»“æ„<code class="fe ns nt nu nj b">struct{}</code>ç±»å‹çš„é€šé“æ¥å®ç°ã€‚</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="a0ad" class="nn ml it nj b be no np l nq nr">const concurrencyLimit = 300<br/><br/>type Worker struct {<br/>  // ...<br/>  wgChan chan struct{} // a channel to limit concurrency<br/>}<br/><br/>func newWorker() *Worker {<br/>  return &amp;Worker{<br/>    // ...<br/>    wgChan: make(chan struct{}, concurrencyLimit), // a max of 300 goroutines<br/>  }<br/>}<br/><br/>func (w *Worker) process() {<br/>  var batch []*Message<br/>  <br/>  for {<br/>    // ...<br/>    <br/>    // blocks unless there is space to start a new goroutine<br/>    w.wgChan &lt;- struct{}{}<br/>    <br/>    go func(batch *[]Message) {<br/>      defer func() {<br/>        &lt;- w.wgChan // goroutine is done!<br/>      }()<br/>      <br/>      updateDataByBatch(batch)<br/>    }(batch)<br/>    <br/>    // ...<br/>  }<br/>}</span></pre><p id="5472" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">åœ¨ä¸Šé¢çš„æ”¹è¿›ç‰ˆæœ¬ä¸­ï¼Œ<code class="fe ns nt nu nj b">wg</code>ä»£è¡¨<strong class="lb iu">ç­‰å¾…ç»„</strong>ã€‚<code class="fe ns nt nu nj b">w.wgChan &lt;- struct{}{}</code>è¦å¼€åˆ›ä¸€ä¸ªæ–°çš„è¾‰ç…Œï¼Œå°±å¿…é¡»æˆåŠŸã€‚å¦‚æœå®ƒé˜»å¡ï¼Œè¿™æ„å‘³ç€goroutinesçš„æ•°é‡å·²ç»è¾¾åˆ°æé™ã€‚</p><p id="f8cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">å½“ä¸€ä¸ªgoroutineå®Œæˆæ—¶ï¼Œå®ƒé€šè¿‡ä¸€ä¸ªå»¶è¿Ÿå‡½æ•°æ¸…ç©º<code class="fe ns nt nu nj b">wgChan</code>é€šé“ä¸­çš„ä¸€ä¸ªç©ºé—´ã€‚è¿™å…è®¸å…¶ä»–è¢«é˜»å¡çš„goroutinesç»§ç»­æ‰§è¡Œå®ƒä»¬çš„ä»»åŠ¡ã€‚</p><p id="6d19" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">é€šè¿‡é™åˆ¶goroutinesçš„æ•°é‡ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é™åˆ¶workerä¸­å¯ä»¥å­˜åœ¨çš„æŒ‚èµ·æ•°æ®æ‰¹çš„æ•°é‡ã€‚è¿™æ ·å°±ä¸å¤ªå¯èƒ½å‘ç”Ÿå†…å­˜æº¢å‡ºã€‚</p></div><div class="ab cl md me hx mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="im in io ip iq"><h1 id="adf0" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">ä¼˜é›…åœ°ç»ˆæ­¢Goroutines</h1><p id="8602" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">é™¤äº†æ‰¹é‡æ›´æ–°æ•°æ®ä¹‹å¤–ï¼Œè¿‡æ»¤å¤§é‡æ•°æ®ä¹Ÿæ˜¯ä¸€é¡¹æ˜‚è´µçš„ä»»åŠ¡ã€‚</p><p id="7b85" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">ç‰¹åˆ«æ˜¯ï¼Œç»™å®šä¸€éƒ¨åˆ†æƒŸä¸€çš„idï¼Œæˆ‘æƒ³æ£€æŸ¥å®ƒä»¬æ˜¯å¦éƒ½å­˜åœ¨äºæ•°æ®å­˜å‚¨ä¸­ã€‚å¦‚æœæ˜¯ï¼Œæˆ‘æƒ³æ£€ç´¢å®ƒä»¬å¯¹åº”çš„å€¼ï¼Œå¹¶å°†å®ƒä»¬æ”¾åœ¨ä¸€ä¸ªæ–°çš„ç‰‡ä¸Šï¼Œä¸å®ƒä»¬çš„idåœ¨åŒä¸€ç´¢å¼•å¤„ã€‚</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/b41b698cc60f771f91dc066c309e77df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_MNSyKjcHbP58VejqtSeaQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">å°†ç»“æœå­˜å‚¨åœ¨ä¸idç›¸åŒçš„ç´¢å¼•ä¸­</p></figure><p id="f736" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">æœ€ç®€å•çš„æ–¹æ³•æ˜¯éå†æ¯ä¸ªIDå¹¶åœ¨å­˜å‚¨ä¸­æœç´¢å®ƒä»¬ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬æ˜¯Goå¼€å‘è€…ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æ—‹è½¬å‡ ä¸ªgoroutineså¹¶åŒæ—¶æœç´¢æ¯ä¸ªIDï¼</p><pre class="kj kk kl km gt ni nj nk bn nl nm bi"><span id="9ea4" class="nn ml it nj b be no np l nq nr">type Item struct {<br/>  id    int<br/>  value string<br/>}<br/><br/>func getItems(itemIDs []int) ([]*Item, error) {<br/>  var (<br/>    concurencyLimit = 100 // set the limit!<br/>    wgChan          = make(chan struct{}, concurencyLimit)<br/>  )<br/>  <br/>  ctx := context.Background()<br/>  ctx, cancel := context.WithTimeout(ctx, 5*time.Second) // set timeout<br/>  defer cancel()<br/>  <br/>  items := make([]*Item, len(itemIDs))<br/>  <br/>  for i := range itemIDs {<br/>    select {<br/>      case &lt;- ctx.Done():<br/>        return nil, errors.New("timeout!") // return error if timeout<br/>      case wgChan &lt;- struct{}{}:<br/>    }<br/>    <br/>    go func(i int, itemID int) {<br/>      defer func() {<br/>        &lt;- wgChan // goroutine done!<br/>      }()<br/>      <br/>      //get item by ID, returns nil if not found<br/>      item := getItem(itemID)<br/>      <br/>      // place at the same index as itemID<br/>      items[i] = item<br/>    }(i, itemIDs[i])<br/>  }<br/>  <br/>  // wait for all goroutines to finish<br/>  for c := 0; c &lt; concurrencyLimit; c++ {<br/>    wgChan &lt;- struct{}{}<br/>  }<br/>  <br/>  return items, nil<br/>}</span></pre><p id="b79a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">å¯¹äºæ¯ä¸ª<code class="fe ns nt nu nj b">itemID</code>ï¼Œæˆ‘ä»¬å°†å¯åŠ¨ä¸€ä¸ªæ–°çš„goroutineï¼Œåœ¨æ•°æ®å­˜å‚¨ä¸­æœç´¢ç›¸åº”çš„é¡¹ç›®ã€‚åœ¨å‡½æ•°é€€å‡ºä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„goroutineséƒ½å·²é€€å‡ºã€‚</p><p id="732b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">è¿™å°±æ˜¯æ‰€è°“çš„ä¼˜é›…ç»ˆæ­¢ã€‚å¯ä»¥ç”¨ä¸‹é¢çš„å¾ªç¯æ¥å®ç°ã€‚</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/93d06d806fdc6481e7b1f463eed58187.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*bYEKz7jffiXPUXJmkAOu2g.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">ä¼˜é›…çš„ç»ˆç»“</p></figure><p id="6db7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">åœ¨ä»»ä½•æ—¶é—´ç‚¹ï¼Œæˆ‘ä»¬æœ€å¤šåªèƒ½æœ‰<code class="fe ns nt nu nj b">concurrencyLimit</code>ä¸ªgoroutinesã€‚å½“å¾ªç¯æ— é˜»å¡åœ°å®Œæˆæ—¶ï¼Œå®ƒä¿è¯æ‰€æœ‰goroutineséƒ½å·²é€€å‡ºã€‚ç„¶åï¼Œè¯¥å‡½æ•°å¯ä»¥å®‰å…¨é€€å‡ºã€‚</p><p id="d2c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">å¦‚æœæ²¡æœ‰ä¼˜é›…çš„ç»ˆæ­¢ä¼šæ€ä¹ˆæ ·ï¼Ÿé™¤äº†è¿”å›ä¸å®Œæ•´çš„ç»“æœä¹‹å¤–ï¼Œè¯¥å‡½æ•°å¾ˆå¯èƒ½ä¼šå› ç´¢å¼•è¶…å‡ºèŒƒå›´é”™è¯¯è€Œæ­»æœºã€‚</p><p id="2e44" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">è¿™æ˜¯å› ä¸ºä»»ä½•è¿è¡Œä¸­çš„goroutineå°†å°è¯•åœ¨ä½ç½®<code class="fe ns nt nu nj b">i</code>ç´¢å¼•<code class="fe ns nt nu nj b">items</code>åˆ‡ç‰‡ã€‚ä½†æ˜¯ï¼Œå› ä¸ºåŠŸèƒ½å·²ç»é€€å‡ºï¼Œ<code class="fe ns nt nu nj b">items</code>ç‰‡ä¸å†å­˜åœ¨ï¼</p><p id="d549" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">è¿™æ˜¯ç»™ä½ çš„ä¸€ä¸ªæµ‹è¯•ã€‚æˆ‘å·²ç»åˆ é™¤äº†ä¸€äº›ä»£ç ï¼Œä½¿åŠŸèƒ½å‡ºé”™ã€‚å¦‚æœä½ æƒ³æ‰¾å‡ºé—®é¢˜æ‰€åœ¨ï¼Œè¯·åœ¨æ­¤æš‚åœã€‚</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/a1350242a225f0007ca3dc9f7b973a6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mx90GdWLiWhJk1Pp-9COMQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">ç…§ç‰‡ç”±<a class="ae ky" href="https://unsplash.com/@arianassphotography?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">é˜¿ä¸½äºšå¨œÂ·è‹äºšé›·æ–¯</a>åœ¨<a class="ae ky" href="https://unsplash.com/s/photos/cookie?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>æ‹æ‘„</p></figure><p id="bc96" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">å½“<strong class="lb iu">ä¸Šä¸‹æ–‡åœ¨5ç§’é’Ÿå</strong>è¶…æ—¶æ—¶ï¼Œ<code class="fe ns nt nu nj b">getItems</code>åŠŸèƒ½æ²¡æœ‰æ­£å¸¸ç»ˆæ­¢ï¼å¦‚æœä»»ä½•goroutinesåœ¨ä»å­˜å‚¨ä¸­è·å–æ•°æ®æ—¶å‡ºç°å»¶è¿Ÿï¼Œå®ƒå°†ä¼šæ­»æœºã€‚</p><p id="edf5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">è¿™è¡¨æ˜ä»å¤´åˆ°å°¾å®Œå…¨ç†è§£æ¯ä¸ªgoroutineåœ¨ç¨‹åºä¸­çš„è¡Œä¸ºæ˜¯å¤šä¹ˆé‡è¦ã€‚</p></div><div class="ab cl md me hx mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="im in io ip iq"><h1 id="47a3" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">æœ€åçš„æƒ³æ³•</h1><p id="d33b" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">å¹¶å‘ç¼–ç¨‹ä¹‹æ‰€ä»¥å…·æœ‰æŒ‘æˆ˜æ€§ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬çš„å¤§è„‘æ›´å–„äºç†è§£é¡ºåºæµåŠ¨çš„äº‹ç‰©ã€‚å½“å°ç¨‹åºåœ¨ä¸€ä¸ªç¨‹åºä¸­è¿è¡Œæ—¶ï¼Œå¾ˆéš¾é¢„æ–™åˆ°æ„æƒ³ä¸åˆ°çš„äº‹æƒ…ï¼</p><p id="7d58" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">é€šè¿‡ä¸¥æ ¼éµå®ˆæˆ‘æä¾›çš„ä¸¤ä¸ªå»ºè®®ï¼Œä½ å°±å¯ä»¥é¿å…ä¸€äº›æ–°æ‰‹åœ¨ä½¿ç”¨goroutinesæ—¶å¯èƒ½çŠ¯çš„é”™è¯¯ã€‚æé«˜å¹¶å‘ç¼–ç¨‹çš„å”¯ä¸€æ–¹æ³•æ˜¯ç»ƒä¹ å’Œé˜…è¯»æ›´å¤æ‚çš„ä»£ç ã€‚</p><p id="3e0c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">ä½ å¯¹goroutinesçš„ä½“éªŒå¦‚ä½•ï¼Ÿä½ æœ‰ä»€ä¹ˆå»ºè®®æƒ³åˆ†äº«å—ï¼Ÿè®©æˆ‘çŸ¥é“ï¼</p></div></div>    
</body>
</html>