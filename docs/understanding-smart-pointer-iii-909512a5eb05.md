# é€šè¿‡ç›´è§‚çš„è§†è§‰æ•ˆæœè§£é‡Š C++æ™ºèƒ½æŒ‡é’ˆ

> åŸæ–‡ï¼š<https://betterprogramming.pub/understanding-smart-pointer-iii-909512a5eb05>

## æœ‰æ•ˆçš„ C++

## æˆ‘çš„ C++æŒ‡é’ˆç³»åˆ—çš„ç¬¬ 3 éƒ¨åˆ†

![](img/daf2b439dbc94efb749367a3b7173215.png)

ä¸€ä¸ªæŒ‡å‘ T çš„æŒ‡é’ˆï¼Œå¦ä¸€ä¸ªæŒ‡å‘æ§åˆ¶å—ï¼Œå…¶ä¸­åè€…æ˜¯æŒ‡å‘å†…å­˜çš„æŒ‡é’ˆï¼Œåè€…å¯¹ std::shared_ptr è¿›è¡Œå¼•ç”¨è®¡æ•°ã€‚

```
Â· [Overview](#3da7)
Â· [Item 18:](#0925) Unique_ptr for exclusive-ownership resource management.
  âˆ˜ [An Exclusive Relationship](#901d)
  âˆ˜ [Raw Pointers](#19f7)
  âˆ˜ [The smart pointer](#d8a0)
  âˆ˜ [Custom deleters](#6821)
  âˆ˜ [Custom interface](#df8a)
  âˆ˜ [Tips for Smart Pointers](#78f9)
Â· [Item 19:](#8f63) Shared_ptr for shared-ownership resource management.
  âˆ˜ [Analogy: Simple reference counting](#cf8e)
  âˆ˜ [Detour: Physical class layout](#f4b0)
Â· [Item 21:](#5716) Prefer unique_ptr and shared_ptr to direct use of new.
  âˆ˜ [Goal: No raw new or delete](#0242)
  âˆ˜ [Preferred Usage](#9426)
Â· [Conclusion](#61de)
Â· [References](#705d)
```

# æ¦‚è§‚

è®©æˆ‘ä»¬ç»§ç»­è®¨è®ºæ™ºèƒ½æŒ‡é’ˆ:C++ä¸­çš„ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒè·å¾—äº†åŸå§‹æŒ‡é’ˆçš„ä¼˜ç‚¹ï¼ŒåŒæ—¶å…‹æœäº†å®ƒä»¬çš„ç¼ºç‚¹ã€‚è¿™æ˜¯è¯¥ç³»åˆ—çš„ç¬¬ä¸‰éƒ¨åˆ†(å‚è§[ç¬¬ä¸€éƒ¨åˆ†](/smart-pointers-in-cpp-708486276526)ã€1ã€‘å’Œ[ç¬¬äºŒéƒ¨åˆ†](/understanding-smart-pointers-in-cpp-6c3854593503)ã€2ã€‘)ã€‚

æˆ‘ä»¬ç›´è§‚åœ°æ¢ç´¢ C++ä¸­æ™ºèƒ½æŒ‡é’ˆçš„æ¦‚å¿µã€‚æˆ‘ä»¬å°†å‚è€ƒä¸€æœ¬æ‰€æœ‰ C++å¼€å‘è€…éƒ½åº”è¯¥ç†Ÿæ‚‰çš„ä¹¦ï¼Œå³ Scott Meyers è‘—çš„*æœ‰æ•ˆçš„ç°ä»£ c++*[3]ã€‚

![](img/c0a9dcfd8c37135b529bda18a856fc5d.png)

åšå®¢ä¸­ä½¿ç”¨çš„æ‰€æœ‰å¯è§†åŒ–æ•ˆæœéƒ½æ˜¯ä½œè€…ä½¿ç”¨ [LucidChart](https://lucid.app/) åˆ›å»ºçš„ã€‚

# **ç¬¬ 18 é¡¹:**

ä½¿ç”¨`std::unique_ptr`è¿›è¡Œç‹¬å èµ„æºç®¡ç†ã€‚[3]

## æ’ä»–æ€§çš„å…³ç³»

åŠ¨æ€å†…å­˜(å³åŠ¨æ€åˆ†é…çš„å†…å­˜*)å¯é€šè¿‡[å †](https://www.educba.com/what-is-heap-memory/#:~:text=Heap%20memory%20is%20a%20part,can%20be%20static%20or%20dynamic.)è®¿é—®ã€‚*

## *åŸå§‹æŒ‡é’ˆ*

*![](img/9c376dd035516bb16d6d0f87072c2109.png)*

*ä»»ä½•é€šè¿‡â€œnewâ€åˆ†é…ç»™å †å†…å­˜çš„æŒ‡é’ˆéƒ½å¿…é¡»é€šè¿‡â€œdeleteâ€é‡Šæ”¾ï¼Œå¦åˆ™ï¼Œå†…å­˜ä¼šæ³„æ¼ã€‚æ¥æºâ€” [çº¦ç‘Ÿå¤«Â·ç½—å®¾é€Šåšå£«](https://medium.com/u/8049fa781539?source=post_page-----909512a5eb05--------------------------------)(å³ä½œè€…)ã€‚*

## *æ™ºèƒ½æŒ‡é’ˆ*

*å›å¤´çœ‹çœ‹åŸå§‹æŒ‡é’ˆã€‚*

*![](img/e93dbc872eda944cd1a61ee087d7d4e2.png)*

*åŸå§‹æŒ‡é’ˆ(T*)æ˜¯å¯å¤åˆ¶çš„ã€‚å¦‚æœå¤åˆ¶äº†ä¸€ä»½ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªäººä¸­è°æ‹¥æœ‰æ‰€æœ‰æƒï¼Ÿ*

*`**std::unique_ptr<T>**`*

*![](img/e409c725b5966194988f7d6bb714e747.png)**![](img/b70da182cdcfaeacf9a85efa3104de64.png)*

*`unique_ptr`æ˜¯å¯ç§»åŠ¨çš„(å³åªç§»åŠ¨)ã€‚*

*`**std::unique_ptr<T[]>**`*

*![](img/ee71106b8d0638c024493258a994bb51.png)*

*æ•°ç»„ç±»å‹æœ‰ä¸€ä¸ªä¸“é—¨åŒ–ã€‚*

*`**std::unique_ptr<T, Deleter>**`*

*![](img/af4efd6d448c1b25242867fb102f5d5f.png)**![](img/7b50daa5b53d0d43cf0a7e456288f5c5.png)*

## *è‡ªå®šä¹‰åˆ é™¤ç¨‹åº*

*å¯ç”¨æ•´æ´çš„äº‹ç‰©ã€‚*

## *è‡ªå®šä¹‰ç•Œé¢*

*ä¸ C è¯­è¨€ç¼–ç¨‹ OpenSSL æ¥å£ã€‚*

*è®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬çš„æ„é€ å‡½æ•°:*

*   *æŒ‰å€¼æ¥å—`unique_ptr`ã€‚*
*   *é€šå¸¸ï¼Œé€šè¿‡å€¼è·å–æŒ‡é’ˆæ‰€æœ‰æƒçš„å‡½æ•°è¢«ç§°ä¸ºæ¥æ”¶å™¨ã€‚*
*   *`unique_ptr` *æ±‡*æŒ‰æ‰€æœ‰æƒä¼ é€’è½¬ç§»ã€‚*
*   *è°ƒç”¨æ„é€ å‡½æ•°éœ€è¦ä¸€ä¸ª`unique_ptr`ã€‚å› æ­¤ï¼Œä¸€ä¸ªäººå¿…é¡»æ‹¥æœ‰`X509_REQ`ç»“æ„çš„*æ‰€æœ‰æƒ*ã€‚é€šè¿‡æŒ‰å€¼è·å–`unique_ptr`(å³é€šè¿‡`move`)ï¼Œæ„é€ å‡½æ•°è¡¨æ˜å®ƒ*è·å¾—äº†é‚£ä¸ª`X509_REQ`çš„æ‰€æœ‰æƒ*ã€‚*
*   *è¯·æ³¨æ„ï¼Œ`unique_ptr`æ˜¯ä½çº§ã€é RAIIã€åŸå§‹èµ„æº(`X509_REQ`)å’Œé«˜çº§ RAII å¯¹è±¡(`MyCSR`)ä¹‹é—´çš„ç²˜åˆå‰‚ã€‚*

## *æ™ºèƒ½æŒ‡é’ˆæç¤º*

*â€”å°†æ™ºèƒ½æŒ‡é’ˆç±»å‹è§†ä¸ºåŸå§‹æŒ‡é’ˆç±»å‹ã€‚*

*   *æŒ‰å€¼ä¼ é€’ã€‚*
*   *æŒ‰å€¼è¿”å›(å½“ç„¶)ã€‚*
*   *é€šè¿‡å¼•ç”¨ä¼ é€’æŒ‡é’ˆé€šå¸¸æ˜¯ä¸€ç§ä»£ç å‘³é“ã€‚*

*â€”æ™ºèƒ½æŒ‡é’ˆä¹Ÿæ˜¯å¦‚æ­¤ã€‚*

*   *ä»¥`unique_ptr`ä¸ºå€¼çš„å‡½æ•°æ˜¾ç¤º ***æ‰€æœ‰æƒè½¬ç§»*** ã€‚*
*   *ç”šè‡³æ˜¾ç¤ºå‡º ***ä»€ä¹ˆ*** è´£ä»»è¢«è½¬ç§»ï¼Œå› ä¸ºè´£ä»»è¢«ç¼–ç åœ¨`deleter`ç±»å‹ä¸­ã€‚*
*   *é€šå¸¸ï¼ŒèŒè´£æ˜¯ç®€å•åœ°è°ƒç”¨`delete`ã€‚*

*â€”æ™ºèƒ½æŒ‡é’ˆæ˜¯ç»å¸¸å®ç°çš„ç»†èŠ‚å’Œç²˜åˆå‰‚ã€‚*

*   *å°†`unique_ptr`æˆ–`shared_ptr`çƒ˜ç„™æˆ ***æ¥å£*** å¯èƒ½ä¼šæœ‰ä»£ç å‘³ã€‚ä½¿ç”¨ç±»ä¼¼äº`MyCSR`çš„ç±»æ¥ä»£æ›¿ã€‚*

# ***ç¬¬ 19 é¡¹***

***ä½¿ç”¨** `**shared_ptr**` **è¿›è¡Œå…±æœ‰èµ„æºç®¡ç†ã€‚[3]***

*`shared_ptr`å’Œ`unique_ptr`è¡¨é¢ç›¸ä¼¼ã€‚*

*ç„¶è€Œï¼Œå®ƒæ¯”è¿™å¤æ‚å¾—å¤šã€‚*

*`shared_ptr`è¡¨ç¤ºå…±æœ‰*æ‰€æœ‰æƒ*ã€‚å…·ä½“æ¥è¯´ï¼Œ ***å¼•ç”¨è®¡æ•°*** ã€‚*

## *ç±»æ¯”:ç®€å•çš„å¼•ç”¨è®¡æ•°*

> *æœ€åä¸€ä¸ªç¦»å¼€æˆ¿é—´çš„äººè¯·å…³ç¯å¥½å—ï¼Ÿ*

*å‡è®¾æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æˆ¿é—´ï¼Œä½ æ€ä¹ˆçŸ¥é“ä½ æ˜¯ä¸æ˜¯æœ€åä¸€ä¸ªï¼Ÿ*

*åœ¨è¿›å…¥æ—¶ï¼Œæ‰€æœ‰çš„å—è¯•è€…éƒ½è¦åœ¨ç½å­é‡Œæ”¾ä¸€ä¸ªä»£å¸ã€‚ç„¶åï¼Œåœ¨ç¦»å¼€æ—¶ï¼Œæ¯äººæ‹¿å›ä¸€ä¸ªä»£å¸ã€‚æ‰€ä»¥**æœ€å**ä»¤ç‰Œè¡¨ç¤ºä½ æ˜¯æœ€åä¸€ä¸ªäººã€‚*

*è¯·æ³¨æ„ï¼Œåœ¨æˆ‘ä»¬çš„è®¡åˆ’ä¸­ï¼Œæ‰€æœ‰äººéƒ½å¿…é¡»åˆä½œã€‚ä»»ä½•æ²¡æœ‰ç•™ä¸‹ä»¤ç‰Œå°±è¿›å…¥çš„äººéƒ½æœ‰è¢«ç•™åœ¨é»‘æš—ä¸­çš„å±é™©ï¼*

*è®©æˆ‘ä»¬çœ‹çœ‹å®ƒçš„æˆå‘˜:*

*é‚£`shared_ptr<int>`å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥åœ¨å“ªé‡Œå­˜å‚¨ int å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Ÿ*

*![](img/177dab8df625dae704239bc67196cd74.png)*

*`'shared_ptr'`å°†å‚è€ƒè®¡æ•°å­˜å‚¨åœ¨å•ç‹¬çš„â€œæ§åˆ¶å—â€ä¸­*

***å¤åˆ¶ä¸€ä¸ª***

*![](img/0e3bfcfdd238a4a191c08a460f566c73.png)*

*å½“`shared_ptr`å·²ç»æŒæœ‰ä¸€ä¸ªæŒ‡é’ˆæ—¶ï¼Œä¸ºä»€ä¹ˆæ§åˆ¶å—è¿˜éœ€è¦ä¸€ä¸ªæŒ‡å‘è¢«æ§å¯¹è±¡çš„æŒ‡é’ˆï¼Ÿ*

## *è¿‚å›:ç‰©ç†ç±»å¸ƒå±€*

*![](img/7803d5a6b48ae2eac9e11bebfee2a66d.png)**![](img/18557f0a4b725bd97e90dd9c6a5cacfd.png)*

*`**shared_ptr**`**--**-`**deleter."**`*

*ä¸`unique_ptr`ä¸åŒçš„æ˜¯ï¼Œ`shared_ptr`åœ¨ç‰©ç†å †åˆ†é…çš„å¯¹è±¡å’Œæ‰€æœ‰æƒçš„æ¦‚å¿µä¹‹é—´æ”¾ç½®äº†ä¸€ä¸ªé—´æ¥å±‚ã€‚*

*`shared_ptr`å®ä¾‹å®è´¨ä¸Šå‚ä¸äº†**æ§åˆ¶å—**çš„å¼•ç”¨è®¡æ•°*æ‰€æœ‰æƒ*ã€‚æ§åˆ¶å—æœ¬èº«æ˜¯â€œåˆ é™¤å—æ§å¯¹è±¡â€çš„å”¯ä¸€ä»²è£è€…*

*![](img/8c015ef0b548b45279cd7d93850cce93.png)*

# ***ç¬¬ 21 é¡¹:***

***æ›´å–œæ¬¢**`**unique_ptr**`**`**shared_ptr**`**ç›´æ¥ç”¨** `**new**` **ã€‚[3]*****

## ***ç›®æ ‡:æ—  raw `new`æˆ–`delete`***

***C++å†…å­˜ç®¡ç†ç¬¬ä¸€æ³•åˆ™:(1)æ¯ä¸€ä¸ª`new`éƒ½å¿…é¡»æœ‰ä¸€ä¸ªåŒ¹é…çš„`delete`ï¼Œåä¹‹äº¦ç„¶ã€‚***

***C++å†…å­˜ç®¡ç†çš„ç¬¬äºŒæ¡è§„åˆ™:(2)åœæ­¢ä½¿ç”¨æ‰‹åŠ¨è°ƒç”¨`delete`ï¼ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆï¼Œå…¶ææ„å‡½æ•°ä¼šåœ¨é€‚å½“çš„æ—¶å€™è‡ªåŠ¨è°ƒç”¨`delete`ã€‚***

***ä½†æ˜¯å¦‚æœæˆ‘ä»¬åœæ­¢å†™ä½œ`delete`...æ ¹æ®ç¬¬ä¸€æ¡è§„åˆ™ï¼Œæˆ‘ä»¬ä¸èƒ½åœæ­¢å†™ä½œå—ï¼Ÿ***

***è¯·æ³¨æ„ï¼Œæ­£åœ¨è°ƒç”¨â€œnew â€:æˆ‘ä»¬å¸Œæœ›é¿å…è¿™ç§æƒ…å†µã€‚***

***è¿ç­¹å­¦***

***â€œnewâ€ä½œä¸ºè¾“å…¥ä¼ é€’ç»™â€œshared_ptrâ€æ„é€ å‡½æ•°ã€‚ä¸‹ä¸€èŠ‚æ˜¯é¦–é€‰ç”¨æ³•ï¼Œåœ¨è¿™é‡Œä»»ä½•æ—¶å€™éƒ½ä¸è°ƒç”¨â€œnewâ€ã€‚***

***æ˜¯å•Šï¼å¦‚æœæˆ‘ä»¬ä¸æ‰“ç®—å†™`delete`ï¼Œé‚£ä¹ˆå°±åœæ­¢å†™`new`ã€‚***

***æ¯å½“æˆ‘ä»¬å †åˆ†é…ä¸€äº›ä¸œè¥¿æ—¶ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªå·¥å‚å‡½æ•°è¿”å›å·²ç»åŒ…è£…åœ¨æ™ºèƒ½æŒ‡é’ˆä¸­çš„ä¸œè¥¿ ***ã€‚******

***æˆ‘ä»¬ä¸åº”è¯¥ç”¨æ‰‹å»è§¦æ‘¸åŸå§‹æŒ‡é’ˆã€‚***

## ***é¦–é€‰ç”¨æ³•***

***ä¸éœ€è¦å¼€å‘äººå‘˜ç§°ä¹‹ä¸ºâ€œæ–°â€å¤ªæ£’äº†ã€‚ï¼***

***`**make_shared**` **ç”šè‡³å¯ä»¥ä¼˜åŒ–ã€‚*****

***![](img/ed027eada61335fdd3f62bd188d11f17.png)***

```
***ğŸ’¡ `unique_ptr<T>` is implicitly convertible to `shared_ptr<T>`...*** 
```

***ä» unique_ptr å¼ºåˆ¶è½¬æ¢å…±äº«æŒ‡é’ˆï¼Œè€Œä¸æ˜¯ç›¸åã€‚***

***![](img/0e3043a14ec02a4c0f9c43df66e5a387.png)***

# ***ç»“è®º***

## ***ä½¿ç”¨`make_shared and make_unique`***

*   ***`make_shared`å’Œ`make_unique`åŒ…ç”Ÿ`new`ï¼Œæ­£å¦‚`~shared_ptr`å’Œ`~unique_ptr`åŒ…ç”Ÿ`delete`ã€‚***
*   ***æ°¸è¿œä¸è¦ç”¨æ‰‹è§¦æ‘¸åŸå§‹æŒ‡é’ˆï¼Œç„¶åæ°¸è¿œä¸éœ€è¦æ‹…å¿ƒå®ƒä»¬ä¼šæ³„æ¼ã€‚***
*   ***`make_shared`å¯ä»¥è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚***

# ***å‚è€ƒ***

***[1] [**ç†è§£ C++ä¸­çš„æ™ºèƒ½æŒ‡é’ˆ**](/smart-pointers-in-cpp-708486276526)***

***[2] [**ç°ä»£ C++:ä»”ç»†çœ‹çœ‹æ™ºèƒ½æŒ‡é’ˆ**](/understanding-smart-pointers-in-cpp-6c3854593503)***

***[**ã€3ã€‘æœ‰æ•ˆçš„ç°ä»£ C++**](https://www.oreilly.com/library/view/effective-modern-c/9781491908419/)***

## ***é¢å¤–èµ„æº***

***å¯è§†åŒ–æ•ˆæœå’Œä¸€äº›ä¾‹å­çš„çµæ„Ÿæ¥è‡ªäº Arthur O'Dwyer çš„ä¼Ÿå¤§æ¼”è®²ï¼ŒYouTube ä¸Šçš„*å›åˆ°åŸºç¡€:æ™ºèƒ½æŒ‡é’ˆ*:***

***Yusuf Aksoy å…³äº STL å‡½å­çš„åšå®¢:***

***[](https://medium.com/@yusufaksoyeng/function-objects-functors-in-c-62e6b9cb8876) [## C++ä¸­çš„å‡½æ•°å¯¹è±¡(å‡½å­)

### åœ¨è¿™ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘æƒ³è§£é‡Šä»€ä¹ˆæ˜¯å‡½æ•°å¯¹è±¡ï¼Œä»¥åŠå®ƒä»¬å¦‚ä½•è¢«ç”¨æ¥è§£å†³ä¸åŒçš„â€¦

medium.com](https://medium.com/@yusufaksoyeng/function-objects-functors-in-c-62e6b9cb8876) 

C++20 ä¸­å¼•å…¥çš„æ–°ç‰¹æ€§ï¼Œä¾‹å¦‚ç”± [Gajendra Gulgulia](https://medium.com/u/74161854f6a1?source=post_page-----909512a5eb05--------------------------------) æ’°å†™çš„å…³äº*æ¦‚å¿µ*çš„åšå®¢ç³»åˆ—

[](https://ggulgulia.medium.com/c-20-concepts-part-1-the-basics-40f051c72776) [## C++ 20 æ¦‚å¿µ:ç¬¬ 1 éƒ¨åˆ†(åŸºç¡€)

### ç”¨æœ¬æ–‡ä¸­çš„ç®€å•ä¾‹å­ç¼–å†™æ‚¨çš„ç¬¬ä¸€ä¸ªæ¦‚å¿µ

ggulgulia.medium.com](https://ggulgulia.medium.com/c-20-concepts-part-1-the-basics-40f051c72776) 

æ›´å®Œæ•´çš„ C++æŒ‡å—ï¼Œå¦‚ Syed Khizaruddin çš„ç³»åˆ—æ–‡ç« ï¼Œ

[](https://khizaruddins.medium.com/c-complete-developer-guide-part-1-124d2298c98b) [## C++:å®Œæ•´çš„å¼€å‘äººå‘˜æŒ‡å—â€”ç¬¬ 1 éƒ¨åˆ†

### C++æ‰€æœ‰ç¼–ç¨‹è¯­è¨€ä¹‹æ¯

khizaruddins.medium.com](https://khizaruddins.medium.com/c-complete-developer-guide-part-1-124d2298c98b) 

è¿˜æœ‰æ›´å¤š+æ›´å¤šå³å°†åˆ°æ¥ï¼

```
**Want to Connect?**Follow Dr. Robinson on [LinkedIn](https://www.linkedin.com/company/superannotate/), [Twitter](https://twitter.com/jrobvision), [Facebook](https://www.facebook.com/superannotate), and [Instagram](https://www.instagram.com/doctor__jjj/).Visit my homepage for papers, blogs, email signups, and more!
```

[](https://www.jrobs-vision.com/) [## äººå·¥æ™ºèƒ½å·¥ç¨‹å¸ˆ|çº¦ç‘Ÿå¤«Â·pÂ·ç½—å®¾é€Š

### é—®å€™ï¼æˆ‘æ˜¯ Vicarious Surgical çš„äººå·¥æ™ºèƒ½å·¥ç¨‹å¸ˆï¼Œè‡´åŠ›äºæ¨è¿›ä¸‹ä¸€ä»£å¤–ç§‘æœºå™¨äººæŠ€æœ¯ã€‚æˆ‘çš„â€¦

www.jrobs-vision.com](https://www.jrobs-vision.com/)***