<html>
<head>
<title>Setup Microservices on Kubernetes â€” Write a Configuration File</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">åœ¨Kubernetesä¸Šè®¾ç½®å¾®æœåŠ¡â€”ç¼–å†™é…ç½®æ–‡ä»¶</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://betterprogramming.pub/set-up-microservice-on-kubernetes-write-config-file-8df7c2b07a4c?source=collection_archive---------2-----------------------#2022-07-04">https://betterprogramming.pub/set-up-microservice-on-kubernetes-write-config-file-8df7c2b07a4c?source=collection_archive---------2-----------------------#2022-07-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ebb2" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">å°†å¾®æœåŠ¡éƒ¨ç½²åˆ°Kubernetes</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/4f494c04841fbee583a065096dba9417.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*F4xGtYgKrYxbCCwi"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">ç”±<a class="ae kv" href="https://unsplash.com/@sw_creates?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">è¨å‡¡çº³Â·ç»´å…‹è²å°”å¾·</a>åœ¨<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>ä¸Šæ‹æ‘„çš„ç…§ç‰‡</p></figure><p id="088b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åœ¨Kubernetesä¸Šå»ºç«‹ä¸€ä¸ªå¾®æœåŠ¡ç³»ç»Ÿã€‚åœ¨ç¬¬ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•ä¸ºå¾®æœåŠ¡ç³»ç»Ÿçš„æ¯ä¸ªç»„ä»¶ç¼–å†™é…ç½®æ–‡ä»¶ã€‚</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="9a8c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">è¿™æ˜¯åœ¨Kubernetesä¸Šè®¾ç½®å¾®æœåŠ¡ç³»åˆ—çš„ç¬¬ä¸€éƒ¨åˆ†:</p><ol class=""><li id="3c1c" class="lz ma iq ky b kz la lc ld lf mb lj mc ln md lr me mf mg mh bi translated">åœ¨Kubernetesä¸Šè®¾ç½®ä¸€ä¸ªå¾®æœåŠ¡â€”â€”å†™é…ç½®æ–‡ä»¶ã€‚</li><li id="94c9" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated"><a class="ae kv" href="https://medium.com/@hmquan08011996/setup-microservices-on-kubernetes-automating-kubernetes-with-argocd-cb94622dac5b" rel="noopener">åœ¨Kubernetesä¸Šå»ºç«‹ä¸€ä¸ªå¾®æœåŠ¡â€”â€”ç”¨ArgoCDè‡ªåŠ¨åŒ–Kubernetes</a>ã€‚</li><li id="df55" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated">åœ¨Kubernetesä¸Šè®¾ç½®å¾®æœåŠ¡-å®æ–½CI/CDã€‚</li></ol></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="d8ab" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">ç³»ç»Ÿç»“æ„</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/a82ddf2a7c11bdd9791ef9e0aa943ebc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DdywEldGT0QvyU1oDXjHcw.png"/></div></div></figure><p id="9ce2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå«åš<a class="ae kv" href="https://moleculer.services/docs/0.14/" rel="noopener ugc nofollow" target="_blank"> Moleculer </a>çš„æ¡†æ¶æ¥æ„å»ºä¸Šå›¾ä¸­çš„å¾®æœåŠ¡ç³»ç»Ÿã€‚Moleculeræ˜¯ä¸€ä¸ªç”¨äº<a class="ae kv" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>çš„å¿«é€Ÿã€ç°ä»£ã€å¼ºå¤§çš„å¾®æœåŠ¡æ¡†æ¶ã€‚å®ƒå¸®åŠ©æ‚¨æ„å»ºé«˜æ•ˆã€å¯é çš„&amp;å¯æ‰©å±•æœåŠ¡ã€‚Moleculerä¸ºæ„å»ºå’Œç®¡ç†æ‚¨çš„å¾®æœåŠ¡æä¾›äº†è®¸å¤šåŠŸèƒ½ã€‚</p><p id="3799" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://moleculer.services/docs/0.14/moleculer-web.html" rel="noopener ugc nofollow" target="_blank"> APIç½‘å…³</a>å‘æœ€ç»ˆç”¨æˆ·å…¬å¼€åˆ†å­æœåŠ¡ã€‚ç½‘å…³æ˜¯è¿è¡ŒHTTPã€WebSocketsç­‰çš„å¸¸è§„åˆ†å­æœåŠ¡ã€‚)æœåŠ¡å™¨ã€‚</p><p id="d486" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">NATSï¼Œä¹Ÿå°±æ˜¯ä¼ é€å™¨ï¼Œå®ƒæ˜¯æœåŠ¡ç”¨æ¥äº¤æ¢æ¶ˆæ¯çš„é€šä¿¡æ€»çº¿ã€‚å®ƒä¼ è¾“äº‹ä»¶ã€è¯·æ±‚å’Œå“åº”ã€‚</p><p id="1bdc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ç±»åˆ«å’Œæ–°é—»æœåŠ¡æ˜¯ä¸€ä¸ªç®€å•çš„JavaScriptæ¨¡å—ï¼ŒåŒ…å«äº†å¤æ‚åº”ç”¨ç¨‹åºçš„ä¸€éƒ¨åˆ†ã€‚å®ƒæ˜¯å­¤ç«‹çš„ï¼Œè‡ªæˆä¸€ä½“çš„ã€‚</p><p id="9cf7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ç¼“å­˜ç³»ç»Ÿä½¿ç”¨Redisï¼Œæ•°æ®åº“ä½¿ç”¨Postgresã€‚</p><p id="534c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æˆ‘å·²ç»ç®€è¦ä»‹ç»äº†æˆ‘ä»¬å°†åœ¨Kubernetesä¸Šéƒ¨ç½²çš„æ¶æ„ï¼Œæˆ‘ä»¬ç°åœ¨å°†å¼€å§‹å·¥ä½œã€‚</p><h1 id="c57e" class="mn mo iq bd mp mq ng ms mt mu nh mw mx jw ni jx mz jz nj ka nb kc nk kd nd ne bi translated">æ„å»ºDockerå®¹å™¨æ˜ åƒ</h1><p id="fc06" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">ä»<a class="ae kv" href="https://github.com/hoalongnatsu/microservices" rel="noopener ugc nofollow" target="_blank">https://github.com/hoalongnatsu/microservices</a>å…‹éš†æºä»£ç ã€‚è½¬åˆ°æ–‡ä»¶å¤¹<code class="fe nq nr ns nt b">microservices/code</code>å¹¶è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ„å»ºä¸€ä¸ªæ˜ åƒã€‚<strong class="ky ir">å›¾åƒåç§°åº”ä¸º</strong> <code class="fe nq nr ns nt b"><strong class="ky ir">&lt;docker-hub-username&gt;/microservice</strong></code>ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="c33a" class="ny mo iq nt b gy nz oa l ob oc">git clone <a class="ae kv" href="https://github.com/hoalongnatsu/microservices.git" rel="noopener ugc nofollow" target="_blank">https://github.com/hoalongnatsu/microservices.git</a> &amp;&amp; cd microservices/code<br/>docker build . -t 080196/microservice<br/>docker push 080196/microservice</span></pre><p id="1c2d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä¸ºæ¯ä¸ªç»„ä»¶ç¼–å†™ä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚</p><h1 id="1921" class="mn mo iq bd mp mq ng ms mt mu nh mw mx jw ni jx mz jz nj ka nb kc nk kd nd ne bi translated">éƒ¨ç½²APIç½‘å…³</h1><p id="0099" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">é¦–å…ˆï¼Œæˆ‘ä»¬ä¸ºAPIç½‘å…³ç¼–å†™ä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚åˆ›å»ºä¸€ä¸ªåä¸º<code class="fe nq nr ns nt b">api-gateway-deployment.yaml</code>çš„æ–‡ä»¶ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="7ae7" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: api-gateway<br/>  labels:<br/>    component: api-gateway<br/>spec:<br/>  revisionHistoryLimit: 1<br/>  selector:<br/>    matchLabels:<br/>      component: api-gateway<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: api-gateway<br/>    spec:<br/>      containers:<br/>        - name: api-gateway<br/>          image: 080196/microservice<br/>          ports:<br/>            - name: http<br/>              containerPort: 3000<br/>              protocol: TCP<br/>          livenessProbe:<br/>            httpGet:<br/>              path: /<br/>              port: http<br/>          readinessProbe:<br/>            httpGet:<br/>              path: /<br/>              port: http<br/>          env:<br/>            - name: NODE_ENV<br/>              value: testing<br/>            - name: SERVICEDIR<br/>              value: dist/services<br/>            - name: SERVICES<br/>              value: api<br/>            - name: PORT<br/>              value: "3000"<br/>            - name: CACHER<br/>              value: redis://redis:6379<br/>            - name: DB_HOST<br/>              value: postgres<br/>            - name: DB_PORT<br/>              value: "5432"<br/>            - name: DB_NAME<br/>              value: postgres<br/>            - name: DB_USER<br/>              value: postgres<br/>            - name: DB_PASSWORD<br/>              value: postgres<br/>            - name: TRANSPORTER<br/>              value: nats://nats:4222</span></pre><p id="38d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æˆ‘ä»¬ä¹‹å‰å»ºç«‹çš„åä¸º<code class="fe nq nr ns nt b">080196/microservice</code>çš„æ˜ åƒï¼ŒåŒ…æ‹¬ä¸‰ä¸ªåä¸º<code class="fe nq nr ns nt b">api</code>ã€<code class="fe nq nr ns nt b">categories</code>å’Œ<code class="fe nq nr ns nt b">news</code>çš„æœåŠ¡ã€‚æˆ‘ä»¬é€šè¿‡å°†æœåŠ¡çš„åç§°ä¼ é€’ç»™åä¸ºSERVICESçš„ç¯å¢ƒå˜é‡æ¥é€‰æ‹©éœ€è¦è¿è¡Œçš„æœåŠ¡ã€‚</p><p id="801f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">åœ¨ä¸Šé¢çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†APIç½‘å…³çš„å€¼ä½œä¸º<code class="fe nq nr ns nt b">api</code>ä¼ é€’ã€‚</p><p id="c18f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¦‚æœæ‚¨æŸ¥çœ‹code/services/api.service.tsæ–‡ä»¶ä¸­çš„ä»£ç ï¼Œæˆ‘ä»¬å°†åœ¨ç¬¬15è¡Œçœ‹åˆ°apiç½‘å…³çš„è®¾ç½®ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="172d" class="ny mo iq nt b gy nz oa l ob oc">...<br/>settings: {<br/>  port: process.env.PORT || 3001,<br/>...</span></pre><p id="cc94" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ä½¿ç”¨ç«¯å£envï¼ŒAPIç½‘å…³ç›‘å¬ç«¯å£3000ã€‚CACHER envç”¨äºå£°æ˜æœåŠ¡ä½¿ç”¨çš„Redisä¸»æœºã€‚å‰ç¼€ä¸ºDB_çš„envç”¨äºæ•°æ®åº“ã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºéƒ¨ç½²ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="c79e" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f api-gateway-deployment.yaml</span></pre><p id="6ccc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ç»“æœã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="4710" class="ny mo iq nt b gy nz oa l ob oc">$ kubectl get deploy<br/>NAME         READY   UP-TO-DATE   AVAILABLE   AGE<br/>api-gateway  0/1     1            0           100s</span></pre><p id="d2ca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æˆ‘ä»¬å·²ç»åˆ›å»ºäº†APIç½‘å…³ï¼Œä½†æ˜¯å½“ä½ å¾—åˆ°podæ—¶ã€‚æ‚¨å°†çœ‹åˆ°å®ƒæ²¡æœ‰æˆåŠŸè¿è¡Œï¼Œè€Œæ˜¯ä¼šä¸€æ¬¡åˆä¸€æ¬¡åœ°é‡æ–°å¯åŠ¨ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="d22a" class="ny mo iq nt b gy nz oa l ob oc">$ kubectl get pod<br/>NAME                           READY   STATUS    RESTARTS   AGE<br/>api-gateway-79688cf6f5-g88f2   0/1     Running   2          93s</span></pre><p id="b927" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ£€æŸ¥æ—¥å¿—ä»¥æ‰¾å‡ºåŸå› ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="7c16" class="ny mo iq nt b gy nz oa l ob oc">$ kubectl logs api-gateway-79688cf6f5-g88f2<br/>...<br/>[2021-11-07T14:53:37.449Z] ERROR api-gateway-79688cf6f5-g88f2-28/CACHER: Error: getaddrinfo EAI_AGAIN redis<br/>    at GetAddrInfoReqWrap.onlookup [as oncomplete] (dns.js:60:26) {<br/>  errno: 'EAI_AGAIN',<br/>  code: 'EAI_AGAIN',<br/>  syscall: 'getaddrinfo',<br/>  hostname: 'redis'<br/>}</span></pre><p id="bc68" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ­¤å¤„æ˜¾ç¤ºçš„é”™è¯¯æ˜¯podæ— æ³•è¿æ¥åˆ°Redisï¼Œå› ä¸ºæˆ‘ä»¬å°šæœªåˆ›å»ºä»»ä½•Redisï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†åˆ›å»ºRedisã€‚</p><h1 id="d693" class="mn mo iq bd mp mq ng ms mt mu nh mw mx jw ni jx mz jz nj ka nb kc nk kd nd ne bi translated">éƒ¨ç½²Redis</h1><p id="d1c5" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">åˆ›å»ºä¸€ä¸ªåä¸º<code class="fe nq nr ns nt b">redis-deployment.yaml</code>çš„æ–‡ä»¶ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="5c1c" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: redis<br/>  labels:<br/>    component: redis<br/>spec:<br/>  strategy:<br/>    type: Recreate<br/>  selector:<br/>    matchLabels:<br/>      component: redis<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: redis<br/>    spec:<br/>      containers:<br/>        - name: redis<br/>          image: redis<br/>          ports:<br/>            - containerPort: 6379</span></pre><p id="d8fa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">è¿è¡Œä»¥ä¸‹å‘½ä»¤ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="9bcf" class="ny mo iq nt b gy nz oa l ob oc">$ kubectl apply -f redis-deployment.yaml<br/>deployment.apps/redis created</span><span id="cd19" class="ny mo iq nt b gy od oa l ob oc">$ kubectl get deploy<br/>NAME          READY   UP-TO-DATE   AVAILABLE   AGE<br/>api-gateway   0/1     1            0           16m<br/>redis         1/1     1            1           14s</span></pre><p id="d73c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ¥ä¸‹æ¥ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦è¿æ¥åˆ°Redisï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå®ƒåˆ›å»ºä¸€ä¸ªæœåŠ¡èµ„æºã€‚åˆ›å»ºä¸€ä¸ªåä¸º<code class="fe nq nr ns nt b">redis-service.yaml</code>çš„æ–‡ä»¶ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="d8f2" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: redis<br/>  labels:<br/>    component: redis<br/>spec:<br/>  selector:<br/>    component: redis<br/>  ports:<br/>    - port: 6379</span></pre><p id="d200" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">è¿è¡Œå‘½ä»¤ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="a31e" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f redis-service.yaml</span></pre><p id="619b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">é‡æ–°å¯åŠ¨APIç½‘å…³éƒ¨ç½²ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="06e9" class="ny mo iq nt b gy nz oa l ob oc">kubectl rollout restart deploy api-gateway</span></pre><p id="3e2f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ£€æŸ¥APIç½‘å…³çš„æ—¥å¿—ï¼Œæˆ‘ä»¬ä»ç„¶çœ‹åˆ°å®ƒæ²¡æœ‰è¿è¡Œã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="dbc8" class="ny mo iq nt b gy nz oa l ob oc">$ kubectl logs api-gateway-7f4d5f54f-lzgkd<br/>...<br/>[2021-11-07T15:05:10.388Z] INFO  api-gateway-7f4d5f54f-lzgkd-28/CACHER: Redis cacher connected.</span><span id="4048" class="ny mo iq nt b gy od oa l ob oc">Sequelize CLI [Node: 12.13.0, CLI: 6.2.0, ORM: 6.6.5]</span><span id="f53f" class="ny mo iq nt b gy od oa l ob oc">Loaded configuration file "migrate/config.js".<br/>Using environment "testing".</span><span id="8b8e" class="ny mo iq nt b gy od oa l ob oc">ERROR: connect ECONNREFUSED 127.0.0.1:5432</span><span id="0df8" class="ny mo iq nt b gy od oa l ob oc">Error: Command failed: sequelize-cli db:migrate<br/>ERROR: connect ECONNREFUSED 127.0.0.1:5432<br/>    at ChildProcess.exithandler (child_process.js:295:12)<br/>    at ChildProcess.emit (events.js:210:5)<br/>    at maybeClose (internal/child_process.js:1021:16)<br/>    at Process.ChildProcess._handle.onexit (internal/child_process.js:283:5) {<br/>  killed: false,<br/>  code: 1,<br/>  signal: null,<br/>  cmd: 'sequelize-cli db:migrate'<br/>} <br/>Sequelize CLI [Node: 12.13.0, CLI: 6.2.0, ORM: 6.6.5]</span><span id="b82c" class="ny mo iq nt b gy od oa l ob oc">Loaded configuration file "migrate/config.js".<br/>Using environment "testing".</span><span id="c258" class="ny mo iq nt b gy od oa l ob oc">ERROR: connect ECONNREFUSED 127.0.0.1:5432<br/>...</span></pre><p id="3e86" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ˜¾ç¤ºçš„é”™è¯¯æ˜¯podæ— æ³•è¿æ¥åˆ°æ•°æ®åº“ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ã€‚</p><h1 id="0a8d" class="mn mo iq bd mp mq ng ms mt mu nh mw mx jw ni jx mz jz nj ka nb kc nk kd nd ne bi translated">éƒ¨ç½²æ•°æ®åº“</h1><p id="c243" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">ä¸ºäº†éƒ¨ç½²æ•°æ®åº“ï¼Œæˆ‘ä»¬ä½¿ç”¨StatefulSetã€‚åˆ›å»ºä¸€ä¸ªåä¸º<code class="fe nq nr ns nt b">postgres-statefulset.yaml</code>çš„æ–‡ä»¶ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="a5d3" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: apps/v1<br/>kind: StatefulSet<br/>metadata:<br/>  name: postgres<br/>  labels:<br/>    component: postgres<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      component: postgres<br/>  serviceName: postgres<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: postgres<br/>    spec:<br/>      containers:<br/>        - name: postgres<br/>          image: postgres:11<br/>          ports:<br/>            - containerPort: 5432<br/>          volumeMounts:<br/>            - mountPath: /var/lib/postgresql/data<br/>              name: postgres-data<br/>          env:<br/>            - name: POSTGRES_DB<br/>              value: postgres<br/>            - name: POSTGRES_USER<br/>              value: postgres<br/>            - name: POSTGRES_PASSWORD<br/>              value: postgres<br/>  volumeClaimTemplates:<br/>    - metadata:<br/>        name: postgres-data<br/>      spec:<br/>        accessModes:<br/>          - ReadWriteOnce<br/>        storageClassName: hostpath<br/>        resources:<br/>          requests:<br/>            storage: 5Gi</span></pre><p id="e3d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"/><code class="fe nq nr ns nt b"><strong class="ky ir">storageClassName</strong></code><strong class="ky ir">å­—æ®µå–å†³äºæ‚¨çš„Kubernetesé›†ç¾¤ï¼Œæ‚¨å°†æŒ‡å®šç›¸åº”çš„</strong> <code class="fe nq nr ns nt b"><strong class="ky ir">storageClassName </strong></code> <strong class="ky ir">å­—æ®µã€‚</strong>è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºSTSã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="1829" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f postgres-statefulset.yaml</span></pre><p id="0232" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ä¸ºæ•°æ®åº“æœåŠ¡èµ„æºåˆ›å»ºä¸€ä¸ªåä¸º<code class="fe nq nr ns nt b">postgres-service.yaml</code>çš„æ–‡ä»¶ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="f33c" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: postgres<br/>  labels:<br/>    component: postgres<br/>spec:<br/>  selector:<br/>    component: postgres<br/>  ports:<br/>    - port: 5432</span></pre><p id="a766" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">åˆ›é€ å®ƒã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="e148" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f postgres-service.yaml</span></pre><p id="58d4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">é‡æ–°å¯åŠ¨APIç½‘å…³éƒ¨ç½²ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="01f1" class="ny mo iq nt b gy nz oa l ob oc">kubectl rollout restart deploy api-gateway</span></pre><p id="0f15" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ£€æŸ¥APIç½‘å…³çš„æ—¥å¿—ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å®ƒæ­£åœ¨æˆåŠŸè¿è¡Œã€‚</p><p id="53db" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éƒ¨ç½²ç±»åˆ«å’Œæ–°é—»æœåŠ¡ã€‚</p><h1 id="75b9" class="mn mo iq bd mp mq ng ms mt mu nh mw mx jw ni jx mz jz nj ka nb kc nk kd nd ne bi translated">éƒ¨ç½²ç±»åˆ«å’Œæ–°é—»æœåŠ¡</h1><p id="ff60" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">åˆ›å»ºä¸€ä¸ªåä¸º<code class="fe nq nr ns nt b">categories-news-deployment.yaml</code>çš„æ–‡ä»¶ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="3d2c" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: categories-service<br/>  labels:<br/>    component: categories-service<br/>spec:<br/>  revisionHistoryLimit: 1<br/>  selector:<br/>    matchLabels:<br/>      component: categories-service<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: categories-service<br/>    spec:<br/>      containers:<br/>        - name: categories-service<br/>          image: 080196/microservice<br/>          env:<br/>            - name: NODE_ENV<br/>              value: testing<br/>            - name: SERVICEDIR<br/>              value: dist/services<br/>            - name: SERVICES<br/>              value: categories<br/>            - name: CACHER<br/>              value: redis://redis:6379<br/>            - name: DB_HOST<br/>              value: postgres<br/>            - name: DB_PORT<br/>              value: "5432"<br/>            - name: DB_NAME<br/>              value: postgres<br/>            - name: DB_USER<br/>              value: postgres<br/>            - name: DB_PASSWORD<br/>              value: postgres<br/>            - name: TRANSPORTER<br/>              value: nats://nats:4222</span><span id="b970" class="ny mo iq nt b gy od oa l ob oc">---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: news-service<br/>  labels:<br/>    component: news-service<br/>spec:<br/>  revisionHistoryLimit: 1<br/>  selector:<br/>    matchLabels:<br/>      component: news-service<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: news-service<br/>    spec:<br/>      containers:<br/>        - name: news-service<br/>          image: 080196/microservice<br/>          env:<br/>            - name: NODE_ENV<br/>              value: testing<br/>            - name: SERVICEDIR<br/>              value: dist/services<br/>            - name: SERVICES<br/>              value: news<br/>            - name: CACHER<br/>              value: redis://redis:6379<br/>            - name: DB_HOST<br/>              value: postgres<br/>            - name: DB_PORT<br/>              value: "5432"<br/>            - name: DB_NAME<br/>              value: postgres<br/>            - name: DB_USER<br/>              value: postgres<br/>            - name: DB_PASSWORD<br/>              value: postgres<br/>            - name: TRANSPORTER<br/>              value: nats://nats:4222</span></pre><p id="62a9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">åˆ›é€ å®ƒã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="0eb1" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f categories-news-deployment.yaml</span></pre><p id="3875" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸ºæˆ‘ä»¬çš„<code class="fe nq nr ns nt b">moleculer</code>æœåŠ¡åˆ›å»ºä¸€ä¸ªå¯ä»¥ä¸ä»–äººé€šä¿¡çš„NATSä¼ è¾“å™¨ã€‚</p><h1 id="57eb" class="mn mo iq bd mp mq ng ms mt mu nh mw mx jw ni jx mz jz nj ka nb kc nk kd nd ne bi translated">éƒ¨ç½²NATS</h1><p id="9c0f" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">åˆ›å»ºä¸€ä¸ªåä¸º<code class="fe nq nr ns nt b">nats-deployment.yaml</code>çš„æ–‡ä»¶ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="c1c5" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: nats<br/>  labels:<br/>    component: nats<br/>spec:<br/>  strategy:<br/>    type: Recreate<br/>  selector:<br/>    matchLabels:<br/>      component: nats<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: nats<br/>    spec:<br/>      containers:<br/>        - name: nats<br/>          image: nats<br/>          ports:<br/>            - containerPort: 4222</span></pre><p id="a955" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">åˆ›é€ å®ƒã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="575f" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f nats-deployment.yaml</span></pre><p id="5fdb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ä¸ºNATSåˆ›å»ºä¸€ä¸ªåä¸º<code class="fe nq nr ns nt b">nats-service.yaml</code>çš„æ–‡ä»¶ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="5595" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: nats<br/>  labels:<br/>    component: nats<br/>spec:<br/>  selector:<br/>    component: nats<br/>  ports:<br/>    - port: 4222</span></pre><p id="44a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">åˆ›é€ å®ƒã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="dfdf" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f nats-service.yaml</span></pre><p id="7afe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ£€æŸ¥APIç½‘å…³çš„æ—¥å¿—ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ç±»åˆ«å’Œæ–°é—»æœåŠ¡è¿æ¥åˆ°APIç½‘å…³ã€‚</p><p id="c30b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ‰€ä»¥æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå·²ç»æˆåŠŸè¿è¡ŒğŸ˜ã€‚</p><p id="880c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ä½†æ˜¯æ‚¨æ˜¯å¦æ³¨æ„åˆ°æˆ‘ä»¬å£°æ˜çš„envå˜é‡åœ¨æˆ‘ä»¬çš„éƒ¨ç½²æ–‡ä»¶ä¸­æœ‰ç‚¹é•¿ä¸”é‡å¤ï¼Ÿæˆ‘ä»¬å¯ä»¥è¯´å¾—æ›´æ¸…æ¥šã€‚</p><h1 id="c041" class="mn mo iq bd mp mq ng ms mt mu nh mw mx jw ni jx mz jz nj ka nb kc nk kd nd ne bi translated">é€šç”¨é…ç½®å£°æ˜</h1><p id="d47a" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ConfigMapè¿›è¡Œé›†ä¸­é…ç½®ã€‚åˆ›å»ºä¸€ä¸ªåä¸º<code class="fe nq nr ns nt b">microservice-cm.yaml</code>çš„æ–‡ä»¶ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="5458" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: microservice-cm<br/>  labels:<br/>    component: microservice-cm<br/>data:<br/>  NODE_ENV: testing<br/>  SERVICEDIR: dist/services<br/>  TRANSPORTER: nats://nats:4222<br/>  CACHER: redis://redis:6379<br/>  DB_NAME: postgres<br/>  DB_HOST: postgres<br/>  DB_USER: postgres<br/>  DB_PASSWORD: postgres<br/>  DB_PORT: "5432"</span></pre><p id="fce7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">åˆ›é€ å®ƒã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="8d4f" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f microservice-cm.yaml</span></pre><p id="8ca6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ›´æ–°æ–‡ä»¶<code class="fe nq nr ns nt b">api-gateway-deployment.yaml</code>ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="493d" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: api-gateway<br/>  labels:<br/>    component: api-gateway<br/>spec:<br/>  revisionHistoryLimit: 1<br/>  selector:<br/>    matchLabels:<br/>      component: api-gateway<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: api-gateway<br/>    spec:<br/>      containers:<br/>        - name: api-gateway<br/>          image: 080196/microservice<br/>          ports:<br/>            - name: http<br/>              containerPort: 3000<br/>              protocol: TCP<br/>          livenessProbe:<br/>            httpGet:<br/>              path: /<br/>              port: http<br/>          readinessProbe:<br/>            httpGet:<br/>              path: /<br/>              port: http<br/>          env:<br/>            - name: SERVICES<br/>              value: api<br/>            - name: PORT<br/>              value: "3000"<br/>          envFrom:<br/>            - configMapRef:<br/>                name: microservice-cm</span></pre><p id="121b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ›´æ–°æ–‡ä»¶<code class="fe nq nr ns nt b">categories-news-deployment.yaml</code>ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="7731" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: categories-service<br/>  labels:<br/>    component: categories-service<br/>spec:<br/>  revisionHistoryLimit: 1<br/>  selector:<br/>    matchLabels:<br/>      component: categories-service<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: categories-service<br/>    spec:<br/>      containers:<br/>        - name: categories-service<br/>          image: 080196/microservice<br/>          env:<br/>            - name: SERVICES<br/>              value: categories<br/>          envFrom:<br/>            - configMapRef:<br/>                name: microservice-cm</span><span id="1a00" class="ny mo iq nt b gy od oa l ob oc">---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: news-service<br/>  labels:<br/>    component: news-service<br/>spec:<br/>  revisionHistoryLimit: 1<br/>  selector:<br/>    matchLabels:<br/>      component: news-service<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: news-service<br/>    spec:<br/>      containers:<br/>        - name: news-service<br/>          image: 080196/microservice<br/>          env:<br/>            - name: SERVICES<br/>              value: news<br/>          envFrom:<br/>            - configMapRef:<br/>                name: microservice-cm</span></pre><p id="7637" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ›´æ–°ä¸€ä¸‹ã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="82f5" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f api-gateway-deployment.yaml<br/>kubectl apply -f categories-news-deployment.yaml</span></pre><p id="f32e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æ£€æŸ¥æˆ‘ä»¬çš„ç³»ç»Ÿã€‚</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="71f4" class="ny mo iq nt b gy nz oa l ob oc">$ kubectl get pod<br/>NAME                                  READY   STATUS    RESTARTS  <br/>api-gateway-86b67895fd-cphmv          1/1     Running   0<br/>categories-service-84c74cd87c-zjtd2   1/1     Running   0<br/>nats-65687968fc-2drwp                 1/1     Running   0<br/>news-service-69f45b8668-kv9dm         1/1     Running   0<br/>postgres-0                            1/1     Running   0<br/>redis-58c4799ccc-qhv2z                1/1     Running   0</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="4891" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å› æ­¤ï¼Œæˆ‘ä»¬å·²ç»å°†å¾®æœåŠ¡éƒ¨ç½²åˆ°Kubernetesï¼Œæ­£å¦‚æ‚¨æ‰€è§ï¼Œè¿™å¹¶ä¸å›°éš¾ï¼Œä¸æ˜¯å—ï¼Ÿ</p><p id="ce93" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¦‚æœä½ å–œæ¬¢æˆ‘çš„æ–‡ç« ï¼Œä½ å¯ä»¥ç»™æˆ‘ä¹°æ¯å’–å•¡æ¥æ”¯æŒæˆ‘ã€‚â˜•ï¸ï¼Œè°¢è°¢ä½ ã€‚</p></div></div>    
</body>
</html>