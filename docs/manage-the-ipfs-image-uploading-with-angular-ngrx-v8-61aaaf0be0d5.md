# ä½¿ç”¨ Angular NgRx v8 ç®¡ç† IPFS å›¾åƒä¸Šä¼ 

> åŸæ–‡ï¼š<https://betterprogramming.pub/manage-the-ipfs-image-uploading-with-angular-ngrx-v8-61aaaf0be0d5>

## æœ¬ç³»åˆ—çš„ç¬¬ä¸‰éƒ¨åˆ†å±•ç¤ºäº†æˆ‘ä»¬å¦‚ä½•ä¸º **FleaMarket** æ™ºèƒ½åˆçº¦æ„å»º NgRx ä¾›ç”µçš„ DApp

![](img/802c1985ff08788600bd7ca60cf732c0.png)

å›¾ç‰‡æ¥è‡ª [Pixabay](https://pixabay.com/?utm_source=link-attribution&utm_medium=referral&utm_campaign=image&utm_content=2750995) çš„[æ–¯è’‚èŠ¬Â·å‡¯å‹’](https://pixabay.com/users/KELLEPICS-4893063/?utm_source=link-attribution&utm_medium=referral&utm_campaign=image&utm_content=2750995)

è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘ä»¬çš„åšå®¢ç³»åˆ—ç¬¬äºŒéƒ¨åˆ†çš„å»¶ç»­ï¼Œåœ¨é‚£é‡Œæˆ‘ä»¬æ¼”ç¤ºäº†å¦‚ä½•å°†æˆ‘ä»¬çš„ DApp è¿æ¥åˆ°è¿è¡Œåœ¨ Infura ä¸Šçš„ IPFS èŠ‚ç‚¹ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨ç”± NgRx æ”¯æŒçš„ IPFS å›¾åƒä¸Šä¼ åŠŸèƒ½çš„ç¼–ç ã€‚

# æ›´æ–°åˆ° 8ï¸ç‰ˆæœ¬

é¦–å…ˆå°†æˆ‘ä»¬çš„ FleaMarketDApp é¡¹ç›®å‡çº§åˆ°æœ€æ–°çš„ Angular ç‰ˆæœ¬ v8ã€‚

`ng update @angular/cli @angular/core @angular/material`

æˆ‘ä»¬å¸Œæœ›ç¡®ä¿ä½¿ç”¨ Node.js ç‰ˆæœ¬ 12 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œå¹¶å®‰è£…å¿…è¦çš„å·¥å…·æ¥ç¼–è¯‘æœ¬åœ°èŠ‚ç‚¹æ¨¡å—ã€‚

æˆ‘ä»¬è¿˜éœ€è¦å°† NgRx åº“æ›´æ–°åˆ°å®ƒçš„æœ€æ–°ç‰ˆæœ¬ v8ã€‚

ä¸ºäº†å¯ç”¨æƒ°æ€§è·¯ç”±çš„åŠ¨æ€å¯¼å…¥ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨`tsconfig.json`æ–‡ä»¶ä¸­å°†`module`ç¼–è¯‘å±æ€§è®¾ç½®ä¸ºå€¼`esnext`:

```
"compilerOptions": {
  "baseUrl": "./",
  "outDir": "./dist/out-tsc",
  "sourceMap": true,
 ** "module": "esnext",**
   ....
```

è¿™ä¸ªç‰ˆæœ¬ä¸­åŒ…å«çš„ä¸€ä¸ªå¾ˆé…·çš„[ç‰¹æ€§](https://next.ngrx.io/guide/migration/v8)æ˜¯æ‰€æœ‰çš„ç‰¹æ•ˆåœ¨å‡ºé”™æ—¶ä¼šè‡ªåŠ¨æ¢å¤ã€‚

# IPFS å±åœ°

ä¸ºäº†ä¸ IPFS ç½‘ç»œäº¤äº’ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£… [IPFS HTTP å®¢æˆ·ç«¯åº“](https://github.com/ipfs/js-ipfs-http-client):

```
npm install ipfs-http-client
```

æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå®šåˆ¶çš„ Webpack é…ç½®æ–‡ä»¶æ¥å‘Šè¯‰ Angular åœ¨ç¼–è¯‘ä¸­åŒ…å«åŠ å¯†çš„`node`æ¨¡å—ã€‚é¦–å…ˆå®‰è£…è‡ªå®šä¹‰ Webpack ç”Ÿæˆå™¨:

`npm install -save-dev @angular-builders/custom-webpack`

** * *æ³¨æ„:åœ¨ Angular v8 ä¸­æˆ‘ä»¬ä¸å†éœ€è¦å®‰è£…* `*@angular-builders/dev-server*` *åŒ…âš ï¸****

ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹ä¸Šä¸‹æ–‡å‘é¡¹ç›®æ·»åŠ ä¸€ä¸ª`extra-webpack.config.js`æ–‡ä»¶:

æˆ‘ä»¬ä¿®æ”¹äº†`angular.js`æ–‡ä»¶ä»¥åŒ…å«å®šåˆ¶æ„å»ºå™¨:

# IPFS æ–‡ä»¶ä¸Šä¼ æœåŠ¡

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæœåŠ¡`IpfsDaemonService`ï¼Œå®ƒå°†å¤„ç†ä» IPFS Infura ç½‘ç»œä¸Šä¼ å’Œæ£€ç´¢æ–‡ä»¶çš„é€»è¾‘:

åœ¨æœåŠ¡æ„é€ å‡½æ•°ä¸­ï¼Œæ³¨å…¥å®ä¾‹åŒ–å…¨å±€å¯¹è±¡`IpfsHttpClient`çš„`ipfsToken`ï¼Œè¯¥å…¨å±€å¯¹è±¡è´Ÿè´£è¿æ¥åˆ° Infura è¿è¡Œçš„ IPFS èŠ‚ç‚¹:

åœ¨æœåŠ¡çš„ç¬¬ä¸€ä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å‘ IPFS æ·»åŠ ä¸€ä¸ªå›¾åƒæ–‡ä»¶ã€‚å®ƒæ¥å—æ–‡ä»¶å¯¹è±¡åŠå…¶åç§°ï¼Œå¹¶åœ¨æˆåŠŸæ‰§è¡Œåè¿”å›å­˜å‚¨æ–‡ä»¶çš„æ•£åˆ—ã€‚ç¬¬äºŒç§æ–¹æ³•æ˜¯ä» IPFS è¯»å–å›¾åƒæ–‡ä»¶ã€‚å®ƒæ¥å—æ•£åˆ—å‚æ•°å¹¶è¿”å›å›¾åƒ blob å¯¹è±¡ã€‚

æˆ‘ä»¬å°†åŸå§‹ç¼“å†²æµç¼–ç ä¸º base64 ç¼–ç çš„å­—ç¬¦ä¸²ã€‚ç„¶åæˆ‘ä»¬é€šè¿‡ä½¿ç”¨`HttpClient`å’Œè®¾ç½®ä¸ºâ€œblobâ€çš„`responseType`é€‰é¡¹æ¥ç­‰å¾…å›¾åƒ blob è¢«è¿”å›ã€‚å¸ƒè±æ©Â·æ´›å¤«çš„è¿™ä¸ª[æƒ³æ³•](https://brianflove.com/2017/11/02/angular-http-client-blob/)å€¼å¾—ç§°èµã€‚

# æ’­ç§åŠŸèƒ½æ¨¡å—

IPFS æ–‡ä»¶ä¸Šä¼ é€»è¾‘è´Ÿè´£å­˜å‚¨å’Œæ£€ç´¢å–æ–¹çš„äº§å“å›¾åƒã€‚å›¾åƒæ–‡ä»¶çš„æ•£åˆ—ç å­˜å‚¨åœ¨`SafeRemotePurchase` æ™ºèƒ½å¥‘çº¦çš„`ipfsHash`çŠ¶æ€å˜é‡ä¸­ã€‚å°†è¯¥åŠŸèƒ½æ†ç»‘åˆ°åŠŸèƒ½æ¨¡å—`SellerBoothModule.`ä¸­æ˜¯å¾ˆè‡ªç„¶çš„

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ–°çš„`import()`è¯­æ³•æ¥å£°æ˜æƒ°æ€§åŠ è½½è·¯å¾„ã€‚è¿™ä¸ªåŠŸèƒ½æ˜¯ Angular v8 ä¸­å¼•å…¥çš„ã€‚

ç°åœ¨è®©æˆ‘ä»¬æŠŠæ³¨æ„åŠ›è½¬å‘åœ¨ç‰¹å¾æ¨¡å—`SellerBoothModule`ä¸­æ³¨å†Œçš„ç»„ä»¶`PurchaseContractComponent`:

è¿™æ˜¯ä¸€ä¸ªæ™ºèƒ½ç»„ä»¶ï¼Œé™¤äº†å…¶ä»–åŠŸèƒ½ä¹‹å¤–ï¼Œå®ƒè¿˜ä¸ºä»¥ä¸‹å„é¡¹æä¾›ç”¨æˆ·ç•Œé¢:

*   å›¾åƒé¢„è§ˆ
*   ä¸Šä¼ å›¾åƒåˆ° IPFS
*   åŸºäºæ•£åˆ—ç ä» IPFS æ£€ç´¢å›¾åƒæ–‡ä»¶

è®©æˆ‘ä»¬è¿›ä¸€æ­¥çœ‹çœ‹å…¶ä¸­çš„æ¯ä¸€é¡¹ã€‚

# å›¾åƒé¢„è§ˆ

è¯¥ç»„ä»¶çš„æ¨¡æ¿åŒ…æ‹¬æŒ‰é’®â€œ*é€‰æ‹©äº§å“å›¾ç‰‡*â€ï¼Œè®©æˆ‘ä»¬åœ¨ä¸Šä¼ åˆ° IPFS ä¹‹å‰é¢„è§ˆå›¾ç‰‡ã€‚ä¸ºäº†è¿æ¥é¢„è§ˆé€»è¾‘ï¼Œæˆ‘ä»¬ä½¿ç”¨è§’åº¦ææ–™ååº”ä¸Šä¼ è¡¨å•ã€‚å›¾åƒæ–‡ä»¶å­˜å‚¨åœ¨ç»„ä»¶å˜é‡`fileBlob`ä¸­ã€‚

![](img/f0e973f1dbe0fdcae81b16e22554b98a.png)

# å°†å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° IPFS

ç”±æˆ‘ä»¬çš„ç‰¹å¾åº“ç®¡ç†çš„çŠ¶æ€æ¥å£å®šä¹‰å¦‚ä¸‹:

```
export interface State {
   status: FileUploadStatus;
   ipfsHash: string | null;
   imageBlob?: Blob;
}
```

è¦å¯åŠ¨ä¸Šä¼ è¿‡ç¨‹ï¼Œç”¨æˆ·éœ€è¦ç‚¹å‡»æ ‡è®°ä¸º*â€œä¸Šä¼ åˆ° IPFSâ€*çš„æŒ‰é’®ï¼Œåœ¨æˆ‘ä»¬é€‰æ‹©å›¾åƒæ–‡ä»¶åï¼Œå“ªä¸ªä¼šå˜ä¸ºæ´»åŠ¨çŠ¶æ€ã€‚è¿™è§¦å‘äº†å­˜å‚¨åŠ¨ä½œç±»å‹`[IPFS/Image] Upload`ï¼Œè¯¥ç±»å‹åœ¨å…¶æœ‰æ•ˆè´Ÿè½½ä¸­æºå¸¦å˜é‡`fileBlob`çš„å€¼ã€‚è¯¥åŠ¨ä½œå°†è¢«åˆ†æ´¾åˆ°ä¸“ç”¨å•†åº—æ•ˆæœ`uploadFile$`ï¼Œè¯¥å•†åº—æ•ˆæœåªç›‘å¬è¿™ç§ç±»å‹çš„åŠ¨ä½œ:

è®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹è¿™ä¸ªæ•ˆæœé‡Œé¢çš„é€»è¾‘ã€‚æˆ‘ä»¬ä½¿ç”¨`exhaustMap` æ“ä½œç¬¦ä»åŠ¨ä½œè´Ÿè½½ä¸­æ¥æ”¶`File`å¯¹è±¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨è¿™ä¸ªæ˜ å°„æ“ä½œç¬¦çš„ä¼˜ç‚¹æ˜¯ï¼Œå®ƒå°†å¿½ç•¥åç»­çš„æ–‡ä»¶ä¸Šè½½è¯·æ±‚ï¼Œè€Œå½“å‰çš„è¯·æ±‚ä»åœ¨è¿›è¡Œä¸­ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†è¯¥å€¼ä¼ é€’ç»™`IpfsDaemonService.`ä¸­çš„`addFile`æ–¹æ³•ã€‚åœ¨æˆåŠŸæ‰§è¡Œè¯¥æ–¹æ³•åï¼Œæˆ‘ä»¬ä½¿ç”¨`map` æ“ä½œç¬¦å°†æ¥æ”¶åˆ°çš„å“ˆå¸Œå€¼æŠ•å°„åˆ°`[IPFS/Image] Upload Success`åŠ¨ä½œã€‚è¯¥æ“ä½œå°†è§¦å‘ç”±æˆ‘ä»¬çš„åŠŸèƒ½å­˜å‚¨ç®¡ç†çš„ä»¥ä¸‹äº‹ä»¶é“¾:

1.  æºå¸¦ IPFS æ˜ åƒæ•£åˆ—æœ‰æ•ˆè½½è·çš„åŠ¨ä½œè¢«åˆ†æ´¾ç»™ç›¸åº”çš„ç¼©å‡å™¨
2.  å‡é€Ÿå™¨å°†ç”¨æ–°å€¼æ›´æ–°çŠ¶æ€å±æ€§`ipfsHash`å’Œ`status`
3.  è§‚å¯Ÿè¿™äº›çŠ¶æ€å˜åŒ–çš„å­˜å‚¨é€‰æ‹©å™¨å°†è®¾æ³•ç›¸åº”åœ°æ›´æ–°ç»„ä»¶æ¨¡æ¿

![](img/b88974f67167e76afb7a8c7f7b8977b7.png)

# ä» IPFS æ£€ç´¢å›¾åƒ

ä¸€æ—¦äº§å“å›¾ç‰‡ä¸Šä¼ åˆ° IPFS ç½‘ç»œä¸Šï¼Œæˆ‘ä»¬æƒ³ç¡®ä¿æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒçš„æ•£åˆ—æ¥æ£€ç´¢å®ƒã€‚

æˆ‘ä»¬çš„æ™ºèƒ½æ¨¡æ¿ç»„ä»¶ä¸­æœ‰ä¸€ä¸ªæŒ‰é’®ï¼Œå½“`ipfsHash$`é€‰æ‹©å™¨å‘å‡ºä¸€ä¸ªå“ˆå¸Œå€¼æ—¶ï¼Œè¯¥æŒ‰é’®å˜å¾—å¯è§ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å½“æˆ‘ä»¬ç‚¹å‡»å®ƒæ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ:

![](img/7aac626fda1362ec523562ae788b7406.png)

ç‚¹å‡»æŒ‰é’®è§¦å‘ç»„ä»¶`ShowIpfsImageComponent`ä¸­å®šä¹‰çš„ææ–™å¯¹è¯æ¡†:

åœ¨ç»„ä»¶å†…éƒ¨ï¼Œæˆ‘ä»¬å£°æ˜äº†è¿”å› blob observable çš„æ–¹æ³•`checkStore`ã€‚è¯¥æ–¹æ³•æ£€æŸ¥çŠ¶æ€å±æ€§`imageBlog`çš„`getImageBlob`é€‰æ‹©å™¨ã€‚å¦‚æœè¯¥å€¼å°šæœªè®¾ç½®ï¼Œè¯¥æ–¹æ³•å°†åˆ†æ´¾`'[IPFS/Image] Load Image'`åŠ¨ä½œæ¥å°†è¯·æ±‚å¹¿æ’­åˆ°æ•ˆæœ`loadFile$`:

hash å±æ€§çš„å½“å‰å€¼ä»å­˜å‚¨ä¸­å–å‡ºï¼Œå¹¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™æœåŠ¡æ–¹æ³•`getFile`ã€‚è¯¥æ–¹æ³•ä½¿ç”¨ä» IPFS èŠ‚ç‚¹æ£€ç´¢çš„`image: Blob`å€¼è¿›è¡Œè§£æã€‚ç„¶åæˆ‘ä»¬å°†å®ƒé€å›å•†åº—ã€‚å‡é€Ÿå™¨ç›¸åº”åœ°æ›´æ–°çŠ¶æ€å±æ€§`imageBlob` ã€‚æ–°å€¼å°†ç«‹å³è¢«`getImageBlob` é€‰æ‹©å™¨æ‹¾å–ï¼Œå¹¶é¦–å…ˆä½¿ç”¨`checkStore`æ–¹æ³•ï¼Œç„¶åä½¿ç”¨`tap`æ“ä½œç¬¦é€šè¿‡ç®¡é“å‘ä¸‹ä¼ é€’:

```
this.image$ = this.checkStore().pipe(
   tap((blob) =>
this.image.nativeElement.src =          this.windowRef.URL.createObjectURL(blob)));
```

åœ¨æ“ä½œç¬¦`tap`ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¨¡æ¿å¼•ç”¨å˜é‡`#ipfsImage`å°†æ–‘ç‚¹å›¾åƒè¿æ¥åˆ°æ¨¡æ¿`<img>`æœ¬åœ°å…ƒç´ ä¸­ã€‚

è¿™ç§æ–¹æ³•çš„æœ€å¤§å¥½å¤„æ˜¯ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥æ§åˆ¶ä» IPFS èŠ‚ç‚¹æ¥æ”¶çš„å›¾åƒäºŒè¿›åˆ¶æµã€‚

# ç»“è®º

ğŸ¯è°¢è°¢å¤§å®¶ï¼è¯·ç»§ç»­å…³æ³¨æœ¬åšå®¢ç³»åˆ—çš„å…¶ä»–ä½œå“ã€‚

# å‚è€ƒ

*   [å»ºç­‘ä»¥å¤ªåŠ DApp ç”¨æœ‰è§’çš„ã€æœ‰è§’çš„ææ–™å’Œ NgRx](https://www.amazon.com/dp/B085B918LG) ï¼Œ*å¯ç”¨*[*http://www.amazon.co.uk/kindlestore*](http://www.amazon.co.uk/kindlestore)*2020 å¹´ 3 æœˆ 5 æ—¥*)ä½œè€… [Alex Yevseyevich](https://medium.com/u/4f27e57aa12a?source=post_page-----61aaaf0be0d5--------------------------------)

æˆ‘ç”¨äºå•†å“å›¾ç‰‡çš„é‚£å¥—å›¾æ ‡æ˜¯ç”±[www.flaticon.com](https://www.flaticon.com/)çš„[æ¡‰æ ‘](https://www.flaticon.com/authors/eucalyp)åˆ¶ä½œçš„ï¼Œç”±æˆæƒ [CC 3.0](http://creativecommons.org/licenses/by/3.0/)

ğŸ‘ç‰¹åˆ«æ„Ÿè°¢æˆ‘çš„å„¿å­ä¸¹å°¼å°”Â·å¶å¤«è°¢ç»´å¥‡å®¡é˜…äº†è¿™ç¯‡æ–‡ç« ã€‚